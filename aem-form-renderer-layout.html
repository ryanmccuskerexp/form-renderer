<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AEM Form Renderer – Form (v8) — Signals + Reusable Templates</title>
  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #ffffff; padding: 0; }

    :root {
      --exp-blue: rgb(53,99,161);
      --exp-teal: #0f6f94;
      --exp-raspberry: #d32a72;
      --exp-purple: rgb(118,18,123);
      --exp-beam-1: rgb(56,68,142);
      --exp-beam-2: rgb(150,32,135);
      --exp-dark-surface: #222b3c;
    }

    /* Simple site shell (Experian-like) behind the renderer */
    .site-shell { --shell-pad:48px; min-height:100vh; padding:0 var(--shell-pad); }
    .site-shell.theme-light { background:#ffffff; color:#111827; }
    .site-shell.theme-muted { background:linear-gradient(135deg, #f7f9fc 0%, #eef4ff 100%); }
    .site-shell.theme-muted .site-inline-wrap,
    .site-shell.theme-midnight { background:radial-gradient(circle at top, #1f2a44, #050810); color:#e5e7eb; }

    /* Site-level top nav + banner (outside the form renderer row) */
    .site-topbar {
      margin:0 calc(-1 * var(--shell-pad));
      padding:0 var(--shell-pad);
      background:rgb(248,249,248);
      border-bottom:1px solid #e5e7eb;
      color:#111827;
    }
    .sticky-top { position:sticky; top:0; z-index:40; }
    .site-topbar-inner { max-width:1200px; margin:0 auto; padding:12px 0; display:flex; align-items:center; justify-content:space-between; gap:18px; }
    .site-brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; min-width:0; }
    .site-logo { height:22px; width:auto; display:block; }
    .site-brand-text { font-size:14px; font-weight:600; letter-spacing:.01em; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .site-nav { display:flex; align-items:center; justify-content:space-between; gap:12px; flex:1 1 auto; min-width:0; }
    .site-nav-left,
    .site-nav-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .site-nav-left { justify-content:flex-start; }
    .site-nav-right { justify-content:flex-end; margin-left:auto; }
    .site-nav a { font-size:13px; font-weight:500; text-decoration:none; color:#374151; padding:6px 10px; border-radius:999px; }
    .site-nav a:hover,
    .site-nav a:focus-visible { background:rgba(15,111,148,0.10); color:var(--exp-teal); outline:none; }

    .site-cta-banner {
      margin:0 calc(-1 * var(--shell-pad));
      padding:0 var(--shell-pad);
      background:#ffffff;
      color:#111827;
      border-bottom:1px solid #e5e7eb;
    }
    .site-cta-banner.sticky-top { box-shadow:0 16px 34px rgba(15,23,42,0.16); }
    .site-cta-banner-inner {
      max-width:1200px;
      margin:0 auto;
      padding:12px 0;
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:16px;
    }
    .site-cta-banner-left { display:flex; align-items:center; gap:18px; min-width:0; justify-self:start; margin-left:0; }
    .site-cta-banner-copy { display:flex; align-items:center; gap:10px; min-width:0; }
    .site-cta-logo {
      width:clamp(140px, 18vw, 180px);
      height:auto;
      aspect-ratio:194 / 62;
      display:block;
    }
    .site-cta-banner-copy strong { display:block; font-size:13px; letter-spacing:.01em; }
    .site-cta-help { margin:2px 0 0; font-size:12px; opacity:0.9; }

    .site-local-nav { display:flex; align-items:center; justify-content:flex-start; gap:10px; flex-wrap:wrap; justify-self:start; align-self:end; margin-top:0; transform:translateY(-10px); }
    .site-local-nav a,
    .site-client-signin {
      font-size:15px;
      font-weight:400;
      font-family:inherit;
      line-height:1;
      text-decoration:none;
      color:#374151;
      padding:8px 12px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:transparent;
      border:none;
      appearance:none;
      -webkit-appearance:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .site-local-nav a:hover,
    .site-local-nav a:focus-visible,
    .site-client-signin:hover,
    .site-client-signin:focus-visible { background:rgba(53,99,161,0.10); color:var(--exp-teal); outline:none; }

    .site-local-nav a::after {
      content:'\00A0\203A';
      font-size:0.9em;
      opacity:0.9;
      transform:translateY(1px);
      display:inline-block;
    }

    .site-banner-actions { justify-self:end; display:flex; align-items:flex-end; gap:10px; align-self:end; margin-top:0; transform:translateY(-10px); }
    .site-client-signin.cta-disabled { opacity:0.55; cursor:not-allowed; }
    .site-client-signin.cta-disabled:hover,
    .site-client-signin.cta-disabled:focus-visible { background:transparent; color:#374151; }
    .site-search-btn {
      border:none;
      background:transparent;
      color:var(--exp-blue);
      padding:7px;
      border-radius:15px;
      appearance:none;
      -webkit-appearance:none;
      cursor:pointer;
      line-height:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .site-search-btn:hover,
    .site-search-btn:focus-visible { background:rgba(53,99,161,0.10); color:var(--exp-blue); outline:none; }
    .site-search-icon { width:20px; height:20px; display:block; }

    /* Marquee (outside the form renderer row) */
    .site-marquee {
      margin:0 calc(-1 * var(--shell-pad));
      padding:0 var(--shell-pad);
      background:linear-gradient(110deg, var(--exp-beam-1), var(--exp-beam-2));
      color:#ffffff;
      overflow:hidden;
    }
    .site-marquee-inner {
      max-width:1200px;
      margin:0 auto;
      padding:34px 0;
      min-height:400px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      position:relative;
    }
    .site-marquee-inner::after {
      content:"";
      position:absolute;
      inset:-30px -70px -30px 0;
      background-image:url('assets/experian-marquee.png');
      background-repeat:no-repeat;
      background-size:contain;
      background-position:right center;
      opacity:0.95;
      pointer-events:none;
      z-index:0;
    }
    .site-marquee-copy { position:relative; z-index:1; max-width:520px; }
    .site-marquee-copy h1 { margin:0 0 10px; font-size:40px; font-weight:500; line-height:1.05; letter-spacing:-.03em; }
    .site-marquee-copy p { margin:0; font-size:16px; opacity:0.92; max-width:48ch; }

    .btn-exp-contact {
      position:relative;
      overflow:hidden;
      background:linear-gradient(180deg, rgb(123,19,124), rgb(190,24,138));
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:400;
      font-size:15px;
      letter-spacing:.02em;
      box-shadow:0 8px 18px rgba(15,23,42,0.18);
      transition:background 180ms ease, box-shadow 180ms ease, transform 120ms ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:140px;
      height:55px;
      padding:0;
      text-decoration:none;
    }
    .btn-exp-contact::after {
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(120deg, rgba(255,255,255,0.45), rgba(255,255,255,0));
      transform:translateX(-110%);
      transition:transform 260ms ease, opacity 260ms ease;
      opacity:0;
    }
    .btn-exp-contact:hover::after,
    .btn-exp-contact:focus-visible::after { transform:translateX(0); opacity:1; }
    .btn-exp-contact:hover { background:#ed4c90; box-shadow:0 16px 34px rgba(227,53,130,0.5), 0 0 18px rgba(227,53,130,0.35); }
    .btn-exp-contact:focus-visible { outline:2px solid #f472b6; outline-offset:3px; box-shadow:0 0 0 3px rgba(244,114,182,0.35), 0 16px 34px rgba(227,53,130,0.5), 0 0 18px rgba(227,53,130,0.35); }

    .site-marquee-cta { margin-top:16px; }

    @media (max-width: 900px) {
      .site-marquee-inner { padding:26px 0; min-height:340px; }
      .site-marquee-inner::after { inset:-10px -140px -10px -40px; opacity:0.7; background-position:center right; }
      .site-marquee-copy h1 { font-size:34px; }
    }
    @media (max-width: 640px) {
      .site-cta-banner-inner { grid-template-columns:1fr; justify-items:center; gap:10px; }
      .site-cta-banner-left { gap:12px; justify-self:center; margin-left:0; }
      .site-banner-actions { justify-self:center; }
      .site-local-nav { margin-top:0; transform:none; align-self:stretch; }
      .site-banner-actions { margin-top:0; transform:none; align-self:stretch; }
      .site-local-nav a,
      .site-client-signin { padding:6px 10px; }
      .site-marquee-inner { min-height:300px; }
      .site-marquee-inner::after { inset:-20px -180px -20px -120px; opacity:0.55; }
      .site-marquee-copy h1 { font-size:30px; }
      .site-marquee-copy p { font-size:14px; }
    }

    .sr-only {
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0, 0, 0, 0);
      white-space:nowrap;
      border:0;
    }

    .skip-link.sr-only:focus,
    .skip-link.sr-only:focus-visible {
      width:auto;
      height:auto;
      margin:0;
      clip:auto;
      overflow:visible;
      white-space:normal;
      left:12px;
      top:10px;
      padding:8px 12px;
      border-radius:999px;
      background:#ffffff;
      color:#111827;
      box-shadow:0 12px 24px rgba(15,23,42,0.18);
      z-index:999;
      outline:2px solid rgba(255,255,255,0.75);
      outline-offset:2px;
    }

    .site-shell.theme-midnight .site-topbar { background:rgba(4,7,15,0.85); border-color:rgba(255,255,255,0.08); }
    .site-shell.theme-midnight .site-brand-text,
    .site-shell.theme-midnight .site-nav a { color:rgba(255,255,255,0.88); }
    .site-shell.theme-midnight .site-nav a:hover,
    .site-shell.theme-midnight .site-nav a:focus-visible { background:rgba(255,255,255,0.10); color:#ffffff; }

    .site-shell.theme-midnight .site-cta-banner { background:rgba(4,7,15,0.55); border-bottom-color:rgba(255,255,255,0.08); color:rgba(255,255,255,0.92); }
        /* Design themes are scoped to the module row (site-hero), not the whole page. */
        .site-hero { display:flex; flex-direction:column; gap:28px; align-items:stretch; justify-content:flex-start; position:relative; max-width:1200px; margin:28px auto 36px; padding:32px; }
        .site-hero.layout-full-width { align-items:center; }

        .site-hero,
        .preview-box,
        .site-inline-wrap,
        .published-form-wrap {
          --ui-text: #111827;
          --ui-muted: #4b5563;
          --ui-border: #e5e7eb;
          --ui-panel-bg: #ffffff;
          --ui-panel-shadow: 0 25px 45px rgba(15,23,42,0.18);
          --ui-panel-shadow-strong: 0 25px 55px rgba(15,23,42,0.22);
          --ui-panel-shadow-soft: 0 16px 34px rgba(15,23,42,0.12);
            --ui-display-title: #1c4f91;
          --ui-focus: var(--exp-teal);
          --ui-primary: var(--exp-blue);
          --ui-accent: var(--exp-raspberry);
        }
        .site-hero.theme-dark,
        .preview-box.theme-dark,
        .site-inline-wrap.theme-dark,
        .published-form-wrap.theme-dark {
          --ui-text: #ffffff;
          --ui-muted: rgba(255,255,255,0.72);
          --ui-border: rgba(255,255,255,0.18);
          --ui-panel-bg: rgb(28,79,145);
          --ui-input-bg: rgba(255,255,255,0.10);
          --ui-input-border: rgba(255,255,255,0.26);
          --ui-primary: rgba(255,255,255,0.92);
          --ui-focus: rgba(255,255,255,0.92);
          --ui-display-title: #ffffff;
        }

        /* Dark theme + split layouts: left column sits on a light page background, so use light text colors there. */
        .site-hero.theme-dark.form-display-left .site-hero-content {
          --ui-text: #111827;
          --ui-muted: #4b5563;
          --ui-display-title: #1c4f91;
          --ui-primary: var(--exp-blue);
          --ui-focus: var(--exp-teal);
        }
        .site-hero.theme-blue,
        .preview-box.theme-blue,
        .site-inline-wrap.theme-blue,
        .published-form-wrap.theme-blue {
          --ui-accent: var(--exp-blue);
          --ui-primary: var(--exp-blue);
          --ui-focus: var(--exp-blue);
        }
        .site-hero.theme-teal,
        .preview-box.theme-teal,
        .site-inline-wrap.theme-teal,
        .published-form-wrap.theme-teal {
          --ui-accent: var(--exp-teal);
          --ui-primary: var(--exp-teal);
          --ui-focus: var(--exp-teal);
        }
        .site-hero.theme-raspberry,
        .preview-box.theme-raspberry,
        .site-inline-wrap.theme-raspberry,
        .published-form-wrap.theme-raspberry {
          --ui-accent: var(--exp-raspberry);
          --ui-primary: var(--exp-raspberry);
          --ui-focus: var(--exp-raspberry);
        }
        .site-hero.theme-purple,
        .preview-box.theme-purple,
        .site-inline-wrap.theme-purple,
        .published-form-wrap.theme-purple {
          --ui-accent: var(--exp-purple);
          --ui-primary: var(--exp-purple);
          --ui-focus: var(--exp-purple);
        }
    .site-hero.layout-full-width .site-hero-content { width:100%; max-width:650px; }
    .site-hero.layout-horizontal-25-75,
    .site-hero.layout-horizontal-50-50 { flex-direction:row; }
    .site-hero.layout-horizontal-25-75 .site-hero-content { flex:0 0 32%; min-width:240px; }
    .site-hero.layout-horizontal-50-50 .site-hero-content { flex:0 0 45%; min-width:280px; }
    .site-hero.layout-horizontal-25-75 .site-form-panel { flex:1 1 auto; min-width:0; }

    .site-hero.layout-horizontal-50-50 .site-form-panel { flex:1 1 0; min-width:0; }
    .site-form-panel { position:relative; border:1px solid var(--ui-border); background:var(--ui-panel-bg); border-radius:28px; padding:24px; min-width:320px; max-width:540px; flex:1 1 auto; box-shadow:var(--ui-panel-shadow); display:flex; flex-direction:column; gap:20px; overflow:hidden; }
    .site-form-panel > * { position:relative; z-index:1; }
    .site-form-panel[hidden] { display:none; }
    .site-form-panel-inner { display:flex; gap:28px; flex-wrap:wrap; align-items:flex-start; }
    .site-form-copy { flex:1 1 42%; min-width:220px; }
    .site-form-display-placeholder { font-size:12px; color:#94a3b8; }
    .site-form-fields { flex:1 1 50%; min-width:240px; display:flex; flex-direction:column; gap:12px; }
    .site-form-field { height:44px; border-radius:12px; background:linear-gradient(90deg, #f3f4f6, #fff); border:1px solid var(--ui-border); box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); }
    .site-form-field.short { width:70%; }
    .site-form-checkbox { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--ui-muted); }
    .site-form-checkbox span.box { width:16px; height:16px; border-radius:4px; border:1px solid #d1d5db; background:#fff; }
    .site-form-submit { border:none; border-radius:999px; padding:12px 14px; font-weight:600; font-size:13px; background:#d32a72; color:#fff; box-shadow:0 15px 35px rgba(211,42,114,0.4); }
    .site-form-trust { font-size:11px; color:#6b7280; }
    .site-form-social { display:flex; align-items:center; gap:10px; font-size:11px; color:#9ca3af; }
    .site-form-social .dots { display:flex; gap:6px; }
    .site-form-social .dot { width:18px; height:18px; border-radius:4px; background:#d1d5db; }
    .site-form-fields.inline-mounted > .site-form-field,
    .site-form-fields.inline-mounted > .site-form-checkbox,
    .site-form-fields.inline-mounted > .site-form-submit,
    .site-form-fields.inline-mounted > .site-form-trust,
    .site-form-fields.inline-mounted > .site-form-social { display:none; }
    .site-form-panel::before { content:""; position:absolute; inset:14px; border-radius:22px; background:transparent; opacity:0; transition:opacity 220ms ease; pointer-events:none; }
    .site-form-panel.form-panel-bg-default::before { opacity:0; }
    .site-form-panel.form-panel-bg-gradient::before { opacity:0; }
    .site-form-panel.form-panel-bg-trapezoid-bottom::before { opacity:0; }
    .site-form-panel.form-panel-bg-trapezoid-top::before { opacity:0; }
    .site-form-panel .form-display-block { border:none; padding:0; margin:0; background:transparent; }
    .site-form-panel .form-display-title { font-size:32px; color:var(--ui-display-title); }
    .site-form-panel .form-display-description { font-size:13px; color:var(--ui-muted); }
    .site-form-panel .form-display-telephone { font-size:13px; }
     /* When the live inline renderer is mounted into the hero form panel, the Form Display block
       is rendered by #site-form-display to control layout (horizontal vs full-width). */
     .site-form-panel .form-preview .form-display-block { display:none; }

    .site-form-panel.layout-full-width { width:100%; max-width:650px; margin:0 auto; }
     .site-form-panel.layout-full-width .site-form-panel-inner { flex-direction:column; gap:18px; }
     .site-form-panel.layout-full-width .site-form-copy { flex:0 0 auto; min-width:0; }
     .site-form-panel.layout-full-width #site-form-display { max-width:520px; margin:0 auto; text-align:center; }
     .site-form-panel.layout-full-width .site-form-fields { width:100%; }
     .site-form-panel.layout-full-width .site-inline-wrap { width:100%; }
    @media (max-width:900px) {
      .site-form-panel-inner { flex-direction:column; }
      .site-form-copy, .site-form-fields { flex:1 1 100%; }
    }
    .site-hero.hero-bg-default { background:transparent; }
    .site-hero.hero-bg-default::before,
    .site-hero.hero-bg-default::after { content:none; }
    .site-hero.hero-bg-gradient { background:linear-gradient(135deg, #eef2ff 0%, #fdf2f8 45%, #fff 100%); border-radius:28px; box-shadow:0 25px 55px rgba(15,23,42,0.18); }
    .site-hero.hero-bg-gradient::before { content:""; position:absolute; inset:12px; border-radius:24px; background:radial-gradient(circle at 20% 20%, rgba(255,255,255,0.85), rgba(255,255,255,0)); z-index:0; pointer-events:none; }
    .site-hero.hero-bg-gradient h1,
    .site-hero.hero-bg-gradient p { color:#0f172a; }
    .site-hero.hero-bg-trapezoid-bottom,
    .site-hero.hero-bg-trapezoid-top {
      border-radius:28px;
      box-shadow:none;
    }

    /* Trapezoid accents: shorter “beam” with rounded corners */
    .site-hero.hero-bg-trapezoid-bottom { overflow:visible; }
    .site-hero.hero-bg-trapezoid-bottom::after {
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:-52px;
      height:150px;
      background:linear-gradient(110deg, var(--exp-beam-1), var(--exp-beam-2));
      /* Keep the low side height; make the high side ~2.5x taller */
      clip-path:polygon(0 45%, 100% 14%, 100% 100%, 0% 100%);
      border-radius:28px;
      z-index:0;
      pointer-events:none;
    }

    .site-hero.hero-bg-trapezoid-top { overflow:hidden; }
    .site-hero.hero-bg-trapezoid-top::before {
      content:"";
      position:absolute;
      left:0;
      right:0;
      top:0;
      height:150px;
      background:linear-gradient(110deg, var(--exp-beam-1), var(--exp-beam-2));
      clip-path:polygon(0 0, 100% 0, 100% 72%, 0% 46%);
      border-radius:28px;
      z-index:0;
      pointer-events:none;
    }
    .site-hero h1 { margin:0 0 10px; font-size:34px; line-height:1.15; color:var(--ui-text); letter-spacing:-.02em; }
    .site-hero p { margin:0; color:var(--ui-muted); font-size:14px; max-width:540px; }
    .site-hero-content .form-display-block { display:none; }
    /* Horizontal layouts: left column uses Form Display copy (outside the form container). */
    .site-hero.form-display-left .site-hero-content .form-display-block { display:block; border:none; padding:0; margin:0; background:transparent; }
    .site-hero.form-display-left .site-hero-content .form-display-subtitle { margin-bottom:6px; }
    .site-hero.form-display-left .site-hero-content .form-display-title { font-size:32px; line-height:1.15; letter-spacing:-.02em; margin:0 0 8px; color:var(--ui-display-title); }

    /* Design: background & container (visual-only) */
    .site-form-panel { box-shadow:var(--ui-container-shadow, var(--ui-panel-shadow)), var(--ui-emphasis-shadow, none); }
    .preview-box,
    .site-inline-wrap,
    .published-form-wrap { --ui-container-shadow:none; box-shadow:var(--ui-container-shadow, none), var(--ui-emphasis-shadow, none); }

    .site-hero.container-flat .site-form-panel,
    .preview-box.container-flat,
    .site-inline-wrap.container-flat,
    .published-form-wrap.container-flat {
      --ui-container-shadow:none;
    }
    .site-hero.container-flat .site-form-panel { background:transparent; border-color:transparent; }
    .preview-box.container-flat,
    .site-inline-wrap.container-flat,
    .published-form-wrap.container-flat { background:transparent; border-color:transparent; }

    .site-hero.container-elevated .site-form-panel,
    .preview-box.container-elevated,
    .site-inline-wrap.container-elevated,
    .published-form-wrap.container-elevated {
      --ui-container-shadow:var(--ui-panel-shadow-strong);
      background:var(--ui-panel-bg);
      border-color:var(--ui-border);
    }

    .site-hero.container-outline .site-form-panel,
    .preview-box.container-outline,
    .site-inline-wrap.container-outline,
    .published-form-wrap.container-outline {
      --ui-container-shadow:none;
      background:transparent;
      border:2px solid var(--ui-border);
    }

    /* Design: emphasis (visual-only) */
    .site-hero.emphasis-neutral .site-form-panel,
    .preview-box.emphasis-neutral,
    .site-inline-wrap.emphasis-neutral,
    .published-form-wrap.emphasis-neutral { --ui-emphasis-shadow:var(--ui-panel-shadow); }
    .site-hero.emphasis-primary .site-form-panel,
    .preview-box.emphasis-primary,
    .site-inline-wrap.emphasis-primary,
    .published-form-wrap.emphasis-primary { --ui-emphasis-shadow:var(--ui-panel-shadow-strong); }
    .site-hero.emphasis-subtle .site-form-panel,
    .preview-box.emphasis-subtle,
    .site-inline-wrap.emphasis-subtle,
    .published-form-wrap.emphasis-subtle { --ui-emphasis-shadow:var(--ui-panel-shadow-soft); }

    /* Design: typography (visual-only) */
    .site-hero.type-compact h1 { font-size:30px; }
    .site-hero.type-spacious h1 { font-size:38px; }
    .site-hero.heading-bold h1,
    .site-form-panel.heading-bold .form-display-title,
    .preview-box.heading-bold .form-display-title,
    .site-inline-wrap.heading-bold .form-display-title,
    .published-form-wrap.heading-bold .form-display-title { font-weight:700; }
    .site-hero.heading-regular h1,
    .site-form-panel.heading-regular .form-display-title,
    .preview-box.heading-regular .form-display-title,
    .site-inline-wrap.heading-regular .form-display-title,
    .published-form-wrap.heading-regular .form-display-title { font-weight:400; }

    /* Design: motion (visual-only) */
    .site-hero.motion-none .site-form-panel *,
    .site-hero.motion-none .btn-exp-submit,
    .site-hero.motion-none .btn-secondary,
    .preview-box.motion-none *,
    .preview-box.motion-none .btn-exp-submit,
    .preview-box.motion-none .btn-secondary,
    .site-inline-wrap.motion-none *,
    .site-inline-wrap.motion-none .btn-exp-submit,
    .site-inline-wrap.motion-none .btn-secondary,
    .published-form-wrap.motion-none *,
    .published-form-wrap.motion-none .btn-exp-submit,
    .published-form-wrap.motion-none .btn-secondary { transition:none !important; }
    .site-hero.form-display-left .site-hero-content .form-display-description { font-size:16px; color:var(--ui-muted); margin:0 0 6px; }
    .site-hero.form-display-left .site-hero-content .form-display-subtext { font-size:13px; color:var(--ui-muted); }
    .site-hero.form-display-left .site-hero-content .form-display-telephone { font-size:14px; color:var(--ui-primary); font-weight:700; }
    .site-hero-actions { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
    .site-cta-help { font-size:12px; }
    .site-inline-slot { max-width:1100px; margin:0 auto 40px; padding:0 0 24px; }
    .site-inline-slot h2 { margin:0 0 12px; font-size:18px; color:#111827; }
    .site-inline-wrap { border:1px solid #e5e7eb; background:#f9fafb; border-radius:12px; padding:16px; position:relative; overflow:hidden; }
    .site-inline-wrap > * { position:relative; z-index:1; }
    .site-inline-placeholder { border:1px dashed #d1d5db; padding:14px; border-radius:10px; font-size:12px; color:#6b7280; background:#fdfefe; }
    .site-inline-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .site-inline-label { font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:#4b5563; }
    .site-inline-wrap .btn { margin-top:8px; }
    /* When the inline form is mounted into the hero form panel, strip chrome */
    .site-form-panel .site-inline-wrap { border:none; background:transparent; padding:0; box-shadow:none; }
    .site-form-panel .site-inline-head { display:none; }
    .site-form-panel .form-preview { margin:0; }
    .site-form-panel .wizard-nav { margin-bottom:8px; }

    /* Renderer overlay that can be closed/published */
    .renderer-overlay { position:fixed; inset:0; background:rgba(15,15,30,0.55); display:flex; align-items:center; justify-content:center; padding:18px; overflow:auto; z-index:50; }
    .renderer-overlay[aria-hidden="true"] { display:none; }

    .renderer-banner {
      display:none;
      padding:10px 12px;
      border-bottom:1px solid #f3e4b4;
      background:#fef3c7;
      color:#92400e;
      font-size:12px;
    }
    .renderer-banner-inner { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .renderer-banner-message { line-height:1.35; }
    .renderer-banner-close { border:none; background:none; cursor:pointer; font-size:16px; line-height:1; color:#92400e; opacity:0.75; }
    .renderer-banner-close:hover { opacity:1; }

    /* Published form modal (opened by CTA) */
    .published-form-modal { position:fixed; inset:0; background:rgba(15,15,30,0.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:60; }
    .published-form-modal.open { display:flex; }
    .published-form-modal-content { width:520px; max-width:92vw; max-height:86vh; overflow:auto; background:#fff; border-radius:10px; box-shadow:0 20px 45px rgba(0,0,0,0.25); padding:18px 18px 16px; }
    .published-form-modal-head { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .published-form-modal-head h3 { margin:0; font-size:16px; color:#111827; }
    .published-form-modal-close { border:none; background:none; font-size:20px; cursor:pointer; line-height:1; color:#555; }
    .published-form-wrap { border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; padding:12px; position:relative; overflow:hidden; }
    .published-form-wrap > * { position:relative; z-index:1; }
    /* Force a 590px dialog for the constrained embed environment */
            .dialog { max-width: 590px; width:100%; margin: 0 auto; background: #ffffff; border-radius: 8px;
              box-shadow: 0 8px 24px rgba(0,0,0,0.12); display:flex; flex-direction:column; overflow:hidden; max-height:86vh; }
    .dialog-header { padding: 8px 12px; background:#222b3c; color:#fff; display:flex; justify-content:space-between; align-items:center; }
    .dialog-header-title { display:flex; align-items:center; gap:8px; }
    .dialog-header-title span.icon { width:20px; height:20px; border-radius:3px; background:rgba(255,255,255,0.18);
                                     display:inline-flex; align-items:center; justify-content:center; font-size:11px; }
    .dialog-header h2 { margin:0; font-size:16px; font-weight:600; }
    .dialog-header-actions button { background:none; border:none; color:#fff; cursor:pointer; margin-left:8px; opacity:.75; font-size:14px; }
    .dialog-header-actions button:hover { opacity:1; }
    .dialog-tabs { display:flex; border-bottom:1px solid #e0e0e0; background:#fafafa; }
    .dialog-tab { padding:9px 14px; font-size:13px; cursor:pointer; border-bottom:2px solid transparent; color:#555; }
    .dialog-tab.active { border-bottom-color:#0f6f94; background:#fff; color:#222; font-weight:600; }
    .dialog-body { padding:10px 12px 12px; flex:1 1 auto; overflow:hidden; min-height:0; max-height:500px; display:flex; flex-direction:column; justify-content:flex-start; }
    .tab-panel { display:none; width:100%; }
    .tab-panel.active { display:block; width:100%; flex:1 1 auto; align-self:stretch; min-height:0; overflow-y:auto; }
    .top-row { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:12px; gap:12px; flex-wrap:wrap; }
    .template-group { display:flex; flex-direction:column; font-size:12px; gap:4px; }
    .template-group label { font-weight:600; color:#333; }
    .template-group select { padding:4px 6px; font-size:12px; border-radius:4px; border:1px solid #ccc; width:260px; }
    .layout-density-group { display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap; font-size:12px; }
    .mini-group { display:flex; flex-direction:column; gap:4px; }
    .mini-group label { font-weight:600; color:#333; }
    .mini-group select { padding:3px 6px; border-radius:4px; border:1px solid #ccc; font-size:12px; }
    /* layout-grid is a simple vertical stack: Form fields, Properties, Live preview */
    .layout-grid { display:block; }
    .panel { border:1px solid #e1e1e1; border-radius:6px; padding:10px; background:#fafafa; margin-bottom:10px; }
    .panel h3 { margin:0 0 8px; font-size:13px; text-transform:uppercase; letter-spacing:.05em; color:#555; }
    .form-display-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:10px; }
    .form-display-grid label { font-size:11px; font-weight:600; color:#374151; display:flex; flex-direction:column; gap:4px; text-transform:uppercase; letter-spacing:.05em; }
    .form-display-grid input,
    .form-display-grid textarea,
    .form-display-grid select { font-size:12px; padding:6px 8px; border-radius:5px; border:1px solid #d1d5db; background:#fff; }
    .form-display-grid textarea { min-height:70px; }
    .form-display-panel-note { font-size:11px; color:#6b7280; margin-top:8px; }

    .form-layout-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin-top:10px; }
    .form-layout-field { display:flex; flex-direction:column; gap:4px; }
    .form-layout-field label { font-size:11px; font-weight:600; color:#374151; text-transform:uppercase; letter-spacing:.05em; }
    .form-layout-field select { font-size:12px; padding:6px 8px; border-radius:5px; border:1px solid #d1d5db; background:#fff; }
    .form-layout-help { font-size:11px; color:#6b7280; }
    .form-display-block { border:1px dashed #d1d5db; border-radius:10px; padding:12px; margin-bottom:10px; background:#fff; width:100%; flex:0 0 100%; }
    .form-preview.display-horizontal { display:block; margin:0; }
    .form-preview.display-horizontal .form-display-block { margin-bottom:0; }
    .form-display-flex { display:flex; gap:18px; align-items:stretch; flex-wrap:wrap; width:100%; }
    .form-display-flex .form-fields-flex { flex:1 1 0; display:flex; flex-wrap:wrap; margin:-4px; }
    .form-preview.display-horizontal .form-fields-flex .preview-field { padding:4px; }
    .form-display-flex.layout-horizontal-25-75 .form-display-block { flex:0 0 32%; min-width:240px; width:auto; }
    .form-display-flex.layout-horizontal-25-75 .form-fields-flex { flex:1 1 68%; }
    .form-display-flex.layout-horizontal-50-50 .form-display-block { flex:0 0 45%; min-width:260px; width:auto; }
    .form-display-flex.layout-horizontal-50-50 .form-fields-flex { flex:1 1 55%; }
    @media (max-width: 700px) {
      .site-shell { --shell-pad:20px; }
    }

    @media (max-width: 600px) {
      .form-preview.display-horizontal .form-display-flex { flex-direction:column; }
      .form-display-flex.layout-horizontal-25-75 .form-display-block,
      .form-display-flex.layout-horizontal-50-50 .form-display-block { flex:0 0 100%; min-width:0; }
    }
    .design-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    .design-grid label { font-size:11px; font-weight:600; color:#374151; display:flex; flex-direction:column; gap:4px; text-transform:uppercase; letter-spacing:.05em; }
    .design-grid select { font-size:12px; padding:6px 8px; border-radius:5px; border:1px solid #d1d5db; background:#fff; }
    .design-panel-note { font-size:11px; color:#6b7280; margin-top:8px; }
    .design-panel-body { margin-top:8px; overflow:hidden; max-height:2000px; opacity:1; transition:max-height 220ms ease, opacity 200ms ease, margin-top 200ms ease; }
    .design-panel-body.collapsed { max-height:0; opacity:0; margin-top:0; pointer-events:none; }

    /* Design: buttons (scope to rendered forms only) */
    .site-form-panel.btn-style-outline .btn-exp-submit,
    .preview-box.btn-style-outline .btn-exp-submit,
    .site-inline-wrap.btn-style-outline .btn-exp-submit,
    .published-form-wrap.btn-style-outline .btn-exp-submit,
    .site-form-panel .form-preview.btn-style-outline .btn-exp-submit,
    .preview-box .form-preview.btn-style-outline .btn-exp-submit,
    .site-inline-wrap .form-preview.btn-style-outline .btn-exp-submit,
    .published-form-wrap .form-preview.btn-style-outline .btn-exp-submit {
      background:transparent !important;
      color:var(--ui-primary) !important;
      border:2px solid var(--ui-primary) !important;
      box-shadow:none !important;
      filter:none !important;
    }
    .site-form-panel.btn-style-outline .btn-exp-submit:hover,
    .preview-box.btn-style-outline .btn-exp-submit:hover,
    .site-inline-wrap.btn-style-outline .btn-exp-submit:hover,
    .published-form-wrap.btn-style-outline .btn-exp-submit:hover,
    .site-form-panel .form-preview.btn-style-outline .btn-exp-submit:hover,
    .preview-box .form-preview.btn-style-outline .btn-exp-submit:hover,
    .site-inline-wrap .form-preview.btn-style-outline .btn-exp-submit:hover,
    .published-form-wrap .form-preview.btn-style-outline .btn-exp-submit:hover {
      background:color-mix(in srgb, var(--ui-panel-bg) 92%, var(--ui-primary) 8%) !important;
      box-shadow:none !important;
      filter:none !important;
    }
    .site-form-panel.btn-style-outline .btn-exp-submit::after,
    .preview-box.btn-style-outline .btn-exp-submit::after,
    .site-inline-wrap.btn-style-outline .btn-exp-submit::after,
    .published-form-wrap.btn-style-outline .btn-exp-submit::after,
    .site-form-panel .form-preview.btn-style-outline .btn-exp-submit::after,
    .preview-box .form-preview.btn-style-outline .btn-exp-submit::after,
    .site-inline-wrap .form-preview.btn-style-outline .btn-exp-submit::after,
    .published-form-wrap .form-preview.btn-style-outline .btn-exp-submit::after { content:none !important; }
    .site-form-panel.btn-style-minimal .btn-exp-submit,
    .preview-box.btn-style-minimal .btn-exp-submit,
    .site-inline-wrap.btn-style-minimal .btn-exp-submit,
    .published-form-wrap.btn-style-minimal .btn-exp-submit,
    .site-form-panel .form-preview.btn-style-minimal .btn-exp-submit,
    .preview-box .form-preview.btn-style-minimal .btn-exp-submit,
    .site-inline-wrap .form-preview.btn-style-minimal .btn-exp-submit,
    .published-form-wrap .form-preview.btn-style-minimal .btn-exp-submit {
      background:transparent !important;
      color:var(--ui-primary) !important;
      border:none !important;
      box-shadow:none !important;
      filter:none !important;
      text-decoration:none;
    }
    .site-form-panel.btn-style-minimal .btn-exp-submit:hover,
    .preview-box.btn-style-minimal .btn-exp-submit:hover,
    .site-inline-wrap.btn-style-minimal .btn-exp-submit:hover,
    .published-form-wrap.btn-style-minimal .btn-exp-submit:hover,
    .site-form-panel .form-preview.btn-style-minimal .btn-exp-submit:hover,
    .preview-box .form-preview.btn-style-minimal .btn-exp-submit:hover,
    .site-inline-wrap .form-preview.btn-style-minimal .btn-exp-submit:hover,
    .published-form-wrap .form-preview.btn-style-minimal .btn-exp-submit:hover { text-decoration:underline; background:transparent !important; box-shadow:none !important; }
    .site-form-panel.btn-style-minimal .btn-exp-submit::after,
    .preview-box.btn-style-minimal .btn-exp-submit::after,
    .site-inline-wrap.btn-style-minimal .btn-exp-submit::after,
    .published-form-wrap.btn-style-minimal .btn-exp-submit::after,
    .site-form-panel .form-preview.btn-style-minimal .btn-exp-submit::after,
    .preview-box .form-preview.btn-style-minimal .btn-exp-submit::after,
    .site-inline-wrap .form-preview.btn-style-minimal .btn-exp-submit::after,
    .published-form-wrap .form-preview.btn-style-minimal .btn-exp-submit::after { content:none !important; }
    .site-form-panel.btn-style-outline .btn-secondary,
    .site-form-panel.btn-style-minimal .btn-secondary,
    .preview-box.btn-style-outline .btn-secondary,
    .preview-box.btn-style-minimal .btn-secondary,
    .site-inline-wrap.btn-style-outline .btn-secondary,
    .site-inline-wrap.btn-style-minimal .btn-secondary,
    .published-form-wrap.btn-style-outline .btn-secondary,
    .published-form-wrap.btn-style-minimal .btn-secondary,
    .site-form-panel .form-preview.btn-style-outline .btn-secondary,
    .site-form-panel .form-preview.btn-style-minimal .btn-secondary,
    .preview-box .form-preview.btn-style-outline .btn-secondary,
    .preview-box .form-preview.btn-style-minimal .btn-secondary,
    .site-inline-wrap .form-preview.btn-style-outline .btn-secondary,
    .site-inline-wrap .form-preview.btn-style-minimal .btn-secondary,
    .published-form-wrap .form-preview.btn-style-outline .btn-secondary,
    .published-form-wrap .form-preview.btn-style-minimal .btn-secondary {
      background:transparent !important;
      border:1px solid var(--ui-border) !important;
      color:var(--ui-text) !important;
    }
    .site-form-panel.btn-style-minimal .btn-secondary,
    .preview-box.btn-style-minimal .btn-secondary,
    .site-inline-wrap.btn-style-minimal .btn-secondary,
    .published-form-wrap.btn-style-minimal .btn-secondary,
    .site-form-panel .form-preview.btn-style-minimal .btn-secondary,
    .preview-box .form-preview.btn-style-minimal .btn-secondary,
    .site-inline-wrap .form-preview.btn-style-minimal .btn-secondary,
    .published-form-wrap .form-preview.btn-style-minimal .btn-secondary { border:none; }

    .site-form-panel.btn-shape-rounded .btn,
    .preview-box.btn-shape-rounded .btn,
    .site-inline-wrap.btn-shape-rounded .btn,
    .published-form-wrap.btn-shape-rounded .btn,
    .site-form-panel .form-preview.btn-shape-rounded .btn,
    .site-form-panel .form-preview.btn-shape-rounded .btn-exp-submit,
    .preview-box .form-preview.btn-shape-rounded .btn,
    .preview-box .form-preview.btn-shape-rounded .btn-exp-submit,
    .site-inline-wrap .form-preview.btn-shape-rounded .btn,
    .site-inline-wrap .form-preview.btn-shape-rounded .btn-exp-submit,
    .published-form-wrap .form-preview.btn-shape-rounded .btn,
    .published-form-wrap .form-preview.btn-shape-rounded .btn-exp-submit { border-radius:16px !important; }
    .site-form-panel.btn-shape-pill .btn,
    .preview-box.btn-shape-pill .btn,
    .site-inline-wrap.btn-shape-pill .btn,
    .published-form-wrap.btn-shape-pill .btn,
    .site-form-panel .form-preview.btn-shape-pill .btn,
    .site-form-panel .form-preview.btn-shape-pill .btn-exp-submit,
    .preview-box .form-preview.btn-shape-pill .btn,
    .preview-box .form-preview.btn-shape-pill .btn-exp-submit,
    .site-inline-wrap .form-preview.btn-shape-pill .btn,
    .site-inline-wrap .form-preview.btn-shape-pill .btn-exp-submit,
    .published-form-wrap .form-preview.btn-shape-pill .btn,
    .published-form-wrap .form-preview.btn-shape-pill .btn-exp-submit { border-radius:999px !important; }
    .site-form-panel.btn-shape-soft .btn,
    .preview-box.btn-shape-soft .btn,
    .site-inline-wrap.btn-shape-soft .btn,
    .published-form-wrap.btn-shape-soft .btn,
    .site-form-panel .form-preview.btn-shape-soft .btn,
    .site-form-panel .form-preview.btn-shape-soft .btn-exp-submit,
    .preview-box .form-preview.btn-shape-soft .btn,
    .preview-box .form-preview.btn-shape-soft .btn-exp-submit,
    .site-inline-wrap .form-preview.btn-shape-soft .btn,
    .site-inline-wrap .form-preview.btn-shape-soft .btn-exp-submit,
    .published-form-wrap .form-preview.btn-shape-soft .btn,
    .published-form-wrap .form-preview.btn-shape-soft .btn-exp-submit { border-radius:6px !important; }

    .preview-box.btn-width-wide .btn-exp-submit,
    .site-inline-wrap.btn-width-wide .btn-exp-submit,
    .published-form-wrap.btn-width-wide .btn-exp-submit { min-width:240px !important; }

    .preview-box.btn-width-full .btn-exp-submit,
    .site-inline-wrap.btn-width-full .btn-exp-submit,
    .published-form-wrap.btn-width-full .btn-exp-submit {
      width:100% !important;
      min-width:0 !important;
      display:block;
    }
    .preview-box.btn-width-full .wizard-footer,
    .site-inline-wrap.btn-width-full .wizard-footer,
    .published-form-wrap.btn-width-full .wizard-footer {
      flex-direction:column;
      align-items:stretch;
    }

    /* Design: inputs (scope to rendered forms only) */
    .site-form-panel .form-preview.input-outlined input,
    .site-form-panel .form-preview.input-outlined select,
    .site-form-panel .form-preview.input-outlined textarea,
    .preview-box .form-preview.input-outlined input,
    .preview-box .form-preview.input-outlined select,
    .preview-box .form-preview.input-outlined textarea,
    .site-inline-wrap .form-preview.input-outlined input,
    .site-inline-wrap .form-preview.input-outlined select,
    .site-inline-wrap .form-preview.input-outlined textarea,
    .published-form-wrap .form-preview.input-outlined input,
    .published-form-wrap .form-preview.input-outlined select,
      .published-form-wrap .form-preview.input-outlined textarea {
        background:var(--ui-input-bg, var(--ui-panel-bg));
        border:1px solid var(--ui-input-border, var(--ui-border));
        color:var(--ui-text);
      }
    .site-form-panel .form-preview.input-filled input,
    .site-form-panel .form-preview.input-filled select,
    .site-form-panel .form-preview.input-filled textarea,
    .preview-box .form-preview.input-filled input,
    .preview-box .form-preview.input-filled select,
    .preview-box .form-preview.input-filled textarea,
    .site-inline-wrap .form-preview.input-filled input,
    .site-inline-wrap .form-preview.input-filled select,
    .site-inline-wrap .form-preview.input-filled textarea,
    .published-form-wrap .form-preview.input-filled input,
    .published-form-wrap .form-preview.input-filled select,
    .published-form-wrap .form-preview.input-filled textarea {
      background:color-mix(in srgb, var(--ui-input-bg, var(--ui-panel-bg)) 85%, var(--ui-border) 15%);
      border:1px solid var(--ui-input-border, var(--ui-border));
      color:var(--ui-text);
    }
    .site-form-panel .form-preview.input-radius-standard input,
    .site-form-panel .form-preview.input-radius-standard select,
    .site-form-panel .form-preview.input-radius-standard textarea,
    .preview-box .form-preview.input-radius-standard input,
    .preview-box .form-preview.input-radius-standard select,
    .preview-box .form-preview.input-radius-standard textarea,
    .site-inline-wrap .form-preview.input-radius-standard input,
    .site-inline-wrap .form-preview.input-radius-standard select,
    .site-inline-wrap .form-preview.input-radius-standard textarea,
    .published-form-wrap .form-preview.input-radius-standard input,
    .published-form-wrap .form-preview.input-radius-standard select,
    .published-form-wrap .form-preview.input-radius-standard textarea { border-radius:6px; }
    .site-form-panel .form-preview.input-radius-soft input,
    .site-form-panel .form-preview.input-radius-soft select,
    .site-form-panel .form-preview.input-radius-soft textarea,
    .preview-box .form-preview.input-radius-soft input,
    .preview-box .form-preview.input-radius-soft select,
    .preview-box .form-preview.input-radius-soft textarea,
    .site-inline-wrap .form-preview.input-radius-soft input,
    .site-inline-wrap .form-preview.input-radius-soft select,
    .site-inline-wrap .form-preview.input-radius-soft textarea,
    .published-form-wrap .form-preview.input-radius-soft input,
    .published-form-wrap .form-preview.input-radius-soft select,
    .published-form-wrap .form-preview.input-radius-soft textarea { border-radius:12px; }
    .site-form-panel .form-preview input:focus,
    .site-form-panel .form-preview select:focus,
    .site-form-panel .form-preview textarea:focus,
    .preview-box .form-preview input:focus,
    .preview-box .form-preview select:focus,
    .preview-box .form-preview textarea:focus,
    .site-inline-wrap .form-preview input:focus,
    .site-inline-wrap .form-preview select:focus,
    .site-inline-wrap .form-preview textarea:focus,
    .published-form-wrap .form-preview input:focus,
    .published-form-wrap .form-preview select:focus,
    .published-form-wrap .form-preview textarea:focus {
      outline:2px solid var(--ui-focus);
      outline-offset:2px;
    }

    /* Design: typography (scope to rendered forms only) */
    .site-form-panel .form-preview.type-compact,
    .preview-box .form-preview.type-compact,
    .site-inline-wrap .form-preview.type-compact,
    .published-form-wrap .form-preview.type-compact { font-size:12px; }
    .site-form-panel .form-preview.type-spacious,
    .preview-box .form-preview.type-spacious,
    .site-inline-wrap .form-preview.type-spacious,
    .published-form-wrap .form-preview.type-spacious { font-size:14px; }
    .form-display-block.align-center { text-align:center; }
    .form-display-block.align-right { text-align:right; }
    .form-display-subtitle { font-size:11px; font-weight:600; letter-spacing:.15em; color:var(--ui-accent); text-transform:uppercase; margin-bottom:6px; }
    .form-display-title { font-size:18px; margin:0 0 6px; color:var(--ui-display-title); }
    .form-display-description { font-size:13px; color:var(--ui-muted); margin:0 0 8px; }
    .form-display-subtext { font-size:11px; color:var(--ui-muted); margin:0 0 6px; }
    .form-display-telephone { font-size:12px; color:var(--ui-primary); font-weight:600; margin:0; }
    .field-row { padding:8px; margin-bottom:6px; border-radius:6px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; }
    .field-row.selected { box-shadow:0 0 0 2px rgba(15,111,148,0.12); border-color:#0f6f94; }
    .field-row.drag-over { border-style:dashed; border-color:#0f6f94; background:#f3f9fc; }
    .field-row-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
    .field-row-handle { font-size:11px; color:#999; cursor:grab; user-select:none; margin-right:6px; }
    .field-row-main { display:flex; align-items:center; justify-content:space-between; font-size:12px; }
    .field-row-main-left { display:flex; align-items:center; gap:6px; min-width:0; }
    .field-row-label { font-weight:400; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .field-row small { display:block; font-size:11px; color:#666; margin-bottom:4px; }
    .field-row input[type=text] { width:100%; padding:4px 6px; font-size:12px; margin-bottom:4px;
                                  border-radius:4px; border:1px solid #ccc; }
    .field-row textarea { width:100%; padding:4px 6px; font-size:12px; margin-bottom:4px;
                          border-radius:4px; border:1px solid #ccc; resize:vertical; }
    .field-row select { width:100%; padding:3px 6px; font-size:12px; margin-bottom:4px;
                        border-radius:4px; border:1px solid #ccc; }
    .field-row .row-line { display:flex; gap:6px; align-items:center; font-size:11px; flex-wrap:wrap; }
    .field-row .row-line label { font-weight:400; }
    .field-row .row-line .spacer { flex:1 1 auto; }
    .field-row .kind-label { font-size:10px; color:#999; }
    .field-row-meta { display:flex; align-items:center; gap:6px; }
    .field-row-delete { border:none; background:transparent; color:#c62828; font-size:12px; cursor:pointer; padding:2px 6px; border-radius:4px; }
    .field-row-delete:hover { background:#fdecea; color:#b71c1c; }
    .field-row-delete:focus { outline:2px solid #f5c2c7; outline-offset:1px; }
    .field-condition-indicator { display:none; padding:1px 6px; border-radius:999px; background:#fef3c7; color:#92400e; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; }
    .field-condition-indicator.active { display:inline-flex; }
    .preview-condition-indicator { display:inline-flex; margin-left:6px; padding:1px 6px; border-radius:999px; background:#fef3c7; color:#92400e; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; vertical-align:middle; }
    .field-required-hidden-warning { display:none; align-items:flex-start; gap:6px; margin-top:6px; font-size:11px; color:#b91c1c; }
    .field-required-hidden-warning .field-required-hidden-icon { line-height:1; margin-top:1px; }
    .field-row.required-hidden .field-required-hidden-warning { display:flex; }
    .field-row .meta-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px; margin-top:4px; }
    .options-wrapper { margin-top:6px; border-top:1px dashed #e2e2e2; padding-top:4px; }
    .options-header { display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:2px; }
    .options-list { margin:0; padding:0; list-style:none; }
    .option-row { display:flex; align-items:center; gap:4px; margin-bottom:3px; }
    .option-row span.handle { font-size:11px; color:#aaa; }
    .option-row input[type=text] { flex:1 1 auto; padding:3px 4px; font-size:11px; margin-bottom:0; }
    .option-row button { border:none; background:none; cursor:pointer; font-size:11px; color:#777; }
    .options-add { font-size:11px; color:#0f6f94; cursor:pointer; margin-top:2px; }
    .options-helper { font-size:10px; color:#999; margin-top:2px; }
    .button-row { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
    .preview-box { position:relative; background:#f9fafb; border-radius:12px; border:1px dashed #d0d7e2; padding:12px; overflow:hidden; }
    .preview-box::before { content:none; }
    .preview-box > * { position:relative; z-index:1; }
    .preview-box.design-bg-default,
    .site-inline-wrap.design-bg-default,
    .published-form-wrap.design-bg-default { background:var(--ui-panel-bg); }

    .preview-box.design-bg-gradient,
    .site-inline-wrap.design-bg-gradient,
    .published-form-wrap.design-bg-gradient {
      position:relative;
      overflow:hidden;
      background:linear-gradient(135deg, rgba(238,242,255,1) 0%, rgba(253,242,248,1) 45%, rgba(255,255,255,1) 100%);
      border-color:rgba(15,23,42,0.08);
    }
    .preview-box.design-bg-gradient::before,
    .site-inline-wrap.design-bg-gradient::before,
    .published-form-wrap.design-bg-gradient::before {
      content:"";
      position:absolute;
      inset:12px;
      border-radius:18px;
      background:radial-gradient(circle at 20% 20%, rgba(255,255,255,0.85), rgba(255,255,255,0));
      z-index:0;
      pointer-events:none;
    }

    .preview-box.design-bg-trapezoid-bottom,
    .site-inline-wrap.design-bg-trapezoid-bottom,
    .published-form-wrap.design-bg-trapezoid-bottom {
      position:relative;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(249,250,251,1) 100%);
      border-color:rgba(15,23,42,0.08);
    }
    .preview-box.design-bg-trapezoid-bottom::before,
    .site-inline-wrap.design-bg-trapezoid-bottom::before,
    .published-form-wrap.design-bg-trapezoid-bottom::before {
      content:"";
      position:absolute;
      left:0; right:0; bottom:-40px;
      height:160px;
      background:linear-gradient(135deg, rgba(15,111,148,0.18), rgba(192,22,139,0.16));
      clip-path:polygon(0 40%, 100% 12%, 100% 100%, 0 100%);
      z-index:0;
      pointer-events:none;
    }

    .preview-box.design-bg-trapezoid-bottom::after,
    .site-inline-wrap.design-bg-trapezoid-bottom::after,
    .published-form-wrap.design-bg-trapezoid-bottom::after,
    .preview-box.design-bg-trapezoid-top::after,
    .site-inline-wrap.design-bg-trapezoid-top::after,
    .published-form-wrap.design-bg-trapezoid-top::after {
      content:"";
      position:absolute;
      inset:12px;
      border-radius:18px;
      background:var(--ui-panel-bg);
      z-index:0;
      pointer-events:none;
    }

    .preview-box.design-bg-trapezoid-top,
    .site-inline-wrap.design-bg-trapezoid-top,
    .published-form-wrap.design-bg-trapezoid-top {
      position:relative;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(249,250,251,1) 0%, rgba(255,255,255,1) 100%);
      border-color:rgba(15,23,42,0.08);
    }
    .preview-box.design-bg-trapezoid-top::before,
    .site-inline-wrap.design-bg-trapezoid-top::before,
    .published-form-wrap.design-bg-trapezoid-top::before {
      content:"";
      position:absolute;
      left:0; right:0; top:-46px;
      height:160px;
      background:linear-gradient(135deg, rgba(15,111,148,0.18), rgba(192,22,139,0.16));
      clip-path:polygon(0 0, 100% 0, 100% 62%, 0% 36%);
      z-index:0;
      pointer-events:none;
    }

    /* Keep background framing behind the card, not behind field gaps. */
    .preview-box.design-bg-gradient .form-preview,
    .preview-box.design-bg-trapezoid-bottom .form-preview,
    .preview-box.design-bg-trapezoid-top .form-preview,
    .site-inline-wrap.design-bg-gradient .form-preview,
    .site-inline-wrap.design-bg-trapezoid-bottom .form-preview,
    .site-inline-wrap.design-bg-trapezoid-top .form-preview,
    .published-form-wrap.design-bg-gradient .form-preview,
    .published-form-wrap.design-bg-trapezoid-bottom .form-preview,
    .published-form-wrap.design-bg-trapezoid-top .form-preview {
      background:var(--ui-panel-bg);
      border-radius:12px;
      margin:0;
    }
    .preview-header { font-size:11px; color:#555; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; }
    .preview-header span.layout-tag { padding:1px 6px; border-radius:999px; background:rgba(15,111,148,0.10); color:var(--ui-primary);
                                      font-size:10px; text-transform:uppercase; letter-spacing:.08em; }
    /* Wizard stepper (multi-step) */
    .wizard-nav { display:none; margin:10px 0 14px; gap:18px; align-items:flex-start; }
    .wizard-nav .wizard-step { flex:1 1 0; background:none; border:none; padding:0; text-align:left; cursor:pointer; }
    .wizard-nav .wizard-step:disabled { cursor:default; opacity:0.9; }
    .wizard-nav .wizard-step-bar { height:3px; border-radius:999px; background:#e5e7eb; margin-bottom:10px; }
    .wizard-nav .wizard-step.complete .wizard-step-bar,
    .wizard-nav .wizard-step.active .wizard-step-bar { background:var(--ui-primary); }
    .wizard-nav .wizard-step-kicker { font-size:11px; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:#6b7280; }
    .wizard-nav .wizard-step-title { font-size:14px; font-weight:600; color:#111827; margin-top:2px; }
    .wizard-nav .wizard-step.active .wizard-step-kicker { color:var(--ui-primary); }

    .wizard-footer { display:none; justify-content:space-between; gap:12px; margin-top:8px; }
    .wizard-footer .btn { margin-top:0; }
    .wizard-footer .btn-secondary { background:#fff; border:1px solid #d1d5db; }
    .wizard-footer .btn-secondary:disabled { opacity:0.55; cursor:not-allowed; }
    .form-preview { display:flex; flex-wrap:wrap; margin:-4px; }
    .form-preview.layout-card { background:#edf2f7; border-radius:12px; padding:16px; border:1px solid #d7e1ef; flex-direction:column; gap:12px; }
    .form-preview.layout-card .preview-field { flex:0 0 100%; margin-bottom:0; }
    .card-field .preview-field-inner { background:var(--ui-panel-bg); border-radius:12px; border:1px solid var(--ui-border); padding:16px; box-shadow:0 12px 30px rgba(15,23,42,0.08); }
    .card-field .preview-field-inner label { font-size:13px; font-weight:600; color:var(--ui-text); }
    .preview-field { padding:4px; }
    .preview-field.full { flex:0 0 100%; }
    .preview-field.half { flex:0 0 50%; }
    .preview-field-inner { display:flex; flex-direction:column; }
    .preview-field-inner label { font-size:12px; margin-bottom:2px; color:var(--ui-text); }
    .preview-field-inner input,
    .preview-field-inner select,
    .preview-field-inner textarea { font-size:12px; padding:6px 8px; border-radius:4px; border:1px solid var(--ui-input-border, var(--ui-border)); background:var(--ui-input-bg, var(--ui-panel-bg)); color:var(--ui-text); }
    .preview-checkbox-label { display:flex; align-items:flex-start; gap:8px; font-size:12px; margin-bottom:2px; }
    .preview-checkbox-label .preview-checkbox-text { line-height:1.35; }
    .preview-field-inner input[type=checkbox] { width:16px; height:16px; padding:0; border-radius:3px; border:1px solid var(--ui-border); background:var(--ui-panel-bg); margin-top:2px; }
    .preview-field-inner input[type=radio] {
      padding:0;
      border:none;
      width:auto;
      height:auto;
    }
    .preview-field-inner small { font-size:10px; color:var(--ui-muted); margin-top:2px; }

    .preview-box.theme-dark .form-preview input::placeholder,
    .preview-box.theme-dark .form-preview textarea::placeholder,
    .site-inline-wrap.theme-dark .form-preview input::placeholder,
    .site-inline-wrap.theme-dark .form-preview textarea::placeholder,
    .published-form-wrap.theme-dark .form-preview input::placeholder,
    .published-form-wrap.theme-dark .form-preview textarea::placeholder { color:rgba(255,255,255,0.65); }

    .site-hero.theme-dark .btn-exp-submit,
    .preview-box.theme-dark .btn-exp-submit,
    .site-inline-wrap.theme-dark .btn-exp-submit,
    .published-form-wrap.theme-dark .btn-exp-submit {
      background:rgba(255,255,255,0.92);
      color:#0f172a;
      box-shadow:0 14px 34px rgba(15,23,42,0.22);
    }

    /* Live validation indicator (modern checkmark centered within the field) */
    .preview-field-inner.is-valid input:not([type=checkbox]):not([type=radio]),
    .preview-field-inner.is-valid select,
    .preview-field-inner.is-valid textarea {
      padding-right:36px;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%2322c55e" fill-opacity="0.18"/><path d="M9.2 12.5l1.9 1.9 4.7-5" fill="none" stroke="%2322c55e" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/></svg>');
      background-repeat:no-repeat;
      background-position:right 10px center;
      background-size:18px 18px;
    }
    .conditional-placeholder { border:1px dashed #f59e0b; background:#fff7ed; color:#92400e; font-size:11px; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .conditional-placeholder .conditional-message { font-weight:600; }
    .conditional-placeholder .conditional-pill { padding:2px 8px; border-radius:999px; border:1px solid #f59e0b; text-transform:uppercase; font-size:10px; letter-spacing:.05em; }
    .preview-field .conditional-placeholder { display:none; }
    .preview-field.conditional-hidden .conditional-placeholder { display:flex; }
    .preview-field.conditional-hidden .preview-field-inner { display:none; }
    .preview-text { margin:0; }
    .preview-text.small { font-size:11px; color:var(--ui-muted); }
    .preview-text.body { font-size:12px; color:var(--ui-text); }
    .preview-text.heading { font-size:14px; font-weight:600; margin-bottom:2px; color:var(--ui-text); }
    .btn { border-radius:4px; padding:6px 14px; border:none; cursor:pointer; font-size:13px; font-weight:500; }
    .btn.btn-exp-contact { border-radius:10px; padding:0; font-size:15px; font-weight:400; line-height:1; }
    .btn-primary { background:var(--ui-primary); color:#fff; }
    .btn-secondary { background:#e5e7eb; color:#111827; }
    .btn-full { width:100%; margin-top:8px; }
    .helper { font-size:11px; color:var(--ui-muted); margin-top:4px; }
    .field-config-empty { font-size:12px; color:#777; padding:4px 0; }
      .btn-exp-raspberry { position:relative; overflow:hidden; background:#d32a72; color:#fff; border:none; border-radius:999px; font-weight:600; letter-spacing:.02em; box-shadow:0 8px 18px rgba(211,42,114,0.35); transition:background 180ms ease, box-shadow 180ms ease, transform 120ms ease; display:inline-flex; align-items:center; justify-content:center; padding:10px 26px; text-decoration:none; }
      .btn-exp-raspberry::after { content:''; position:absolute; inset:0; background:linear-gradient(120deg, rgba(255,255,255,0.45), rgba(255,255,255,0)); transform:translateX(-110%); transition:transform 260ms ease, opacity 260ms ease; opacity:0; }
      .btn-exp-raspberry:hover::after,
      .btn-exp-raspberry:focus-visible::after { transform:translateX(0); opacity:1; }
      .btn-exp-raspberry:hover { background:#ed4c90; box-shadow:0 16px 34px rgba(227,53,130,0.5), 0 0 18px rgba(227,53,130,0.35); }
      .btn-exp-raspberry:focus-visible { outline:2px solid #f472b6; outline-offset:3px; box-shadow:0 0 0 3px rgba(244,114,182,0.35), 0 16px 34px rgba(227,53,130,0.5), 0 0 18px rgba(227,53,130,0.35); }
      .btn-exp-raspberry.cta-disabled { background:#d32a72; color:#fff; opacity:0.85; box-shadow:0 6px 14px rgba(211,42,114,0.28); cursor:not-allowed; }
      .btn-exp-raspberry.cta-disabled::after { opacity:0; }
      .btn-exp-raspberry.cta-disabled:hover,
      .btn-exp-raspberry.cta-disabled:focus-visible { background:#ed4c90; box-shadow:0 12px 24px rgba(227,53,130,0.4); }
      .btn-exp-raspberry.cta-disabled:hover::after,
      .btn-exp-raspberry.cta-disabled:focus-visible::after { opacity:1; transform:translateX(0); }

      /* Form submit (match CTA feel, but blue + fixed size) */
      .btn-exp-submit { position:relative; overflow:hidden; background:var(--ui-primary); color:#fff; border:none; border-radius:999px;
        font-weight:600; letter-spacing:.02em; box-shadow:0 8px 18px rgba(15,23,42,0.18);
        transition:background 180ms ease, box-shadow 180ms ease, transform 120ms ease;
        display:inline-flex; align-items:center; justify-content:center;
        width:100px; height:50px; padding:0 18px; text-decoration:none; white-space:nowrap; }
      .btn-exp-submit::after { content:''; position:absolute; inset:0; background:linear-gradient(120deg, rgba(255,255,255,0.45), rgba(255,255,255,0)); transform:translateX(-110%); transition:transform 260ms ease, opacity 260ms ease; opacity:0; }
      .btn-exp-submit:hover::after,
      .btn-exp-submit:focus-visible::after { transform:translateX(0); opacity:1; }
      .btn-exp-submit:hover { filter:brightness(1.06); box-shadow:0 16px 34px rgba(15,23,42,0.22); }
      .btn-exp-submit:focus-visible { outline:2px solid var(--ui-focus); outline-offset:3px; box-shadow:0 0 0 3px rgba(15,23,42,0.14), 0 16px 34px rgba(15,23,42,0.22); }
      .site-hero.theme-dark .btn-exp-submit:hover,
      .preview-box.theme-dark .btn-exp-submit:hover,
      .site-inline-wrap.theme-dark .btn-exp-submit:hover,
      .published-form-wrap.theme-dark .btn-exp-submit:hover { filter:none; }
      .site-hero.theme-dark .btn-exp-submit:focus-visible,
      .preview-box.theme-dark .btn-exp-submit:focus-visible,
      .site-inline-wrap.theme-dark .btn-exp-submit:focus-visible,
      .published-form-wrap.theme-dark .btn-exp-submit:focus-visible { outline:2px solid rgba(255,255,255,0.92); }
      .mb-15 { margin-bottom:15px; }
    .density-compact .preview-field { margin-bottom:4px; }
    .density-standard .preview-field { margin-bottom:8px; }
    .density-roomy .preview-field { margin-bottom:14px; }
    /* properties form typography: match main form field text size */
    #properties-form label { display:block; font-size:12px; margin-top:6px; font-weight:400; color:#333; }
    .text-editor-header { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .text-editor-label { font-weight:600; font-size:12px; }
    .text-editor-meta { display:flex; align-items:center; gap:8px; font-size:12px; }
    .text-editor-toolbar { display:flex; gap:4px; margin-bottom:6px; }
    .text-editor-toolbar button { border:1px solid #d1d5db; background:#fff; border-radius:4px; padding:4px 10px; font-size:12px; cursor:pointer; }
    .text-editor-toolbar button:hover { border-color:#0f6f94; }
    .text-editor-content { min-height:140px; border:1px solid #d1d5db; border-radius:6px; padding:8px; background:#fff; font-size:14px; line-height:1.4; }
    .text-editor-content:focus { outline:2px solid #0f6f94; }
    .text-editor-controls { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; flex-wrap:wrap; }
    .align-controls-wrapper { display:flex; flex-direction:column; gap:4px; }
    .align-label { font-size:11px; color:#555; }
    .align-controls { display:flex; gap:4px; }
    .align-btn { border:1px solid #d1d5db; background:#fff; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px; }
    .align-btn.active { border-color:#0f6f94; color:#0f6f94; font-weight:600; }
    .text-editor-link-status { font-size:11px; color:#555; margin-top:4px; }
    .link-modal { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; padding:12px; z-index:10; }
    .link-modal-content { background:#fff; border-radius:8px; padding:16px 20px; width:320px; box-shadow:0 20px 40px rgba(0,0,0,0.15); }
    .link-modal-header { display:flex; justify-content:space-between; align-items:center; font-weight:600; margin-bottom:12px; }
    .link-modal-close { border:none; background:none; font-size:18px; cursor:pointer; }
    .link-modal-label { display:block; font-size:12px; margin-top:8px; }
    .link-modal-label input,
    .link-modal-label select { width:100%; margin-top:4px; border:1px solid #d1d5db; border-radius:4px; padding:6px 8px; font-size:12px; }
    .link-modal-buttons { display:flex; justify-content:flex-end; gap:8px; margin-top:16px; }
    .link-modal-buttons button { padding:6px 12px; border-radius:4px; font-size:12px; }
    .text-editor-meta { display:flex; align-items:center; gap:8px; font-size:12px; margin-bottom:6px; }
    .text-editor-toolbar { display:flex; gap:4px; margin-bottom:6px; }
    .text-editor-toolbar button { border:1px solid #d1d5db; background:#fff; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer; }
    .text-editor-toolbar button:hover { border-color:#0f6f94; }
    .text-editor-content { min-height:120px; border:1px solid #d1d5db; border-radius:6px; padding:8px; background:#fff; font-size:14px; line-height:1.4; }
    .text-editor-content:focus { outline:2px solid #0f6f94; }
    .text-editor-controls { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .align-controls { display:flex; gap:4px; }
    .align-btn { border:1px solid #d1d5db; background:#fff; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px; }
    .align-btn.active { border-color:#0f6f94; color:#0f6f94; font-weight:600; }
    .text-editor-link { display:flex; gap:6px; flex:1; }
    .text-editor-link input { flex:1; border:1px solid #d1d5db; border-radius:4px; padding:4px 6px; font-size:12px; }
    .text-editor-link button { border:none; background:#0f6f94; color:#fff; border-radius:4px; padding:5px 10px; cursor:pointer; font-size:12px; }
    #properties-form input[type=text], #properties-form select, #properties-form textarea {
      width:100%; padding:4px; margin-top:3px; border-radius:4px; border:1px solid #ccc; font-size:12px;
    }
    #prop-html-readonly,
    #prop-type-readonly {
      background:#f4f5f7; color:#555; cursor:not-allowed; border:1px solid #cfd5e3;
    }
    #properties-form .small { font-size:10px; color:#666; margin-top:6px; }
    .condition-action-row { display:flex; align-items:center; gap:6px; margin-top:6px; }
    .condition-action-row select { border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; font-size:12px; }
    .condition-row { display:flex; align-items:center; gap:6px; margin-top:6px; flex-wrap:nowrap; min-width:0; width:100%; }
    .condition-row-content { display:flex; gap:6px; align-items:center; flex:1 1 auto; flex-wrap:nowrap; min-width:0; overflow:hidden; }
    #properties-form .condition-row-content select,
    #properties-form .condition-row-content input { border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; font-size:12px; flex:0 1 150px; min-width:110px; max-width:180px; width:auto; }
    .condition-row-content .condition-value { flex:1 1 120px; min-width:110px; max-width:180px; }
    .condition-row-content .condition-delete { flex:0 0 auto; }
    .condition-connector { margin-right:2px; flex:0 0 auto; }
    .condition-connector select { border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; font-size:12px; background:#fff; }
    #prop-conditions-section { margin-top:12px; }
    .condition-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .condition-toggle { border:1px solid #d1d5db; border-radius:999px; padding:4px 12px; background:#fff; font-size:12px; font-weight:600; cursor:pointer; color:#555; }
    .condition-toggle.on { background:#0f6f94; border-color:#0f6f94; color:#fff; }
    .condition-toggle:disabled { opacity:0.4; cursor:not-allowed; }
    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panel-header h3 { margin:0; }
    .panel-toggle { border:1px solid #d1d5db; border-radius:999px; padding:4px 12px; background:#fff; font-size:11px; font-weight:600; letter-spacing:.05em; text-transform:uppercase; cursor:pointer; color:#555; transition:border-color 120ms ease, color 120ms ease, background 120ms ease; }
    .panel-toggle:hover { border-color:#0f6f94; color:#0f6f94; }
    .panel-toggle:focus-visible { outline:2px solid #0f6f94; outline-offset:2px; }
    .tab-bulk-actions { display:flex; justify-content:flex-end; gap:8px; margin:0 0 10px; }
    .bulk-toggle-wrap { display:flex; align-items:flex-end; margin-left:auto; }
    .live-preview-body { margin-top:8px; overflow:hidden; max-height:2000px; opacity:1; transition:max-height 220ms ease, opacity 200ms ease, margin-top 200ms ease; }
    .live-preview-body.collapsed { max-height:0; opacity:0; margin-top:0; pointer-events:none; }
    .form-display-body { margin-top:8px; overflow:hidden; max-height:2000px; opacity:1; transition:max-height 220ms ease, opacity 200ms ease, margin-top 200ms ease; }
    .form-display-body.collapsed { max-height:0; opacity:0; margin-top:0; pointer-events:none; }
    .form-layout-body { margin-top:8px; overflow:hidden; max-height:2000px; opacity:1; transition:max-height 220ms ease, opacity 200ms ease, margin-top 200ms ease; }
    .form-layout-body.collapsed { max-height:0; opacity:0; margin-top:0; pointer-events:none; }
    .field-panel-body { margin-top:8px; overflow:hidden; max-height:2000px; opacity:1; transition:max-height 220ms ease, opacity 200ms ease, margin-top 200ms ease; }
    .field-panel-body.collapsed { max-height:0; opacity:0; margin-top:0; pointer-events:none; }
    /* inline properties form when moved under a field row */
    #properties-form.inline-properties { background:#fff; border:1px solid #e9ecef; padding:8px; border-radius:6px; margin-top:8px; }
    #properties-form.inline-properties .form-properties-title { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:#555; margin-bottom:6px; }
    /* collapse/expand behavior for the properties panel still present but less relevant when inline */
    .properties-panel { overflow:hidden; max-height:120px; transition:max-height 220ms ease, padding 220ms ease; }
    .properties-panel.expanded { max-height:1200px; }
    /* narrow mode for constrained container widths (e.g. 590px) */
    .layout-grid.narrow { display:block; }
    .layout-grid.narrow .panel { padding:8px; }
    .layout-grid.narrow .helper { display:none; }
    .layout-grid.narrow .preview-box { padding:8px; }
    .form-meta-panel { border:1px solid #e5e7eb; background:#f9fafb; border-radius:8px; padding:14px; margin:18px 0; }
    .form-meta-panel.future-state-panel { border-color:#c4b5fd; background:#f5f3ff; }
    .form-meta-panel-head { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .form-meta-panel-head h4 { margin:0; font-size:14px; }
    .form-meta-helper { font-size:11px; color:#666; margin:4px 0 0; }
    .future-state-pill { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:999px; font-size:10px; letter-spacing:.08em; text-transform:uppercase; background:#ddd6fe; color:#5b21b6; font-weight:700; }
    .future-state-helper { color:#5b21b6; }
    .form-meta-grid { display:flex; flex-direction:column; gap:16px; margin-top:12px; }
    .form-meta-field label { font-size:12px; font-weight:400; color:#333; }
    .required-indicator { color:#b91c1c; font-weight:600; margin-left:4px; }
    .form-meta-field { width:100%; }
    .form-meta-panel input[type=text],
    .form-meta-panel select { width:100%; padding:4px 6px; font-size:12px; border-radius:4px; border:1px solid #ccc; margin-top:4px; }
    .form-meta-panel input[readonly] { background:#f4f5f7; color:#555; border:1px solid #cfd5e3; }
    .form-meta-panel .small { font-size:11px; color:#666; margin-top:6px; }
    .form-meta-panel-body { margin-top:12px; overflow:hidden; max-height:2000px; opacity:1; transition:max-height 220ms ease, opacity 200ms ease, margin-top 200ms ease; }
    .form-meta-panel-body.collapsed { max-height:0; opacity:0; margin-top:0; pointer-events:none; }
    .meta-input-row { display:flex; gap:8px; margin-top:4px; }
    .meta-input-row input { flex:1; }
    .meta-input-row-error input { border-color:#dc2626; box-shadow:0 0 0 1px rgba(220,38,38,0.15); }
    .meta-chip-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; min-height:24px; }
    .meta-chip { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; font-size:11px; font-weight:500; padding:4px 10px; color:#1e1b4b; }
    .meta-chip-remove { border:none; background:none; cursor:pointer; font-size:12px; color:#4338ca; line-height:1; padding:0; }
    .meta-chip-remove:hover { color:#312e81; }
    .meta-error { font-size:11px; color:#b91c1c; }

    .hidden-metadata-inputs { display:none; }
    .hidden-meta-add { display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; margin-top:12px; }
    .hidden-meta-add .mini-group { min-width:160px; }
    .hidden-meta-add input[type=text],
    .hidden-meta-add select { width:220px; max-width:100%; }
    .hidden-meta-groups { margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .hidden-meta-group { border:1px dashed #d1d5db; border-radius:10px; padding:10px; background:#fff; }
    .hidden-meta-group-title { font-size:11px; font-weight:700; color:#374151; letter-spacing:.06em; text-transform:uppercase; margin-bottom:6px; }
    .hidden-meta-empty { font-size:11px; color:#6b7280; }
    .existing-field-modal { position:fixed; inset:0; background:rgba(15,15,30,0.55); display:flex; align-items:center; justify-content:center; padding:24px; z-index:90; }
    .existing-field-modal-content { width:520px; max-height:80vh; overflow:auto; background:#fff; border-radius:10px; box-shadow:0 20px 45px rgba(0,0,0,0.25); padding:20px 24px; display:flex; flex-direction:column; gap:16px; }
    .existing-field-modal-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .existing-field-modal-header span { font-size:16px; font-weight:600; color:#111; }
    .existing-field-modal-subtitle { margin:4px 0 0; font-size:12px; color:#555; }
    .existing-field-modal-close { border:none; background:none; font-size:20px; cursor:pointer; line-height:1; color:#555; }
    .existing-field-modal-body { display:flex; flex-direction:column; gap:18px; }
    .existing-field-group h5 { margin:0 0 6px; font-size:13px; color:#0f172a; }
    .existing-field-list { display:flex; flex-direction:column; gap:8px; }
    .existing-field-item { border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .existing-field-item.disabled { opacity:0.5; }
    .existing-field-item-details { display:flex; flex-direction:column; gap:2px; }
    .existing-field-item-title { font-size:13px; font-weight:600; color:#111; }
    .existing-field-item-meta { font-size:11px; color:#555; }
    .existing-field-item button { white-space:nowrap; }
     @media (max-width:1200px){ .layout-grid{ display:block; }}
   </style>
 </head>
 <body>
<div class="site-shell theme-light" id="site-shell">
  <div class="site-topbar local-header parbase aem-GridColumn aem-GridColumn--default--12 local-header-main scrolled-up">
    <div class="site-topbar-inner">
      <a class="skip-link sr-only" href="#main-content">Skip to main navigation</a>
      <div class="site-nav">
        <div class="site-nav-left" aria-label="Primary">
          <a href="#">Consumer</a>
          <a href="#">Small Business</a>
          <a href="#">Business</a>
        </div>
        <div class="site-nav-right" aria-label="Secondary">
          <a href="#">About Experian</a>
          <a href="#">Consumer Support</a>
          <a href="#">Credit Advice</a>
          <a href="#">Global Sites</a>
        </div>
      </div>
    </div>
  </div>

  <div class="site-cta-banner sticky-top" aria-live="polite">
    <div class="site-cta-banner-inner">
      <div class="site-cta-banner-left">
        <div class="site-cta-banner-copy">
          <img class="site-cta-logo" src="https://upload.wikimedia.org/wikipedia/commons/3/31/Experian_logo.svg" alt="Experian" />
          <strong class="sr-only">Need the form live?</strong>
          <p class="site-cta-help sr-only" id="site-cta-help">Publish the renderer with Capture pattern set to Modal/Drawer.</p>
        </div>
      </div>
      <nav class="site-local-nav" aria-label="Local navigation">
        <a href="#">Products and solutions</a>
        <a href="#">Industries</a>
        <a href="#">Resources</a>
      </nav>

      <div class="site-banner-actions" aria-label="Utilities">
            <button id="site-cta" type="button" class="site-client-signin">Client Sign In</button>
        <button type="button" class="site-search-btn" aria-label="Search">
          <svg class="site-search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M16.4 16.4 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <section class="site-marquee" aria-label="Marquee">
    <div class="site-marquee-inner">
      <div class="site-marquee-copy">
        <h1>Target prospects</h1>
        <p>Attract the right prospects with the right offer at the right time.</p>
        <a class="btn btn-exp-contact mb-15 site-marquee-cta" href="#" data-form-open="lead-form" data-form-open-mode="scroll" data-form-expand="true" data-form-focus="true" data-cta-id="marquee-contact">Contact us&nbsp;›</a>
      </div>
    </div>
  </section>

  <div id="main-content" tabindex="-1"></div>
  <div class="site-hero layout-full-width hero-bg-default" id="site-hero" data-form-renderer-id="lead-form" data-form-default-open-mode="scroll" data-form-initial-state="expanded">
    <div class="site-hero-content">
      <div id="site-hero-display"></div>
      <div class="site-hero-actions">
        <button type="button" class="btn btn-secondary" id="site-open-renderer">Open builder overlay</button>
        <button type="button" class="btn btn-secondary" id="site-open-cta-renderer">CTA Renderer</button>
      </div>
    </div>
    <div class="site-form-panel form-panel-bg-default" id="site-form-panel" hidden>
      <div class="site-form-panel-inner">
        <div class="site-form-copy" id="site-form-display">
          <div class="site-form-display-placeholder">Form display copy will appear here when Horizontal layouts are selected.</div>
        </div>
        <div class="site-form-fields">
          <div class="site-form-field"></div>
          <div class="site-form-field"></div>
          <div class="site-form-field"></div>
          <div class="site-form-field"></div>
          <div class="site-form-field short"></div>
          <label class="site-form-checkbox"><span class="box"></span>I agree to the Experian terms.</label>
          <button type="button" class="site-form-submit">Submit</button>
          <div class="site-form-trust">Your data remains in the Experian US data center.</div>
          <div class="site-form-social">
            <span>or sign in using</span>
            <div class="dots">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="site-inline-slot" id="site-inline-slot">
    <h2>Embedded form</h2>
    <div class="site-inline-placeholder" id="site-inline-placeholder" aria-live="polite">
      Publish the renderer with Capture pattern set to Inline to embed the form here.
    </div>
    <div class="site-inline-wrap" id="site-inline-wrap" hidden>
      <div class="site-inline-head">
        <span class="site-inline-label">Live preview</span>
        <button type="button" class="btn btn-secondary" id="inline-open-renderer">Re-open builder</button>
      </div>
      <div class="wizard-nav" id="inline-wizard-nav"></div>
      <div class="form-preview density-standard" id="inline-preview"></div>
      <div class="wizard-footer" id="inline-wizard-footer">
        <button class="btn btn-secondary" type="button" id="inline-back-btn">Back</button>
        <button class="btn btn-exp-submit" type="button" id="inline-next-btn">Next</button>
      </div>
      <button class="btn btn-exp-submit" type="button" id="inline-submit-btn">Submit</button>
    </div>
  </div>
</div>

<div class="renderer-overlay" id="renderer-overlay" aria-hidden="false">

<div class="dialog">
  <div class="dialog-header">
    <div class="dialog-header-title">
      <span class="icon">≡</span>
      <h2>Form Renderer</h2>
    </div>
    <div class="dialog-header-actions">
      <button id="renderer-undo" type="button" aria-label="Undo" title="Undo">⟲</button>
      <button id="renderer-redo" type="button" aria-label="Redo" title="Redo">⟳</button>
      <button id="renderer-close" type="button" aria-label="Close">✕</button>
      <button id="renderer-publish" type="button" aria-label="Publish">✓</button>
    </div>
  </div>

  
  <div class="dialog-tabs">
    <div class="dialog-tab active" data-tab="form">Form</div>
    <div class="dialog-tab" data-tab="properties">Properties</div>
    <div class="dialog-tab" data-tab="design">Design</div>
    <div class="dialog-tab" data-tab="confirmation">Confirmation</div>
  </div>

  <div class="renderer-banner" id="renderer-banner" role="status" aria-live="polite">
    <div class="renderer-banner-inner">
      <div class="renderer-banner-message" id="renderer-banner-message"></div>
      <button class="renderer-banner-close" id="renderer-banner-close" type="button" aria-label="Dismiss">✕</button>
    </div>
  </div>


  <div class="dialog-body">

    <div class="tab-panel" id="tab-properties">
      <div class="helper" style="margin-bottom:8px;">
        Configure routing + integration metadata used by downstream systems and reporting. Most values can be derived automatically from the page; only override when needed.
      </div>

      <div class="tab-bulk-actions" aria-label="Properties sections">
        <button class="panel-toggle" type="button" id="properties-toggle-all">Collapse all</button>
      </div>

      <div class="form-meta-panel">
        <div class="form-meta-panel-head">
          <div>
            <h4>Routing information</h4>
            <p class="form-meta-helper">Template defaults load automatically. Remove to override with a custom value.</p>
          </div>
          <button id="routing-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="routing-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="routing-body">
          <div class="form-meta-grid">
            <div class="form-meta-field" data-meta-field="eloquaName">
              <label for="meta-eloqua-input">Eloqua Form HTML Name</label>
              <div class="meta-input-row">
                <input id="meta-eloqua-input" type="text" placeholder="Enter Eloqua HTML name" />
                <button type="button" class="btn btn-secondary meta-add-btn" data-meta-key="eloquaName">Add</button>
              </div>
              <div id="meta-eloqua-chips"></div>
            </div>

            <div class="form-meta-field" data-meta-field="salesforceCampaignId">
              <label for="meta-salesforce-campaign-input">Salesforce Campaign ID</label>
              <div class="meta-input-row">
                <input id="meta-salesforce-campaign-input" type="text" placeholder="Enter Salesforce Campaign ID" maxlength="18" inputmode="text" autocapitalize="none" autocomplete="off" />
                <button type="button" class="btn btn-secondary meta-add-btn" data-meta-key="salesforceCampaignId">Add</button>
              </div>
              <div id="meta-salesforce-campaign-chips"></div>
            </div>

            <div class="form-meta-field" data-meta-field="salesforceNotes">
              <label for="meta-salesforce-notes-input">Salesforce Lead/Task Notes</label>
              <div class="meta-input-row">
                <input id="meta-salesforce-notes-input" type="text" placeholder="Enter default notes" />
                <button type="button" class="btn btn-secondary meta-add-btn" data-meta-key="salesforceNotes">Add</button>
              </div>
              <div id="meta-salesforce-notes-chips"></div>
            </div>

            <div class="form-meta-field" data-meta-field="recipientEmail">
              <label for="meta-recipient-email-input">Recipient email</label>
              <div class="meta-input-row">
                <input id="meta-recipient-email-input" type="text" placeholder="Enter recipient email" />
                <button type="button" class="btn btn-secondary meta-add-btn" data-meta-key="recipientEmail">Add</button>
              </div>
              <div id="meta-recipient-email-chips"></div>
            </div>

            <div class="form-meta-field" data-meta-field="notificationSubject">
              <label for="meta-notification-input">Subject line of notification email</label>
              <div class="meta-input-row">
                <input id="meta-notification-input" type="text" placeholder="Enter subject line" />
                <button type="button" class="btn btn-secondary meta-add-btn" data-meta-key="notificationSubject">Add</button>
              </div>
              <div id="meta-notification-chips"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-meta-panel">
        <div class="form-meta-panel-head">
          <div>
            <h4>Customer automation</h4>
            <p class="form-meta-helper">Optional: email an AEM asset to the customer after submission (useful for resource/download forms).</p>
          </div>
          <button id="automation-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="automation-panel-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="automation-panel-body">
          <div class="form-meta-grid">
            <div class="form-meta-field">
              <label>
                <input id="automation-enabled" type="checkbox" /> Email asset on submit
              </label>
              <div class="small">Uses the email address collected in the form.</div>
            </div>

            <div class="form-meta-field">
              <label for="automation-asset">Selected asset</label>
              <div class="meta-input-row">
                <input id="automation-asset" type="text" placeholder="/content/dam/..." readonly />
                <button id="automation-choose-asset" type="button" class="btn btn-secondary">Choose asset</button>
              </div>
              <div class="small">Asset must be stored in AEM DAM.</div>
            </div>

            <div class="form-meta-field">
              <label for="automation-subject">Email subject</label>
              <input id="automation-subject" type="text" placeholder="Your requested resource" />
            </div>

            <div class="form-meta-field">
              <label for="automation-email-body">Email body</label>
              <input id="automation-email-body" type="text" placeholder="Thanks — here’s the resource you requested." />
              <div class="small" id="automation-status" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-meta-panel future-state-panel">
        <div class="form-meta-panel-head">
          <div>
            <span class="future-state-pill">Future state</span>
            <h4>Accessibility</h4>
            <p class="form-meta-helper future-state-helper">Screen reader settings (for visually impaired users): form name and how validation is announced.</p>
          </div>
          <button id="a11y-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="a11y-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="a11y-body">
          <div class="form-meta-grid">
            <div class="form-meta-field">
              <label for="a11y-aria-label">ARIA label override</label>
              <input id="a11y-aria-label" type="text" placeholder="e.g., Contact sales form" />
              <div class="small">Optional. Use when the form needs a clearer name for screen readers (no visible title or multiple forms). Skip if the form already has a clear heading.</div>
            </div>

            <div class="form-meta-field">
              <label for="a11y-required-announce">Required announcement</label>
              <select id="a11y-required-announce">
                <option value="default" selected>Default (browser)</option>
                <option value="label">Add “Required” in labels</option>
                <option value="error">Announce on error</option>
              </select>
              <div class="small">How “required” is communicated. Leave Default unless you need a consistent pattern. (Future state)</div>
            </div>

            <div class="form-meta-field">
              <label for="a11y-error-summary">Error summary position</label>
              <select id="a11y-error-summary">
                <option value="top" selected>Top of form</option>
                <option value="inline">Inline only</option>
              </select>
              <div class="small">Where an error summary appears (if enabled). (Future state)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-meta-panel future-state-panel">
        <div class="form-meta-panel-head">
          <div>
            <span class="future-state-pill">Future state</span>
            <h4>Experimentation hooks</h4>
            <p class="form-meta-helper future-state-helper">Optional IDs for A/B testing and reporting (e.g., Adobe Target).</p>
          </div>
          <button id="hooks-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="hooks-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="hooks-body">
          <div class="form-meta-grid">
            <div class="form-meta-field">
              <label for="hooks-variant-id">Variant ID</label>
              <input id="hooks-variant-id" type="text" placeholder="e.g., v1" />
            </div>

            <div class="form-meta-field">
              <label for="hooks-cta-id">CTA ID</label>
              <input id="hooks-cta-id" type="text" placeholder="e.g., hero-contact-us" />
            </div>

            <div class="form-meta-field">
              <label for="hooks-form-uuid">Form instance UUID</label>
              <input id="hooks-form-uuid" type="text" readonly placeholder="Generated on publish" />
              <div class="small">Generated at publish-time and remains stable until the next publish.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-meta-panel future-state-panel">
        <div class="form-meta-panel-head">
          <div>
            <span class="future-state-pill">Future state</span>
            <h4>Experience & Measurement</h4>
            <p class="form-meta-helper future-state-helper">Will implement upon CJA and AEP integration.</p>
          </div>
          <button id="exp-measure-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="exp-measure-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="exp-measure-body">
          <div class="form-meta-grid">
          <div class="form-meta-field">
            <label for="exp-type">Form type <span class="required-indicator">*</span></label>
            <select id="exp-type" aria-required="true">
              <option value="contact" selected>Contact</option>
              <option value="resource">Resource Download (Gated Asset)</option>
              <option value="webinar">Webinar Registration</option>
              <option value="event">Event Registration</option>
              <option value="newsletter">Newsletter Signup</option>
              <option value="demo">Request a Demo</option>
              <option value="chatbot">Chatbot</option>
            </select>
            <div class="small">Usually inferred from the template you choose on the Form tab. Override only when needed.</div>
          </div>

          <div class="form-meta-field">
            <label for="exp-funnel">Funnel stage <span class="required-indicator">*</span></label>
            <select id="exp-funnel" aria-required="true">
              <option value="tofu">TOFU (Awareness)</option>
              <option value="mofu" selected>MOFU (Consideration)</option>
              <option value="bofu">BOFU (Conversion)</option>
            </select>
          </div>

          <div class="form-meta-field">
            <label for="exp-product">Primary product / solution <span class="required-indicator">*</span></label>
            <select id="exp-product" aria-required="true">
              <option value="auto" selected>Auto (from page tags)</option>
              <option value="fraud">Fraud</option>
              <option value="identity">Identity</option>
              <option value="credit">Credit</option>
              <option value="compliance">Compliance</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-meta-field">
            <label for="exp-capture">Capture pattern <span class="required-indicator">*</span></label>
            <select id="exp-capture" aria-required="true">
              <option value="inline" selected>Inline (embedded)</option>
              <option value="modal">Modal / Drawer</option>
              <option value="redirect">Redirect to capture page</option>
            </select>
            <div class="small">Modal is recommended for download CTAs on long pages.</div>
          </div>

          <div class="form-meta-field">
            <label for="exp-campaign">Campaign qualifier set (optional)</label>
            <select id="exp-campaign">
              <option value="">None</option>
              <option value="fy26_webinar_qualifiers">FY26 Webinar Qualifiers</option>
              <option value="partner_program_questions">Partner Program Questions</option>
              <option value="healthcare_industry_split">Healthcare Industry Split</option>
            </select>
            <div class="small">Adds approved qualifying questions to the base template. No cloning required.</div>
          </div>

          <div class="form-meta-field">
            <label for="exp-routing">Routing mode <span class="required-indicator">*</span></label>
            <select id="exp-routing" aria-required="true">
              <option value="aep_auto" selected>Auto (AEP audience rules)</option>
              <option value="standard">Standard (single nurture)</option>
              <option value="sales_fasttrack">Sales fast‑track eligible</option>
            </select>
            <div class="small">Destination systems (Eloqua/SFDC) are resolved automatically based on audience + BU policy.</div>
          </div>
          </div>
        </div>
      </div>

      <div class="form-meta-panel">
        <div class="form-meta-panel-head">
          <div>
            <h4>Page context (auto)</h4>
            <p class="form-meta-helper">Pulled from page properties / tags at render time and injected into hidden metadata + analytics events.</p>
          </div>
          <button id="page-context-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="page-context-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="page-context-body">
          <div class="form-meta-grid">
          <div class="form-meta-field">
            <label>BU</label>
            <input type="text" value="Auto (site root / page path)" readonly id="ctx-bu" />
            <div class="meta-input-row">
              <select id="ctx-bu-source" aria-label="BU source">
                <option value="auto" selected>Auto</option>
                <option value="lookup">Lookup</option>
              </select>
            </div>
            <div class="meta-input-row" style="margin-top:8px;">
              <input id="ctx-bu-lookup-key" type="text" placeholder="Lookup key" style="display:none; width:100%;" aria-label="BU lookup key" />
            </div>
          </div>
          <div class="form-meta-field">
            <label>Region / language</label>
            <input type="text" value="Auto (page locale)" readonly id="ctx-locale" />
          </div>
          <div class="form-meta-field">
            <label>Page URL</label>
            <input type="text" value="Auto (current page)" readonly id="ctx-url" />
          </div>
          <div class="form-meta-field">
            <label>Asset / event ID</label>
            <input type="text" value="Auto (page property)" readonly id="ctx-asset" />
            <div class="meta-input-row">
              <select id="ctx-asset-source" aria-label="Asset/event ID source">
                <option value="auto" selected>Auto</option>
                <option value="lookup">Lookup</option>
                <option value="manual">Manual</option>
              </select>
            </div>
            <div class="meta-input-row" style="margin-top:8px;">
              <input id="ctx-asset-lookup-key" type="text" placeholder="Lookup key" style="display:none; width:100%;" aria-label="Asset/event ID lookup key" />
              <input id="ctx-asset-manual" type="text" placeholder="Manual value" style="display:none; width:100%;" aria-label="Asset/event ID manual value" />
            </div>
          </div>
          </div>

          <div class="small" style="margin-top:8px;">
            Tip: If a value can’t be auto-derived today (e.g., product), standardize it as a page tag/property so marketers don’t have to repeat it.
          </div>
        </div>
      </div>

      <div class="form-meta-panel">
        <div class="form-meta-panel-head">
          <div>
            <h4>Hidden Metadata</h4>
            <p class="form-meta-helper">Key/value metadata injected into hidden inputs and analytics payloads.</p>
          </div>
          <button id="hidden-metadata-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="hidden-metadata-body">Collapse</button>
        </div>

        <div class="form-meta-panel-body" id="hidden-metadata-body">
          <div class="form-meta-grid">
            <div class="form-meta-field" style="grid-column:1 / -1;">
              <label>Request context (auto)</label>
              <div class="small">Preview of values captured automatically from the request.</div>
            </div>
            <div class="form-meta-field">
              <label><input id="capture-utms" type="checkbox" checked /> Capture UTMs + click IDs</label>
              <div class="small">utm_* plus gclid/msclkid/fbclid</div>
            </div>
            <div class="form-meta-field">
              <label><input id="capture-referrer" type="checkbox" checked /> Capture referrer</label>
              <div class="small">document.referrer</div>
            </div>
          </div>

          <div class="form-meta-grid" style="margin-top:8px;">
            <div class="form-meta-field"><label>utm_source</label><input id="req-utm-source" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>utm_medium</label><input id="req-utm-medium" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>utm_campaign</label><input id="req-utm-campaign" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>utm_term</label><input id="req-utm-term" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>utm_content</label><input id="req-utm-content" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>gclid</label><input id="req-gclid" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>msclkid</label><input id="req-msclkid" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field"><label>fbclid</label><input id="req-fbclid" type="text" readonly value="Auto (URL param)" /></div>
            <div class="form-meta-field" style="grid-column:1 / -1;"><label>referrer</label><input id="req-referrer" type="text" readonly value="Auto (document.referrer)" /></div>
          </div>

          <div class="form-meta-grid" style="margin-top:12px;">
            <div class="form-meta-field" style="grid-column:1 / -1;">
              <label>Custom metadata (manual / lookup)</label>
              <div class="small">Add additional key/value pairs. Re-adding the same Context + Key updates the chip.</div>
            </div>
          </div>

          <div class="meta-input-row" style="flex-wrap:wrap; align-items:flex-end;">
            <label style="min-width:180px; flex:1;">
              <div style="font-size:12px; color:#374151;">Context</div>
              <select id="custom-meta-context">
                <option value="marketing" selected>Marketing (UTM)</option>
                <option value="campaign">Campaign</option>
                <option value="content">Content</option>
                <option value="product">Product</option>
                <option value="integration">Integration</option>
                <option value="other">Other</option>
              </select>
            </label>
            <label style="min-width:180px; flex:1;">
              <div style="font-size:12px; color:#374151;">Key</div>
              <input id="custom-meta-key" type="text" placeholder="e.g., utm_source" />
            </label>
            <label style="min-width:220px; flex:1;">
              <div style="font-size:12px; color:#374151;">Value source</div>
              <select id="custom-meta-source">
                <option value="manual" selected>Manual</option>
                <option value="lookup_page_property">Lookup (page property)</option>
                <option value="lookup_page_tags">Lookup (page tags)</option>
                <option value="lookup_data_layer">Lookup (data layer)</option>
                <option value="lookup_url_param">Lookup (URL param)</option>
              </select>
            </label>
            <label style="min-width:220px; flex:1;" id="custom-meta-value-wrap">
              <div style="font-size:12px; color:#374151;">Value</div>
              <input id="custom-meta-value" type="text" placeholder="Value" />
            </label>
            <label style="min-width:220px; flex:1; display:none;" id="custom-meta-lookup-wrap">
              <div style="font-size:12px; color:#374151;">Lookup key</div>
              <input id="custom-meta-lookup-key" type="text" placeholder="e.g., pagePropertyName" />
            </label>
            <button type="button" class="btn btn-secondary meta-add-btn" id="custom-meta-add-btn" data-meta-key="__hiddenCustom">Add</button>
          </div>

          <div class="hidden-meta-groups" id="custom-meta-groups"></div>
        </div>
      </div>
    </div>


    <div class="tab-panel active" id="tab-form">
      <div class="top-row">
        <div class="template-group">
          <label for="form-template">Form template</label>
          <select id="form-template">
            <option value="contact" selected>NA-US-BIS-Contact-Form</option>
            <option value="download">NA-US-BIS-Download-Resource</option>
          </select>
          <div class="helper">
            Choose the global form to render, then adjust layout, steps, and field settings for this page instance.
          </div>
        </div>
        <div class="layout-density-group">
          <div class="bulk-toggle-wrap">
            <button class="panel-toggle" type="button" id="form-toggle-all">Collapse all</button>
          </div>

        </div>
      </div>

      <div class="panel" id="form-layout-panel">
        <div class="panel-header">
          <h3>Form Layout</h3>
          <button id="form-layout-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="form-layout-body">Collapse</button>
        </div>
        <div class="form-layout-body" id="form-layout-body">
          <div class="form-display-grid">
            <label for="design-column-layout">Column layout
              <select id="design-column-layout">
                <option value="full-width" selected>Full width</option>
                <option value="horizontal-25-75">Horizontal 25 / 75</option>
                <option value="horizontal-50-50">Horizontal 50 / 50</option>
              </select>
            </label>
            <label for="layoutType">Layout type
              <select id="layoutType">
                <option value="single" selected>In-line</option>
                <option value="wizard">Multi-step</option>
                <option value="card">Card</option>
              </select>
            </label>

            <label for="density">Density
              <select id="density">
                <option value="compact">Compact</option>
                <option value="standard" selected>Standard</option>
                <option value="roomy">Roomy</option>
              </select>
            </label>
          </div>

          <div id="form-layout-wizard-settings" style="display:none; margin-top:12px;">
            <div class="form-display-grid">
              <label for="numSteps" id="numStepsGroup">Steps
                <select id="numSteps">
                  <option value="2">2 steps</option>
                  <option value="3" selected>3 steps</option>
                  <option value="4">4 steps</option>
                </select>
              </label>

              <label for="wizard-validate">Validate
                <select id="wizard-validate">
                  <option value="per-field" selected>Per field</option>
                  <option value="per-step">Per step</option>
                </select>
              </label>

              <label for="wizard-navigation">Navigation
                <select id="wizard-navigation">
                  <option value="buttons">Buttons</option>
                  <option value="stepper" selected>Stepper</option>
                </select>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" id="form-display-panel">
        <div class="panel-header">
          <h3>Form display</h3>
          <button id="form-display-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="form-display-body">Collapse</button>
        </div>
        <div class="form-display-body" id="form-display-body">
          <div class="form-display-grid">
            <label for="display-title">Form title
              <input id="display-title" type="text" placeholder="Talk to our team" />
            </label>
            <label for="display-subtitle">Subtitle
              <input id="display-subtitle" type="text" placeholder="EXPERIAN BUSINESS" />
            </label>
            <label for="display-subtext">Subtext
              <input id="display-subtext" type="text" placeholder="We typically respond within 1 business day." />
            </label>
            <label for="display-telephone">Telephone number
              <input id="display-telephone" type="text" placeholder="1 888 397 3742" />
            </label>
            <label for="display-description">Form description
              <textarea id="display-description" placeholder="Share more about your project, timeline, budget, or integration needs."></textarea>
            </label>
            <label for="display-text-align">Text alignment
              <select id="display-text-align">
                <option value="left" selected>Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
              </select>
            </label>
            <label for="display-button-text">Custom button text
              <input id="display-button-text" type="text" placeholder="Submit" />
            </label>
          </div>
          <div class="form-display-panel-note">These values update the visible title/subtext above the form and the primary submit button label.</div>

          <div id="wizard-settings" style="display:none; margin-top:12px;">
            <div class="form-display-panel-note" style="margin-top:0; font-weight:600;">Multi-step step labels</div>
            <div id="wizard-settings-grid" class="form-display-grid"></div>
            <div class="form-display-panel-note">Shown in the multi-step stepper and primary buttons.</div>
          </div>
        </div>
      </div>

      <div class="panel" id="field-panel">
          <div class="panel-header">
            <h3>Form fields</h3>
            <button id="field-panel-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="field-panel-body">Collapse</button>
          </div>
          <div id="field-panel-body" class="field-panel-body">
            <div id="field-config"></div>
            <div class="button-row">
              <button id="add-existing-field" class="btn btn-secondary">Add existing field</button>
              <button id="add-field" class="btn btn-secondary">Quick add field</button>
              <button id="add-text" class="btn btn-secondary">Add text block</button>
              <button id="refresh" class="btn btn-secondary">Refresh preview</button>
            </div>
            <div class="helper">
              Drag rows to reorder. Click a field to edit its properties inline below that field.
            </div>
          </div>
        </div>

        <!-- Properties form is kept hidden in the DOM for inline use only -->
        <div id="properties-form" style="display:none;">
          <div class="form-properties-title">Field properties</div>

          <div id="prop-label-wrapper">
            <label for="prop-label">Text</label>
            <input id="prop-label" type="text" />
          </div>

          <div id="prop-rich-editor-wrapper" style="display:none;">
            <div class="text-editor-header">
              <label class="text-editor-label" for="prop-text-editor">Text</label>
              <div class="text-editor-meta">
                <label for="prop-font-size">Font size</label>
                <select id="prop-font-size">
                  <option value="small">Small</option>
                  <option value="body" selected>Body</option>
                  <option value="heading">Heading</option>
                </select>
              </div>
            </div>
            <div class="text-editor-toolbar">
              <button type="button" data-command="bold" title="Bold">B</button>
              <button type="button" data-command="italic" title="Italic">I</button>
              <button type="button" data-command="underline" title="Underline">U</button>
              <button type="button" data-command="strikeThrough" title="Strikethrough">S</button>
              <button type="button" data-command="insertUnorderedList" title="Bulleted list">• List</button>
            </div>
            <div id="prop-text-editor" contenteditable="true" class="text-editor-content" aria-multiline="true" tabindex="0"></div>
            <div class="text-editor-controls">
              <div class="align-controls-wrapper">
                <span class="align-label">Align</span>
                <div class="align-controls">
                  <button type="button" class="align-btn active" data-align="left" title="Align left">L</button>
                  <button type="button" class="align-btn" data-align="center" title="Align center">C</button>
                  <button type="button" class="align-btn" data-align="right" title="Align right">R</button>
                </div>
              </div>
              <button id="prop-insert-link" type="button">Insert link</button>
            </div>
            <div class="text-editor-link-status">
              <span id="prop-link-status">No link inserted</span>
            </div>
            <input id="prop-url" type="hidden" value="" />
            <input id="prop-align" type="hidden" value="left" />
            <input id="prop-link-target" type="hidden" value="_blank" />
          </div>

          <div id="field-controls">
            <!-- Field-only controls (hidden for text blocks) -->
            <label for="prop-html">HTML name</label>
            <select id="prop-html">
              <option value="">Select mapping…</option>
              <option value="other1">other1</option>
              <option value="other2">other2</option>
              <option value="other3">other3</option>
              <option value="other4">other4</option>
              <option value="other5">other5</option>
              <option value="other6">other6</option>
              <option value="other7">other7</option>
              <option value="other8">other8</option>
              <option value="other9">other9</option>
              <option value="other10">other10</option>
              <option value="other11">other11</option>
              <option value="other12">other12</option>
              <option value="other13">other13</option>
              <option value="other14">other14</option>
              <option value="other15">other15</option>
              <option value="other16">other16</option>
              <option value="other17">other17</option>
              <option value="other18">other18</option>
              <option value="other19">other19</option>
              <option value="other20">other20</option>
              <option value="other21">other21</option>
              <option value="other22">other22</option>
              <option value="other23">other23</option>
              <option value="other24">other24</option>
              <option value="other25">other25</option>
              <option value="other26">other26</option>
              <option value="other27">other27</option>
              <option value="other28">other28</option>
              <option value="other29">other29</option>
              <option value="other30">other30</option>
              <option value="other31">other31</option>
              <option value="other32">other32</option>
              <option value="other33">other33</option>
              <option value="other34">other34</option>
              <option value="other35">other35</option>
              <option value="other36">other36</option>
              <option value="other37">other37</option>
              <option value="other38">other38</option>
              <option value="other39">other39</option>
              <option value="other40">other40</option>
              <option value="other41">other41</option>
              <option value="other42">other42</option>
              <option value="other43">other43</option>
              <option value="other44">other44</option>
              <option value="other45">other45</option>
              <option value="other46">other46</option>
              <option value="other47">other47</option>
              <option value="other48">other48</option>
              <option value="other49">other49</option>
              <option value="other50">other50</option>
            </select>
            <input id="prop-html-readonly" type="text" readonly disabled style="display:none;" />

            <label for="prop-type">Field type</label>
            <select id="prop-type">
              <option value="text">Text</option>
              <option value="textarea">Textarea</option>
              <option value="dropdown">Dropdown</option>
              <option value="checkbox">Checkbox</option>
              <option value="number">Number</option>
              <option value="multiselect">Multi-select</option>
              <option value="radio">Radio</option>
              <option value="date">Date</option>
              <option value="time">Time</option>
              <option value="datetime">Date &amp; time</option>
              <option value="email">Email</option>
              <option value="consent">Consent</option>
            </select>

            <input id="prop-type-readonly" type="text" readonly disabled style="display:none;" />

            <label for="prop-placeholder">Placeholder</label>
            <input id="prop-placeholder" type="text" />

            <label for="prop-help">Help text</label>
            <textarea id="prop-help" rows="2"></textarea>

            <label for="prop-width">Width</label>
            <select id="prop-width"><option value="full">Full</option><option value="half">Half</option></select>

            <label for="prop-step">Step</label>
            <select id="prop-step"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>

            <label><input id="prop-hidden" type="checkbox" /> Hidden</label>
            <label><input id="prop-required" type="checkbox" /> Required</label>

            <div id="prop-options-wrapper" style="display:none; margin-top:8px;">
              <label>Options</label>
              <div id="prop-options-list"></div>
              <button id="prop-add-option" class="btn btn-secondary" style="margin-top:8px;">+ Add option</button>
            </div>

            <!-- Conditions: simple if/then rules -->
            <div id="prop-conditions-section">
              <div class="condition-header" id="prop-conditions-header">
                <label style="margin-top:12px;">Conditions (If/Then)</label>
                <button id="prop-condition-toggle" type="button" class="condition-toggle off" aria-pressed="false">Off</button>
              </div>
              <div class="condition-action-row" style="display:none;">
                <span class="small" style="font-weight:600;">Action</span>
                <select id="prop-condition-action">
                  <option value="show">Show</option>
                  <option value="hide">Hide</option>
                </select>
              </div>
              <div id="prop-conditions-list" class="small" style="display:none; margin-top:6px;"></div>
              <button id="prop-add-condition" class="btn btn-secondary" style="display:none; margin-top:8px;">+ Add condition</button>
              <div class="small" id="prop-condition-helper" style="display:none; margin-top:6px; color:#666;">Show this field only when conditions are met. Simple equality rules supported (field == value).</div>
              <div class="meta-error" id="prop-condition-error" style="display:none; margin-top:8px;"></div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <button id="prop-apply" class="btn btn-primary btn-full">Apply</button>
          </div>
        </div>
        <div id="link-modal" class="link-modal" style="display:none;">
          <div class="link-modal-content">
            <div class="link-modal-header">
              <span>Embed Link</span>
              <button type="button" class="link-modal-close">×</button>
            </div>
            <label class="link-modal-label">URL
              <input id="link-url" type="text" placeholder="https://example.com" />
            </label>
            <label class="link-modal-label">Text to display
              <input id="link-text" type="text" placeholder="Please Input" />
            </label>
            <label class="link-modal-label">Action
              <select id="link-action">
                <option value="new" selected>New window</option>
                <option value="current">Current window</option>
              </select>
            </label>
            <div class="link-modal-buttons">
              <button id="link-cancel" type="button">Cancel</button>
              <button id="link-save" type="button" class="btn btn-primary">Save</button>
            </div>
          </div>
        </div>

        <div id="existing-field-modal" class="existing-field-modal" aria-hidden="true" style="display:none;">
          <div class="existing-field-modal-content" role="dialog" aria-modal="true" aria-labelledby="existing-field-modal-title">
            <div class="existing-field-modal-header">
              <div>
                <span id="existing-field-modal-title">Add an existing field</span>
                <div class="existing-field-modal-subtitle">Choose from the governed field library.</div>
              </div>
              <button type="button" id="existing-field-modal-close" class="existing-field-modal-close" aria-label="Close">×</button>
            </div>
            <div class="existing-field-modal-body">
              <div id="existing-field-list"></div>
            </div>
          </div>
        </div>

        <div class="panel" id="live-preview-panel">
          <div class="panel-header">
            <h3>Live preview</h3>
            <button id="live-preview-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="live-preview-body">Collapse</button>
          </div>
          <div class="live-preview-body" id="live-preview-body">
            <div class="preview-box">
              <div class="preview-header">
                <span id="preview-title">Desktop preview</span>
                <span class="layout-tag" id="layout-tag">Inline form</span>
              </div>
              <div class="wizard-nav" id="wizard-nav"></div>
              <div class="form-preview density-standard" id="preview"></div>
              <div class="wizard-footer" id="preview-wizard-footer">
                <button class="btn btn-secondary" type="button" id="preview-back-btn">Back</button>
                <button class="btn btn-exp-submit" type="button" id="preview-next-btn">Next</button>
              </div>
              <button class="btn btn-exp-submit" id="preview-submit-btn">Submit</button>
            </div>
            <div class="helper">
              Preview shows how layout, steps, field types, and dropdown options will render on the page.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-panel" id="tab-design">
      <div class="tab-bulk-actions" aria-label="Design sections">
        <button class="panel-toggle" type="button" id="design-toggle-all">Collapse all</button>
      </div>

      <div class="panel" id="design-theme-panel">
        <div class="panel-header">
          <h3>Theme</h3>
          <button id="design-theme-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-theme-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-theme-body">
          <div class="design-panel-note">Applies approved Experian brand styling. Visual only.</div>
          <div class="design-grid">
            <label for="design-theme">Theme
              <select id="design-theme">
                <option value="light" selected>Light</option>
                <option value="dark">Dark</option>
                <option value="blue">Experian Blue</option>
                <option value="teal">Experian Teal Accent</option>
                <option value="raspberry">Experian Raspberry Accent</option>
                <option value="purple">Experian Purple Accent</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="panel" id="design-background-panel">
        <div class="panel-header">
          <h3>Background &amp; Container</h3>
          <button id="design-background-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-background-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-background-body">
          <div class="design-panel-note">Visual framing only. Does not change layout.</div>
          <div class="design-grid">
            <label for="design-background">Background theme
              <select id="design-background">
                <option value="default" selected>Default framing</option>
                <option value="trapezoid-bottom">Trapezoid — Bottom beam</option>
                <option value="trapezoid-top">Trapezoid — Top beam</option>
                <option value="gradient">Gradient glow</option>
              </select>
            </label>
            <label for="design-container-style">Container style
              <select id="design-container-style">
                <option value="flat">Flat</option>
                <option value="elevated" selected>Elevated</option>
                <option value="outline">Outline</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="panel" id="design-emphasis-panel">
        <div class="panel-header">
          <h3>Visual Emphasis</h3>
          <button id="design-emphasis-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-emphasis-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-emphasis-body">
          <div class="design-panel-note">Controls prominence (contrast and elevation) without moving content.</div>
          <div class="design-grid">
            <label for="design-emphasis">Emphasis
              <select id="design-emphasis">
                <option value="neutral" selected>Neutral</option>
                <option value="primary">Primary focus</option>
                <option value="subtle">Subtle</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="panel" id="design-buttons-panel">
        <div class="panel-header">
          <h3>Buttons</h3>
          <button id="design-buttons-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-buttons-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-buttons-body">
          <div class="design-panel-note">Visual style only. Does not change button labels or submission behavior.</div>
          <div class="design-grid">
            <label for="design-button-style">Button style
              <select id="design-button-style">
                <option value="solid" selected>Solid</option>
                <option value="outline">Outline</option>
                <option value="minimal">Minimal</option>
              </select>
            </label>
            <label for="design-button-shape">Button shape
              <select id="design-button-shape">
                <option value="rounded" selected>Rounded</option>
                <option value="pill">Pill</option>
                <option value="soft">Soft</option>
              </select>
            </label>
            <label for="design-button-width">Button width
              <select id="design-button-width">
                <option value="default" selected>Default</option>
                <option value="wide">Wide</option>
                <option value="full">Full width</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="panel" id="design-inputs-panel">
        <div class="panel-header">
          <h3>Inputs</h3>
          <button id="design-inputs-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-inputs-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-inputs-body">
          <div class="design-panel-note">Visual presentation only. Does not change validation rules.</div>
          <div class="design-grid">
            <label for="design-input-style">Input style
              <select id="design-input-style">
                <option value="outlined" selected>Outlined</option>
                <option value="filled">Filled</option>
              </select>
            </label>
            <label for="design-input-radius">Input radius
              <select id="design-input-radius">
                <option value="standard" selected>Standard</option>
                <option value="soft">Soft</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="panel" id="design-typography-panel">
        <div class="panel-header">
          <h3>Typography</h3>
          <button id="design-typography-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-typography-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-typography-body">
          <div class="design-panel-note">Type styling only. Content remains in Form Display.</div>
          <div class="design-grid">
            <label for="design-type-scale">Type scale
              <select id="design-type-scale">
                <option value="default" selected>Default</option>
                <option value="compact">Compact</option>
                <option value="spacious">Spacious</option>
              </select>
            </label>
            <label for="design-heading-weight">Heading weight
              <select id="design-heading-weight">
                <option value="regular" selected>Regular</option>
                <option value="bold">Bold</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="panel" id="design-motion-panel">
        <div class="panel-header">
          <h3>Motion</h3>
          <button id="design-motion-toggle" class="panel-toggle" type="button" aria-expanded="true" aria-controls="design-motion-body">Collapse</button>
        </div>
        <div class="design-panel-body" id="design-motion-body">
          <div class="design-panel-note">Controls animation/transition smoothness (hover/focus). Does not change form behavior or wizard logic.</div>
          <div class="design-grid">
            <label for="design-motion">Motion
              <select id="design-motion">
                <option value="none">None</option>
                <option value="subtle" selected>Subtle</option>
              </select>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-panel" id="tab-confirmation">
      <div class="helper">Confirmation tab retains Redirect / Modal / Download options and copy.</div>
    </div>

  </div>
</div>

<div class="renderer-overlay" id="cta-overlay" aria-hidden="true">
  <div class="dialog">
    <div class="dialog-header">
      <div class="dialog-header-title">
        <span class="icon">≡</span>
        <h2>CTA Renderer</h2>
      </div>
      <div class="dialog-header-actions">
        <button id="cta-close" type="button" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="dialog-body">
      <div class="panel">
        <h3>Action</h3>
        <div class="form-display-grid">
          <label>
            Action
            <select id="cta-action">
              <option value="navigate">Navigate to URL</option>
              <option value="scroll" selected>On-page form (scroll)</option>
              <option value="modal">Popup form (modal)</option>
            </select>
          </label>
          <label id="cta-url-wrap" style="display:none;">
            URL
            <input id="cta-url" type="text" placeholder="https://example.com" />
          </label>
          <label id="cta-target-wrap">
            Target Form Renderer ID
            <input id="cta-target-id" type="text" value="lead-form" />
          </label>
        </div>

        <div class="form-layout-grid" id="cta-open-options">
          <label style="text-transform:none; letter-spacing:0;">
            <span style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.05em; color:#374151;">Focus first field</span>
            <select id="cta-focus">
              <option value="true" selected>Yes</option>
              <option value="false">No</option>
            </select>
          </label>
          <label style="text-transform:none; letter-spacing:0;">
            <span style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.05em; color:#374151;">CTA Id (optional)</span>
            <input id="cta-id" type="text" value="marquee-contact" />
          </label>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="cta-apply">Save changes</button>
          <button type="button" class="btn btn-secondary" id="cta-done">Done</button>
          <button type="button" class="btn btn-secondary" id="cta-reset">Reset</button>
        </div>
        <div class="helper" id="cta-status" aria-live="polite" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>
</div>

<div id="asset-modal" class="existing-field-modal" aria-hidden="true" style="display:none;">
  <div class="existing-field-modal-content" role="dialog" aria-modal="true" aria-labelledby="asset-modal-title">
    <div class="existing-field-modal-header">
      <div>
        <span id="asset-modal-title">Choose an AEM asset</span>
        <div class="existing-field-modal-subtitle">Select a DAM path to send after submission.</div>
      </div>
      <button type="button" id="asset-modal-close" class="existing-field-modal-close" aria-label="Close">×</button>
    </div>
    <div class="existing-field-modal-body">
      <div id="asset-list"></div>
    </div>
  </div>
</div>

</div>

<div id="published-form-modal" class="published-form-modal" aria-hidden="true">
  <div class="published-form-modal-content" role="dialog" aria-modal="true" aria-labelledby="published-form-title">
    <div class="published-form-modal-head">
      <h3 id="published-form-title">Form</h3>
      <button id="published-form-close" type="button" class="published-form-modal-close" aria-label="Close">×</button>
    </div>
    <div class="published-form-wrap">
      <div id="published-display-top"></div>
      <div class="wizard-nav" id="published-wizard-nav"></div>
      <div class="form-preview density-standard" id="published-preview"></div>
      <div class="wizard-footer" id="published-wizard-footer">
        <button class="btn btn-secondary" type="button" id="published-back-btn">Back</button>
        <button class="btn btn-exp-submit" type="button" id="published-next-btn">Next</button>
      </div>
      <button class="btn btn-exp-submit" type="button" id="published-submit-btn">Submit</button>
    </div>
  </div>
</div>

<script src="form-bridge.js"></script>
<script>
  // Tab switching
  var tabs = document.querySelectorAll('.dialog-tab');
  var panels = document.querySelectorAll('.tab-panel');
  var dialogBody = document.querySelector('.dialog-body');

  function resetDialogBodyScroll() {
    if (!dialogBody) return;
    dialogBody.scrollTop = 0;
    // Some focus/layout changes can re-scroll after tab swap; force once more.
    setTimeout(function(){ if (dialogBody) dialogBody.scrollTop = 0; }, 0);
    setTimeout(function(){ if (dialogBody) dialogBody.scrollTop = 0; }, 60);
  }

  function scrollActiveTabToTop() {
    if (!dialogBody) return;
    var activePanel = document.querySelector('.tab-panel.active');
    if (!activePanel) return;
    try {
      activePanel.scrollIntoView({ block: 'start', inline: 'nearest' });
    } catch (e) {
      // ignore
    }
    dialogBody.scrollTop = 0;
  }

  tabs.forEach(function(tab){
    tab.addEventListener('click', function(){
      var target = tab.getAttribute('data-tab');
      tabs.forEach(function(t){ t.classList.remove('active'); });
      panels.forEach(function(p){ p.classList.remove('active'); });
      tab.classList.add('active');
      var panel = document.getElementById('tab-' + target);
      if (panel) panel.classList.add('active');
      resetDialogBodyScroll();
      // Ensure the panel anchors at the top even if delayed focus/layout occurs.
      setTimeout(scrollActiveTabToTop, 0);
      setTimeout(scrollActiveTabToTop, 80);
    });
  });

  // Renderer overlay + publish-to-site behavior
  var rendererOverlay = document.getElementById('renderer-overlay');
  var rendererCloseBtn = document.getElementById('renderer-close');
  var rendererPublishBtn = document.getElementById('renderer-publish');

  // Top-of-renderer banner (used for validation/warnings)
  var rendererBanner = document.getElementById('renderer-banner');
  var rendererBannerMessage = document.getElementById('renderer-banner-message');
  var rendererBannerClose = document.getElementById('renderer-banner-close');
  var bannerHideTimer = null;

  function showRendererBanner(message, options) {
    if (!rendererBanner || !rendererBannerMessage) return;
    rendererBannerMessage.textContent = message || '';
    rendererBanner.style.display = message ? 'block' : 'none';
    if (bannerHideTimer) { clearTimeout(bannerHideTimer); bannerHideTimer = null; }
    if (message && !(options && options.sticky)) {
      bannerHideTimer = setTimeout(function(){
        if (rendererBanner) rendererBanner.style.display = 'none';
      }, 6500);
    }
  }

  function formatFieldLabelForMessage(field) {
    if (!field) return 'Untitled';
    var label = (field.label || '').trim();
    if (label) return label;
    var html = (field.html || '').trim();
    if (html) return html;
    return field.id || 'Untitled';
  }

  function getRendererValidationReport(config) {
    var report = { errors: [], warnings: [] };
    if (!Array.isArray(config)) return report;

    // Duplicate HTML name mappings
    var map = {};
    config.forEach(function(field){
      if (!field || field.type !== 'field') return;
      if (field.show === false) return;
      var html = (field.html || '').trim();
      if (!html) return;
      if (!map[html]) map[html] = [];
      map[html].push(field);
    });
    Object.keys(map).forEach(function(html){
      if ((map[html] || []).length < 2) return;
      var names = map[html].map(function(f){ return '"' + formatFieldLabelForMessage(f) + '"'; }).join(', ');
      report.errors.push('Duplicate HTML name "' + html + '" used by ' + names + '.');
    });

    // Required fields that are explicitly hidden (error)
    config.forEach(function(field){
      if (!field || field.type !== 'field') return;
      if (!field.required) return;
      if (field.show === false) {
        report.errors.push('Required field "' + formatFieldLabelForMessage(field) + '" is set to hidden.');
      }
    });

    // Required fields that can be hidden by conditions (warning), and ones that are currently hidden (error)
    config.forEach(function(field){
      if (!field || field.type !== 'field') return;
      if (!field.required) return;
      if (!hasActiveConditions(field)) return;

      report.warnings.push('Required field "' + formatFieldLabelForMessage(field) + '" is conditional and may be hidden.');

      var key = (field.html || field.id || '').trim();
      if (!key) return;
      var entry = getPreviewFieldEntry(key);
      if (!entry || !entry.element) return;
      var hiddenNow = !shouldFieldBeVisibleUnderConditions(field);
      if (hiddenNow) {
        report.errors.push('Required field "' + formatFieldLabelForMessage(field) + '" is currently hidden by conditions.');
      }
    });

    return report;
  }

  function syncRendererValidationBanner(config) {
    var report = getRendererValidationReport(config);
    if (report.errors && report.errors.length) {
      showRendererBanner('Validation errors: ' + report.errors.join(' '), { sticky: false });
      return report;
    }
    if (report.warnings && report.warnings.length) {
      showRendererBanner('Validation warning: ' + report.warnings.join(' '), { sticky: false });
      return report;
    }
    showRendererBanner('');
    return report;
  }

  function getStickyHeaderOffsetPx() {
    // Account for the sticky CTA banner so scroll lands at the true top of the component.
    var offset = 0;
    var banner = document.querySelector('.site-cta-banner.sticky-top');
    if (banner && banner.getBoundingClientRect) {
      offset += banner.getBoundingClientRect().height || 0;
    }
    return Math.ceil(offset + 8);
  }

  function scrollToElementTop(el, behavior) {
    if (!el || !el.getBoundingClientRect) return;
    var rect = el.getBoundingClientRect();
    var scrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
    var top = rect.top + scrollTop - getStickyHeaderOffsetPx();
    if (top < 0) top = 0;
    try {
      window.scrollTo({ top: top, behavior: behavior || 'smooth' });
    } catch (e) {
      window.scrollTo(0, top);
    }
  }
  if (rendererBannerClose) {
    rendererBannerClose.addEventListener('click', function(){
      if (bannerHideTimer) { clearTimeout(bannerHideTimer); bannerHideTimer = null; }
      if (rendererBanner) rendererBanner.style.display = 'none';
    });
  }

  // Live validation (green check when a field becomes valid)
  function syncLiveValidationForControl(control) {
    if (!control) return;
    if (!control.closest || !control.closest('.form-preview')) return;
    if (control.type === 'checkbox' || control.type === 'radio') return;
    var inner = control.closest('.preview-field-inner');
    if (!inner) return;

    var value = (typeof control.value === 'string') ? control.value.trim() : '';
    var hasValue = value.length > 0;
    var isValid = false;
    if (hasValue && typeof control.checkValidity === 'function') {
      try { isValid = control.checkValidity(); } catch (e) { isValid = true; }
    }
    inner.classList.toggle('is-valid', !!isValid);
  }

  document.addEventListener('input', function(e){
    var t = e && e.target;
    if (!t) return;
    if (t.tagName !== 'INPUT' && t.tagName !== 'TEXTAREA' && t.tagName !== 'SELECT') return;
    syncLiveValidationForControl(t);
  }, true);
  document.addEventListener('change', function(e){
    var t = e && e.target;
    if (!t) return;
    if (t.tagName !== 'INPUT' && t.tagName !== 'TEXTAREA' && t.tagName !== 'SELECT') return;
    syncLiveValidationForControl(t);
  }, true);

  var siteCta = document.getElementById('site-cta');
  var siteCtaHelp = document.getElementById('site-cta-help');
  var siteOpenRendererBtn = document.getElementById('site-open-renderer');
  var siteOpenCtaRendererBtn = document.getElementById('site-open-cta-renderer');
  var ctaOverlay = document.getElementById('cta-overlay');
  var ctaCloseBtn = document.getElementById('cta-close');
  var ctaActionSelect = document.getElementById('cta-action');
  var ctaUrlWrap = document.getElementById('cta-url-wrap');
  var ctaUrlInput = document.getElementById('cta-url');
  var ctaTargetWrap = document.getElementById('cta-target-wrap');
  var ctaTargetIdInput = document.getElementById('cta-target-id');
  var ctaFocusSelect = document.getElementById('cta-focus');
  var ctaIdInput = document.getElementById('cta-id');
  var ctaApplyBtn = document.getElementById('cta-apply');
  var ctaDoneBtn = document.getElementById('cta-done');
  var ctaResetBtn = document.getElementById('cta-reset');
  var ctaStatus = document.getElementById('cta-status');

  function setCtaRendererOpen(open) {
    if (!ctaOverlay) return;
    ctaOverlay.setAttribute('aria-hidden', open ? 'false' : 'true');
    if (open && ctaActionSelect) ctaActionSelect.focus();
  }

  function syncCtaRendererUi() {
    if (!ctaActionSelect) return;
    var action = ctaActionSelect.value;
    var isNavigate = action === 'navigate';
    if (ctaUrlWrap) ctaUrlWrap.style.display = isNavigate ? '' : 'none';
    if (ctaTargetWrap) ctaTargetWrap.style.display = isNavigate ? 'none' : '';
    var openOpts = document.getElementById('cta-open-options');
    if (openOpts) openOpts.style.display = isNavigate ? 'none' : '';
  }

  function applyCtaToMarquee() {
    var el = document.querySelector('.site-marquee-cta');
    if (!el) {
      if (ctaStatus) ctaStatus.textContent = 'Could not find .site-marquee-cta on the page.';
      return false;
    }
    var action = ctaActionSelect ? ctaActionSelect.value : 'scroll';
    var ctaId = ctaIdInput ? (ctaIdInput.value || '') : '';

    if (action === 'navigate') {
      var url = ctaUrlInput ? (ctaUrlInput.value || '').trim() : '';
      if (!url) {
        if (ctaStatus) ctaStatus.textContent = 'Enter a URL for Navigate to URL.';
        try { if (ctaUrlInput) ctaUrlInput.focus(); } catch (e) {}
        return false;
      }
      el.setAttribute('href', url);
      el.removeAttribute('data-form-open');
      el.removeAttribute('data-form-open-mode');
      el.removeAttribute('data-form-expand');
      el.removeAttribute('data-form-focus');
      el.removeAttribute('data-cta-id');
      if (ctaId) el.setAttribute('data-cta-id', ctaId);
      if (ctaStatus) ctaStatus.textContent = 'Marquee CTA now navigates to: ' + url;
      // Ensure the on-page form area is not forcibly hidden.
      if (typeof setOnPageFormHiddenForCta === 'function') setOnPageFormHiddenForCta(false);
      return true;
    }

    var targetId = ctaTargetIdInput ? (ctaTargetIdInput.value || '').trim() : '';
    if (!targetId) {
      if (ctaStatus) ctaStatus.textContent = 'Enter a Target Form Renderer ID.';
      try { if (ctaTargetIdInput) ctaTargetIdInput.focus(); } catch (e) {}
      return false;
    }
    var mode = action === 'modal' ? 'modal' : 'scroll';
    var focus = ctaFocusSelect ? (ctaFocusSelect.value || 'true') : 'true';

    el.setAttribute('href', '#');
    el.setAttribute('data-form-open', targetId);
    el.setAttribute('data-form-open-mode', mode);
    // Always expand when opening; no author toggle needed.
    el.setAttribute('data-form-expand', 'true');
    el.setAttribute('data-form-focus', focus);
    if (ctaId) el.setAttribute('data-cta-id', ctaId);

    if (ctaStatus) ctaStatus.textContent = (mode === 'modal')
      ? ('Marquee CTA now opens Form Renderer "' + targetId + '" in a popup modal.')
      : ('Marquee CTA now scrolls to Form Renderer "' + targetId + '" on-page.');

    // If author chose popup modal, hide the on-page form so only the modal experience applies.
    if (typeof setOnPageFormHiddenForCta === 'function') setOnPageFormHiddenForCta(mode === 'modal');

    return true;
  }

  function setOnPageFormHiddenForCta(hidden) {
    if (!siteFormPanel && !inlineWrap) return;

    if (hidden) {
      if (siteFormPanel) siteFormPanel.hidden = true;
      if (inlineWrap) inlineWrap.hidden = true;
      if (siteInlineSlot) siteInlineSlot.hidden = true;
      if (inlinePlaceholder) inlinePlaceholder.style.display = 'none';
      return;
    }

    // Restore to normal publish wiring when available.
    if (publishedState) {
      refreshPublishTargets();
      return;
    }

    // No publish state: just ensure the panel is visible again.
    if (siteFormPanel) siteFormPanel.hidden = false;
    if (siteInlineSlot) siteInlineSlot.hidden = false;
  }

  function prefillCtaRendererUiFromMarquee() {
    var el = document.querySelector('.site-marquee-cta');
    if (!el) {
      resetCtaRendererUi(true);
      return;
    }

    var isOpenForm = !!el.getAttribute('data-form-open');
    if (ctaActionSelect) {
      if (!isOpenForm) {
        ctaActionSelect.value = 'navigate';
      } else {
        var m = (el.getAttribute('data-form-open-mode') || '').trim();
        ctaActionSelect.value = (m === 'modal') ? 'modal' : 'scroll';
      }
    }

    if (ctaUrlInput) {
      var href = (el.getAttribute('href') || '').trim();
      ctaUrlInput.value = (!isOpenForm && href && href !== '#') ? href : '';
    }

    if (ctaTargetIdInput) ctaTargetIdInput.value = el.getAttribute('data-form-open') || 'lead-form';
    if (ctaFocusSelect) ctaFocusSelect.value = el.getAttribute('data-form-focus') || 'true';
    if (ctaIdInput) ctaIdInput.value = el.getAttribute('data-cta-id') || '';

    if (ctaStatus) ctaStatus.textContent = '';
    syncCtaRendererUi();
  }

  function resetCtaRendererUi(forceDefaults) {
    if (forceDefaults) {
      if (ctaActionSelect) ctaActionSelect.value = 'scroll';
      if (ctaTargetIdInput) ctaTargetIdInput.value = 'lead-form';
      if (ctaFocusSelect) ctaFocusSelect.value = 'true';
      if (ctaIdInput) ctaIdInput.value = 'marquee-contact';
      if (ctaUrlInput) ctaUrlInput.value = '';
      if (ctaStatus) ctaStatus.textContent = '';
      syncCtaRendererUi();
      return;
    }

    prefillCtaRendererUiFromMarquee();
  }
  var siteFormPanel = document.getElementById('site-form-panel');
  var siteFormDisplay = document.getElementById('site-form-display');
  var siteFormFields = document.querySelector('#site-form-panel .site-form-fields');
  var siteInlineSlot = document.getElementById('site-inline-slot');
  var siteHeroDisplay = document.getElementById('site-hero-display');
  var inlineWrap = document.getElementById('site-inline-wrap');
  var inlinePlaceholder = document.getElementById('site-inline-placeholder');
  var inlinePreview = document.getElementById('inline-preview');
  var inlineWizardNav = document.getElementById('inline-wizard-nav');
  var inlineOpenBtn = document.getElementById('inline-open-renderer');
    var inlineDefaultParent = inlineWrap ? inlineWrap.parentElement : null;
    var inlineDefaultNextSibling = inlineWrap ? inlineWrap.nextSibling : null;
  var previewSubmitBtn = document.getElementById('preview-submit-btn');
  var inlineSubmitBtn = document.getElementById('inline-submit-btn');
  var publishedSubmitBtn = document.getElementById('published-submit-btn');

  var previewWizardFooter = document.getElementById('preview-wizard-footer');
  var previewBackBtn = document.getElementById('preview-back-btn');
  var previewNextBtn = document.getElementById('preview-next-btn');

  var inlineWizardFooter = document.getElementById('inline-wizard-footer');
  var inlineBackBtn = document.getElementById('inline-back-btn');
  var inlineNextBtn = document.getElementById('inline-next-btn');

  var publishedWizardFooter = document.getElementById('published-wizard-footer');
  var publishedBackBtn = document.getElementById('published-back-btn');
  var publishedNextBtn = document.getElementById('published-next-btn');

  var displayTitleInput = document.getElementById('display-title');
  var displaySubtitleInput = document.getElementById('display-subtitle');
  var displaySubtextInput = document.getElementById('display-subtext');
  var displayTelephoneInput = document.getElementById('display-telephone');
  var displayDescriptionInput = document.getElementById('display-description');
  var displayAlignSelect = document.getElementById('display-text-align');
  var displayButtonTextInput = document.getElementById('display-button-text');
  var siteShell = document.getElementById('site-shell');
  var siteHero = document.getElementById('site-hero');
  var designColumnSelect = document.getElementById('design-column-layout');
  var designBackgroundSelect = document.getElementById('design-background');
  var designThemeSelect = document.getElementById('design-theme');
  var designContainerStyleSelect = document.getElementById('design-container-style');
  var designEmphasisSelect = document.getElementById('design-emphasis');
  var designButtonStyleSelect = document.getElementById('design-button-style');
  var designButtonShapeSelect = document.getElementById('design-button-shape');
  var designButtonWidthSelect = document.getElementById('design-button-width');
  var designInputStyleSelect = document.getElementById('design-input-style');
  var designInputRadiusSelect = document.getElementById('design-input-radius');
  var designTypeScaleSelect = document.getElementById('design-type-scale');
  var designHeadingWeightSelect = document.getElementById('design-heading-weight');
  var designMotionSelect = document.getElementById('design-motion');

  var designThemeToggle = document.getElementById('design-theme-toggle');
  var designThemeBody = document.getElementById('design-theme-body');
  var designBackgroundToggle = document.getElementById('design-background-toggle');
  var designBackgroundBody = document.getElementById('design-background-body');
  var designEmphasisToggle = document.getElementById('design-emphasis-toggle');
  var designEmphasisBody = document.getElementById('design-emphasis-body');
  var designEmphasisPanel = document.getElementById('design-emphasis-panel');
  var designButtonsToggle = document.getElementById('design-buttons-toggle');
  var designButtonsBody = document.getElementById('design-buttons-body');
  var designInputsToggle = document.getElementById('design-inputs-toggle');
  var designInputsBody = document.getElementById('design-inputs-body');
  var designTypographyToggle = document.getElementById('design-typography-toggle');
  var designTypographyBody = document.getElementById('design-typography-body');
  var designMotionToggle = document.getElementById('design-motion-toggle');
  var designMotionBody = document.getElementById('design-motion-body');
  var formLayoutPanelToggle = document.getElementById('form-layout-toggle');
  var formLayoutPanelBody = document.getElementById('form-layout-body');
  var formLayoutWizardSettingsWrap = document.getElementById('form-layout-wizard-settings');
  var wizardValidateSelect = document.getElementById('wizard-validate');
  var wizardNavigationSelect = document.getElementById('wizard-navigation');
  var formDisplayPanelToggle = document.getElementById('form-display-toggle');
  var formDisplayPanelBody = document.getElementById('form-display-body');

  var wizardSettingsWrap = document.getElementById('wizard-settings');
  var wizardSettingsGrid = document.getElementById('wizard-settings-grid');

  var formToggleAllBtn = document.getElementById('form-toggle-all');
  var propertiesToggleAllBtn = document.getElementById('properties-toggle-all');
  var designToggleAllBtn = document.getElementById('design-toggle-all');

  var wizardUiState = {
    stepTitles: [],
    stepPrimaryLabels: [],
    backLabel: 'Back'
  };

  var wizardEditorsRenderedSteps = 0;

  // Customer automation (Properties tab)
  var automationEnabled = document.getElementById('automation-enabled');
  var automationAsset = document.getElementById('automation-asset');
  var automationChooseAssetBtn = document.getElementById('automation-choose-asset');
  var automationSubject = document.getElementById('automation-subject');
  var automationEmailBody = document.getElementById('automation-email-body');
  var automationStatus = document.getElementById('automation-status');

  var assetModal = document.getElementById('asset-modal');
  var assetModalClose = document.getElementById('asset-modal-close');
  var assetList = document.getElementById('asset-list');

  var automationState = {
    enabled: false,
    assetPath: '',
    subject: '',
    body: ''
  };

  // Accessibility + Experimentation hooks (Properties tab)
  var a11yAriaLabelInput = document.getElementById('a11y-aria-label');
  var a11yRequiredAnnounceSelect = document.getElementById('a11y-required-announce');
  var a11yErrorSummarySelect = document.getElementById('a11y-error-summary');
  var hooksVariantIdInput = document.getElementById('hooks-variant-id');
  var hooksCtaIdInput = document.getElementById('hooks-cta-id');
  var hooksFormUuidInput = document.getElementById('hooks-form-uuid');

  function readTextValue(input) {
    return input ? (input.value || '').trim() : '';
  }

  function getAccessibilityState() {
    return {
      ariaLabel: readTextValue(a11yAriaLabelInput),
      requiredAnnouncement: a11yRequiredAnnounceSelect ? a11yRequiredAnnounceSelect.value : 'default',
      errorSummaryPosition: a11yErrorSummarySelect ? a11yErrorSummarySelect.value : 'top'
    };
  }

  function getExperimentationHooksState(formInstanceUuid) {
    return {
      variantId: readTextValue(hooksVariantIdInput),
      ctaId: readTextValue(hooksCtaIdInput),
      formInstanceUuid: formInstanceUuid || ''
    };
  }

  function generateUuidV4() {
    if (window.crypto && window.crypto.getRandomValues) {
      var buf = new Uint8Array(16);
      window.crypto.getRandomValues(buf);
      buf[6] = (buf[6] & 0x0f) | 0x40;
      buf[8] = (buf[8] & 0x3f) | 0x80;
      var hex = Array.from(buf).map(function(b){ return ('0' + b.toString(16)).slice(-2); }).join('');
      return (
        hex.slice(0, 8) + '-' +
        hex.slice(8, 12) + '-' +
        hex.slice(12, 16) + '-' +
        hex.slice(16, 20) + '-' +
        hex.slice(20)
      );
    }
    // fallback: non-crypto random
    var d = Date.now();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){
      var r = (d + Math.random() * 16) % 16 | 0;
      d = Math.floor(d / 16);
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

  // Minimal AEM DAM library (demo data)
  var AEM_ASSET_LIBRARY = [
    { group: 'Resources', title: 'Fraud prevention overview (PDF)', path: '/content/dam/experian/resources/fraud-prevention-overview.pdf' },
    { group: 'Resources', title: 'Identity insights one-pager (PDF)', path: '/content/dam/experian/resources/identity-insights-one-pager.pdf' },
    { group: 'Case studies', title: 'Auto lender case study (PDF)', path: '/content/dam/experian/case-studies/auto-lender-case-study.pdf' },
    { group: 'Webinars', title: 'FY26 risk webinar slides (PPT)', path: '/content/dam/experian/webinars/fy26-risk-webinar-slides.pptx' }
  ];

  var FORM_DISPLAY_DEFAULTS = {
    title: 'Let’s power opportunities together.',
    subtitle: 'EXPERIAN BUSINESS',
    subtext: 'We’re here to help. If you’d like to learn more about our business solutions, please fill out the form below.',
    telephone: '1 888 397 3742',
    description: 'Personal credit report assistance is not available here. If you have questions or issues related to your personal credit report, disputes or fraud alerts, visit Experian.com/help.\n\nIf you need assistance with your small business credit report, please visit Experian.com/small-business.',
    align: 'left',
    buttonText: 'Submit'
  };

  var formDisplayInputs = {
    title: displayTitleInput,
    subtitle: displaySubtitleInput,
    subtext: displaySubtextInput,
    telephone: displayTelephoneInput,
    description: displayDescriptionInput,
    align: displayAlignSelect,
    buttonText: displayButtonTextInput
  };

  var publishedModal = document.getElementById('published-form-modal');
  var publishedCloseBtn = document.getElementById('published-form-close');
  var publishedFormWrap = document.querySelector('.published-form-wrap');
  var publishedPreview = document.getElementById('published-preview');
  var publishedWizardNav = document.getElementById('published-wizard-nav');

  var publishedState = null;
  var publishedWizardStep = 1;
  var inlineWizardStep = 1;

  function initializeFormDisplayDefaults() {
    Object.keys(FORM_DISPLAY_DEFAULTS).forEach(function(key){
      var input = formDisplayInputs[key];
      if (!input) return;
      if ((input.value || '').trim()) return;
      input.value = FORM_DISPLAY_DEFAULTS[key] || '';
    });
    if (displayAlignSelect && !(displayAlignSelect.value || '').trim()) {
      displayAlignSelect.value = FORM_DISPLAY_DEFAULTS.align;
    }
  }

  function readDisplayInput(input) {
    return input ? (input.value || '').trim() : '';
  }

  function sanitizeDisplayAlign(value) {
    if (value === 'center' || value === 'right') return value;
    return 'left';
  }

  function getFormDisplayState() {
    return {
      title: readDisplayInput(displayTitleInput),
      subtitle: readDisplayInput(displaySubtitleInput),
      subtext: readDisplayInput(displaySubtextInput),
      telephone: readDisplayInput(displayTelephoneInput),
      description: readDisplayInput(displayDescriptionInput),
      align: sanitizeDisplayAlign(displayAlignSelect ? displayAlignSelect.value : 'left'),
      buttonText: readDisplayInput(displayButtonTextInput)
    };
  }

  function setFormDisplayState(state) {
    if (!state) return;
    if (displayTitleInput) displayTitleInput.value = state.title || '';
    if (displaySubtitleInput) displaySubtitleInput.value = state.subtitle || '';
    if (displaySubtextInput) displaySubtextInput.value = state.subtext || '';
    if (displayTelephoneInput) displayTelephoneInput.value = state.telephone || '';
    if (displayDescriptionInput) displayDescriptionInput.value = state.description || '';
    if (displayAlignSelect) displayAlignSelect.value = sanitizeDisplayAlign(state.align || 'left');
    if (displayButtonTextInput) displayButtonTextInput.value = state.buttonText || '';
  }

  function hasDisplayContent(displayState) {
    if (!displayState) return false;
    return !!(displayState.title || displayState.subtitle || displayState.description || displayState.subtext || displayState.telephone);
  }

  function renderFormDisplayBlock(displayState) {
    if (!hasDisplayContent(displayState)) return null;
    var align = sanitizeDisplayAlign(displayState.align);
    var block = document.createElement('div');
    block.className = 'form-display-block align-' + align;

    if (displayState.subtitle) {
      var subtitle = document.createElement('div');
      subtitle.className = 'form-display-subtitle';
      subtitle.textContent = displayState.subtitle;
      block.appendChild(subtitle);
    }

    if (displayState.title) {
      var title = document.createElement('h4');
      title.className = 'form-display-title';
      title.textContent = displayState.title;
      block.appendChild(title);
    }

    if (displayState.description) {
      var raw = String(displayState.description);
      var paragraphs = raw.split(/\n\s*\n/).map(function(p){ return (p || '').trim(); }).filter(Boolean);
      if (!paragraphs.length) paragraphs = [raw.trim()];
      paragraphs.forEach(function(text){
        var desc = document.createElement('p');
        desc.className = 'form-display-description';
        desc.textContent = text.replace(/\n+/g, ' ');
        block.appendChild(desc);
      });
    }

    if (displayState.subtext) {
      var subtext = document.createElement('div');
      subtext.className = 'form-display-subtext';
      subtext.textContent = displayState.subtext;
      block.appendChild(subtext);
    }

    if (displayState.telephone) {
      var tel = document.createElement('div');
      tel.className = 'form-display-telephone';
      tel.textContent = displayState.telephone;
      block.appendChild(tel);
    }
    return block;
  }

  function syncHeroFormDisplay(displayState, layoutChoice) {
    if (!siteFormPanel || !siteFormDisplay) return;
    var choice = layoutChoice || 'full-width';
    var isHorizontal = isHorizontalDesignLayout(choice);
    var isFullWidth = choice === 'full-width';
    var shouldShow = isHorizontal || isFullWidth;
    siteFormPanel.hidden = !shouldShow;
    siteFormPanel.classList.toggle('layout-full-width', isFullWidth);
    if (siteHero) siteHero.classList.toggle('form-display-left', isHorizontal);
    siteFormDisplay.innerHTML = '';
    if (!shouldShow) return;

    // Horizontal: Form Display copy goes in the hero left column (outside the form container).
    if (isHorizontal) {
      if (siteHeroDisplay) {
        siteHeroDisplay.innerHTML = '';
        var heroBlock = renderFormDisplayBlock(displayState);
        if (heroBlock) siteHeroDisplay.appendChild(heroBlock);
      }
      // Keep the form container fields-only.
      return;
    }

    // Full-width: clear left column copy.
    if (siteHeroDisplay) siteHeroDisplay.innerHTML = '';
    var block = renderFormDisplayBlock(displayState);
    if (block) {
      siteFormDisplay.appendChild(block);
    } else {
      var placeholder = document.createElement('div');
      placeholder.className = 'site-form-display-placeholder';
      placeholder.textContent = 'Form display copy will appear here when populated.';
      siteFormDisplay.appendChild(placeholder);
    }
  }

  function syncHeroContent(displayState) {
    if (!siteHeroDisplay) return;
    // Clear hero display to avoid duplicate Form Display rendering; form copy lives with the component.
    siteHeroDisplay.innerHTML = '';
  }

  function isHorizontalDesignLayout(value) {
    return value === 'horizontal-25-75' || value === 'horizontal-50-50';
  }

  function getHorizontalPreviewClass(value) {
    return value === 'horizontal-25-75' ? 'display-horizontal-25-75' : 'display-horizontal-50-50';
  }

  function injectDisplayBlock(previewEl, displayState, allowHorizontal, layoutChoice) {
    if (!previewEl) return { fieldsContainer: previewEl };
    previewEl.classList.remove('display-horizontal', 'display-horizontal-25-75', 'display-horizontal-50-50');
    var block = renderFormDisplayBlock(displayState);
    if (!block) return { fieldsContainer: previewEl };
    var shouldUseHorizontal = allowHorizontal && isHorizontalDesignLayout(layoutChoice);
    if (!shouldUseHorizontal) {
      previewEl.appendChild(block);
      return { fieldsContainer: previewEl };
    }

    var flexWrap = document.createElement('div');
    var layoutClass = 'layout-' + layoutChoice;
    flexWrap.className = 'form-display-flex ' + layoutClass;
    flexWrap.appendChild(block);
    var fieldColumn = document.createElement('div');
    fieldColumn.className = 'form-fields-flex';
    flexWrap.appendChild(fieldColumn);
    previewEl.classList.add('display-horizontal', getHorizontalPreviewClass(layoutChoice));
    previewEl.appendChild(flexWrap);
    return { fieldsContainer: fieldColumn };
  }

  function getDisplayButtonLabel(displayState) {
    var label = displayState && displayState.buttonText ? displayState.buttonText.trim() : '';
    return label || FORM_DISPLAY_DEFAULTS.buttonText;
  }

  function getStepAwareButtonLabel(layout, currentStep, maxSteps, displayState) {
    if (layout === 'wizard') {
      var total = Math.max(1, maxSteps || 1);
      var step = Math.min(Math.max(currentStep || 1, 1), total);
      if (step >= total) return getDisplayButtonLabel(displayState);
      return 'Next';
    }
    return getDisplayButtonLabel(displayState);
  }

  function ensureWizardUiState(maxSteps) {
    var total = Math.max(1, maxSteps || 1);
    while (wizardUiState.stepTitles.length < total) wizardUiState.stepTitles.push('Step ' + (wizardUiState.stepTitles.length + 1));
    while (wizardUiState.stepPrimaryLabels.length < total) wizardUiState.stepPrimaryLabels.push('');
    wizardUiState.stepTitles = wizardUiState.stepTitles.slice(0, total);
    wizardUiState.stepPrimaryLabels = wizardUiState.stepPrimaryLabels.slice(0, total);
    if (!wizardUiState.backLabel) wizardUiState.backLabel = 'Back';
  }

  function normalizeWizardUi(wizardUi, maxSteps) {
    var total = Math.max(1, maxSteps || 1);
    var src = wizardUi || wizardUiState || {};

    var titles = Array.isArray(src.stepTitles) ? src.stepTitles.slice() : [];
    var labels = Array.isArray(src.stepPrimaryLabels) ? src.stepPrimaryLabels.slice() : [];
    var backLabel = (typeof src.backLabel === 'string' ? src.backLabel : 'Back') || 'Back';

    while (titles.length < total) titles.push('Step ' + (titles.length + 1));
    while (labels.length < total) labels.push('');

    return {
      stepTitles: titles.slice(0, total),
      stepPrimaryLabels: labels.slice(0, total),
      backLabel: backLabel
    };
  }

  function buildWizardStepper(wizardNavEl, maxSteps, currentStep, stepTitles, onSelect) {
    if (!wizardNavEl) return;
    wizardNavEl.style.display = 'flex';
    wizardNavEl.innerHTML = '';
    var total = Math.max(1, maxSteps || 1);
    for (var s = 1; s <= total; s++) {
      (function(stepNum){
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'wizard-step' + (stepNum < currentStep ? ' complete' : '') + (stepNum === currentStep ? ' active' : '');
        btn.setAttribute('aria-current', stepNum === currentStep ? 'step' : 'false');

        var bar = document.createElement('div');
        bar.className = 'wizard-step-bar';
        btn.appendChild(bar);

        var kicker = document.createElement('div');
        kicker.className = 'wizard-step-kicker';
        kicker.textContent = 'Step ' + stepNum;
        btn.appendChild(kicker);

        var title = document.createElement('div');
        title.className = 'wizard-step-title';
        title.textContent = (stepTitles && stepTitles[stepNum - 1]) ? stepTitles[stepNum - 1] : ('Step ' + stepNum);
        btn.appendChild(title);

        btn.addEventListener('click', function(){
          if (typeof onSelect === 'function') onSelect(stepNum);
        });

        wizardNavEl.appendChild(btn);
      })(s);
    }
  }

  function renderWizardSettingsEditors(maxSteps) {
    if (!wizardSettingsGrid) return;
    ensureWizardUiState(maxSteps);
    wizardSettingsGrid.innerHTML = '';

    // Back label
    var backLabelWrap = document.createElement('label');
    backLabelWrap.setAttribute('for', 'wizard-back-label');
    backLabelWrap.textContent = 'Back button text';
    var backInput = document.createElement('input');
    backInput.id = 'wizard-back-label';
    backInput.type = 'text';
    backInput.placeholder = 'Back';
    backInput.value = wizardUiState.backLabel || 'Back';
    backInput.addEventListener('input', function(){
      wizardUiState.backLabel = backInput.value;
      renderPreview();
    });
    backLabelWrap.appendChild(backInput);
    wizardSettingsGrid.appendChild(backLabelWrap);

    // Step title + primary label for each step
    for (var i = 0; i < maxSteps; i++) {
      (function(idx){
        var titleLabel = document.createElement('label');
        titleLabel.setAttribute('for', 'wizard-step-title-' + (idx + 1));
        titleLabel.textContent = 'Step ' + (idx + 1) + ' title';
        var titleInput = document.createElement('input');
        titleInput.id = 'wizard-step-title-' + (idx + 1);
        titleInput.type = 'text';
        titleInput.placeholder = 'Step ' + (idx + 1);
        titleInput.value = wizardUiState.stepTitles[idx] || '';
        titleInput.addEventListener('input', function(){
          wizardUiState.stepTitles[idx] = titleInput.value;
          renderPreview();
        });
        titleLabel.appendChild(titleInput);
        wizardSettingsGrid.appendChild(titleLabel);

        var btnLabel = document.createElement('label');
        btnLabel.setAttribute('for', 'wizard-step-btn-' + (idx + 1));
        btnLabel.textContent = 'Step ' + (idx + 1) + ' button text';
        var btnInput = document.createElement('input');
        btnInput.id = 'wizard-step-btn-' + (idx + 1);
        btnInput.type = 'text';
        btnInput.placeholder = idx === (maxSteps - 1) ? 'Submit' : 'Next';
        btnInput.value = wizardUiState.stepPrimaryLabels[idx] || '';
        btnInput.addEventListener('input', function(){
          wizardUiState.stepPrimaryLabels[idx] = btnInput.value;
          renderPreview();
        });
        btnLabel.appendChild(btnInput);
        wizardSettingsGrid.appendChild(btnLabel);
      })(i);
    }
  }

  function getWizardPrimaryLabel(step, maxSteps, displayState, wizardUi) {
    var ui = normalizeWizardUi(wizardUi, maxSteps);
    var idx = Math.min(Math.max(step || 1, 1), maxSteps) - 1;
    var raw = (ui.stepPrimaryLabels[idx] || '').trim();
    if (raw) return raw;
    if (idx >= maxSteps - 1) return getDisplayButtonLabel(displayState);
    return 'Next';
  }

  function syncWizardButtons(kind, layout, currentStep, maxSteps, displayState, wizardUi) {
    var isWizard = layout === 'wizard';

    var footer = kind === 'preview' ? previewWizardFooter : (kind === 'inline' ? inlineWizardFooter : publishedWizardFooter);
    var backBtn = kind === 'preview' ? previewBackBtn : (kind === 'inline' ? inlineBackBtn : publishedBackBtn);
    var nextBtn = kind === 'preview' ? previewNextBtn : (kind === 'inline' ? inlineNextBtn : publishedNextBtn);
    var submitBtn = kind === 'preview' ? previewSubmitBtn : (kind === 'inline' ? inlineSubmitBtn : publishedSubmitBtn);

    if (footer) footer.style.display = isWizard ? 'flex' : 'none';
    if (submitBtn) submitBtn.style.display = isWizard ? 'none' : '';

    if (!isWizard) {
      if (submitBtn) updateButtonLabel(submitBtn, getDisplayButtonLabel(displayState));
      return;
    }

    var ui = normalizeWizardUi(wizardUi, maxSteps);
    if (backBtn) {
      backBtn.textContent = (ui.backLabel || 'Back').trim() || 'Back';
      backBtn.disabled = (currentStep || 1) <= 1;
    }
    if (nextBtn) {
      nextBtn.textContent = getWizardPrimaryLabel(currentStep, maxSteps, displayState, ui);
    }
  }

  function updateButtonLabel(buttonEl, label) {
    if (!buttonEl) return;
    buttonEl.textContent = label || FORM_DISPLAY_DEFAULTS.buttonText;
  }

  function syncPublishedButtonLabels() {
    var layout = publishedState ? publishedState.layout : 'single';
    var maxSteps = publishedState ? publishedState.maxSteps : 1;
    var displayState = publishedState ? publishedState.display : null;
    if (layout === 'wizard') {
      syncWizardButtons('inline', layout, inlineWizardStep, maxSteps, displayState, publishedState ? publishedState.wizardUi : null);
      syncWizardButtons('published', layout, publishedWizardStep, maxSteps, displayState, publishedState ? publishedState.wizardUi : null);
      return;
    }
    updateButtonLabel(inlineSubmitBtn, getStepAwareButtonLabel(layout, 1, maxSteps, displayState));
    updateButtonLabel(publishedSubmitBtn, getStepAwareButtonLabel(layout, 1, maxSteps, displayState));
  }

  var _restoreEmphasisOnElevated = null;
  function syncEmphasisPanelVisibility() {
    var containerStyle = designContainerStyleSelect ? (designContainerStyleSelect.value || 'elevated') : 'elevated';
    var isElevated = containerStyle === 'elevated';

    if (designEmphasisPanel) designEmphasisPanel.style.display = isElevated ? '' : 'none';

    if (!isElevated) {
      if (designEmphasisSelect) {
        var cur = (designEmphasisSelect.value || 'neutral');
        if (cur !== 'neutral') _restoreEmphasisOnElevated = cur;
        designEmphasisSelect.value = 'neutral';
      }
      applyDesignEmphasis('neutral');
      return;
    }

    if (designEmphasisSelect && _restoreEmphasisOnElevated) {
      if ((designEmphasisSelect.value || 'neutral') === 'neutral') {
        designEmphasisSelect.value = _restoreEmphasisOnElevated;
      }
      _restoreEmphasisOnElevated = null;
    }

    applyDesignEmphasis(designEmphasisSelect ? (designEmphasisSelect.value || 'neutral') : 'neutral');
  }

  function applyDesignSelections() {
    applyDesignColumnLayout(designColumnSelect ? designColumnSelect.value : 'full-width');
    applyDesignBackground(designBackgroundSelect ? designBackgroundSelect.value : 'default');
    applyDesignTheme(designThemeSelect ? designThemeSelect.value : 'light');
    applyDesignContainerStyle(designContainerStyleSelect ? designContainerStyleSelect.value : 'elevated');
    syncEmphasisPanelVisibility();
    applyDesignTypography(designTypeScaleSelect ? designTypeScaleSelect.value : 'default', designHeadingWeightSelect ? designHeadingWeightSelect.value : 'regular');
    applyDesignMotion(designMotionSelect ? designMotionSelect.value : 'subtle');
    applyDesignVisualClasses(null, false);
  }

  function getDesignPreviewClassString(designVisual) {
    var dv = designVisual || {
      buttonStyle: designButtonStyleSelect ? (designButtonStyleSelect.value || 'solid') : 'solid',
      buttonShape: designButtonShapeSelect ? (designButtonShapeSelect.value || 'rounded') : 'rounded',
      buttonWidth: designButtonWidthSelect ? (designButtonWidthSelect.value || 'default') : 'default',
      inputStyle: designInputStyleSelect ? (designInputStyleSelect.value || 'outlined') : 'outlined',
      inputRadius: designInputRadiusSelect ? (designInputRadiusSelect.value || 'standard') : 'standard',
      typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : 'default'
    };
    var cls = [];
    cls.push('btn-style-' + (dv.buttonStyle || 'solid'));
    cls.push('btn-shape-' + (dv.buttonShape || 'rounded'));
    cls.push('btn-width-' + (dv.buttonWidth || 'default'));
    cls.push('input-' + (dv.inputStyle || 'outlined'));
    cls.push('input-radius-' + (dv.inputRadius || 'standard'));
    cls.push('type-' + (dv.typeScale || 'default'));
    return cls.join(' ');
  }

  function getLiveDesignContainers() {
    var targets = [];
    if (siteHero) targets.push(siteHero);
    if (previewBox) targets.push(previewBox);
    return targets;
  }

  function getPublishedDesignContainers() {
    var targets = [];
    if (inlineWrap) targets.push(inlineWrap);
    if (publishedFormWrap) targets.push(publishedFormWrap);
    return targets;
  }

  function applyMappedClass(targets, removableClasses, classMap, choice, fallbackClass) {
    if (!targets || !targets.length) return;
    var key = (choice || '').toLowerCase();
    var addClass = classMap && classMap[key] ? classMap[key] : fallbackClass;
    targets.forEach(function(el){
      if (!el) return;
      (removableClasses || []).forEach(function(cls){ el.classList.remove(cls); });
      if (addClass) el.classList.add(addClass);
    });
  }

  function applyToggleClass(targets, removableClasses, addClass) {
    if (!targets || !targets.length) return;
    targets.forEach(function(el){
      if (!el) return;
      (removableClasses || []).forEach(function(cls){ el.classList.remove(cls); });
      if (addClass) el.classList.add(addClass);
    });
  }

  function applyDesignVisualClasses(designVisual, isPublished) {
    var dv = designVisual || {
      buttonStyle: designButtonStyleSelect ? (designButtonStyleSelect.value || 'solid') : 'solid',
      buttonShape: designButtonShapeSelect ? (designButtonShapeSelect.value || 'rounded') : 'rounded',
      buttonWidth: designButtonWidthSelect ? (designButtonWidthSelect.value || 'default') : 'default'
    };

    var targets = isPublished ? getPublishedDesignContainers() : (previewBox ? [previewBox] : []);
    if (!targets || !targets.length) return;

    var removable = [
      'btn-style-solid', 'btn-style-outline', 'btn-style-minimal',
      'btn-shape-rounded', 'btn-shape-pill', 'btn-shape-soft',
      'btn-width-default', 'btn-width-wide', 'btn-width-full'
    ];

    targets.forEach(function(el){
      if (!el) return;
      removable.forEach(function(cls){ el.classList.remove(cls); });
      el.classList.add('btn-style-' + (dv.buttonStyle || 'solid'));
      el.classList.add('btn-shape-' + (dv.buttonShape || 'rounded'));
      el.classList.add('btn-width-' + (dv.buttonWidth || 'default'));
    });
  }

  function applyPublishedDesignToContainers() {
    if (!publishedState) return;
    applyDesignVisualClasses(publishedState.designVisual || null, true);
    applyDesignTheme(publishedState.designTheme, true);
    applyDesignContainerStyle(publishedState.designContainerStyle, true);
    applyDesignEmphasis(publishedState.designEmphasis, true);
    var typography = publishedState.designTypography || {};
    applyDesignTypography(typography.typeScale || 'default', typography.headingWeight || 'regular', true);
    applyDesignMotion(publishedState.designMotion, true);
    applyDesignBackground(publishedState.designBackground, true);
  }

  function applyDesignTheme(value, isPublished) {
    var targets = isPublished ? getPublishedDesignContainers() : getLiveDesignContainers();
    var theme = (value || 'light').toLowerCase();
    applyMappedClass(
      targets,
      ['theme-light', 'theme-dark', 'theme-blue', 'theme-teal', 'theme-raspberry', 'theme-purple'],
      {
        light: 'theme-light',
        dark: 'theme-dark',
        blue: 'theme-blue',
        teal: 'theme-teal',
        raspberry: 'theme-raspberry',
        purple: 'theme-purple'
      },
      theme,
      'theme-light'
    );
  }

  function applyDesignContainerStyle(value, isPublished) {
    var targets = isPublished ? getPublishedDesignContainers() : getLiveDesignContainers();
    var choice = (value || 'flat').toLowerCase();
    applyMappedClass(
      targets,
      ['container-flat', 'container-elevated', 'container-outline'],
      { flat: 'container-flat', elevated: 'container-elevated', outline: 'container-outline' },
      choice,
      'container-flat'
    );
  }

  function applyDesignEmphasis(value, isPublished) {
    var targets = isPublished ? getPublishedDesignContainers() : getLiveDesignContainers();
    var choice = (value || 'neutral').toLowerCase();
    applyMappedClass(
      targets,
      ['emphasis-neutral', 'emphasis-primary', 'emphasis-subtle'],
      { neutral: 'emphasis-neutral', primary: 'emphasis-primary', subtle: 'emphasis-subtle' },
      choice,
      'emphasis-neutral'
    );
  }

  function applyDesignTypography(typeScale, headingWeight, isPublished) {
    var scale = (typeScale || 'default').toLowerCase();
    var weight = (headingWeight || 'regular').toLowerCase();
    var containers = isPublished ? getPublishedDesignContainers() : getLiveDesignContainers();

    applyToggleClass(containers, ['type-default', 'type-compact', 'type-spacious'], 'type-' + scale);
    applyToggleClass(containers, ['heading-regular', 'heading-bold'], 'heading-' + weight);

    // Keep the on-page form panel heading weight in sync for the hero module.
    if (!isPublished && siteFormPanel) {
      ['heading-regular', 'heading-bold'].forEach(function(cls){ siteFormPanel.classList.remove(cls); });
      siteFormPanel.classList.add('heading-' + weight);
    }
  }

  function applyDesignMotion(value, isPublished) {
    var targets = isPublished ? getPublishedDesignContainers() : getLiveDesignContainers();
    var choice = (value || 'subtle').toLowerCase();
    applyToggleClass(targets, ['motion-none', 'motion-subtle'], choice === 'none' ? 'motion-none' : 'motion-subtle');
  }

  function wireDesignPanelToggle(btn, body) {
    if (!btn || !body) return;
    btn.addEventListener('click', function(){
      var collapsed = body.classList.contains('collapsed');
      body.classList.toggle('collapsed', !collapsed);
      btn.setAttribute('aria-expanded', collapsed ? 'true' : 'false');
      btn.textContent = collapsed ? 'Collapse' : 'Expand';
    });
    body.classList.remove('collapsed');
    btn.setAttribute('aria-expanded', 'true');
    btn.textContent = 'Collapse';
  }

  function applyDesignColumnLayout(value) {
    if (!siteHero) return;
    var choice = value || 'full-width';
    var classes = ['layout-full-width', 'layout-horizontal-25-75', 'layout-horizontal-50-50'];
    classes.forEach(function(cls){ siteHero.classList.remove(cls); });
    var map = {
      'full-width': 'layout-full-width',
      'horizontal-25-75': 'layout-horizontal-25-75',
      'horizontal-50-50': 'layout-horizontal-50-50'
    };
    siteHero.classList.add(map[choice] || 'layout-full-width');
    syncHeroFormDisplay(getFormDisplayState(), choice);
  }

  function applyDesignBackground(value, isPublished) {
    var choice = value || 'default';

    // On-page module framing background.
    if (!isPublished && siteHero) {
      var heroClasses = ['hero-bg-default', 'hero-bg-gradient', 'hero-bg-trapezoid-bottom', 'hero-bg-trapezoid-top'];
      heroClasses.forEach(function(cls){ siteHero.classList.remove(cls); });
      var heroMap = {
        'default': 'hero-bg-default',
        'gradient': 'hero-bg-gradient',
        'trapezoid-bottom': 'hero-bg-trapezoid-bottom',
        'trapezoid-top': 'hero-bg-trapezoid-top'
      };
      siteHero.classList.add(heroMap[choice] || 'hero-bg-default');
    }

    // Builder preview / published wrappers use design-bg-*.
    var targets = isPublished ? getPublishedDesignContainers() : (previewBox ? [previewBox] : []);
    applyMappedClass(
      targets,
      ['design-bg-default', 'design-bg-gradient', 'design-bg-trapezoid-bottom', 'design-bg-trapezoid-top'],
      {
        'default': 'design-bg-default',
        'gradient': 'design-bg-gradient',
        'trapezoid-bottom': 'design-bg-trapezoid-bottom',
        'trapezoid-top': 'design-bg-trapezoid-top'
      },
      choice,
      'design-bg-default'
    );

    // Form panel stays a consistent card; the theme sits behind the module, not inside it.
    if (!isPublished && siteFormPanel) {
      siteFormPanel.classList.remove('form-panel-bg-default', 'form-panel-bg-gradient', 'form-panel-bg-trapezoid-bottom', 'form-panel-bg-trapezoid-top');
      siteFormPanel.classList.add('form-panel-bg-default');
    }
  }

  function syncPublishedDesignStateFromControls() {
    if (!publishedState) return;
    publishedState.designLayout = designColumnSelect ? (designColumnSelect.value || 'full-width') : (publishedState.designLayout || 'full-width');
    publishedState.designBackground = designBackgroundSelect ? (designBackgroundSelect.value || 'default') : (publishedState.designBackground || 'default');
    publishedState.designTheme = designThemeSelect ? (designThemeSelect.value || 'light') : (publishedState.designTheme || 'light');
    publishedState.designContainerStyle = designContainerStyleSelect ? (designContainerStyleSelect.value || 'elevated') : (publishedState.designContainerStyle || 'elevated');
    publishedState.designEmphasis = designEmphasisSelect ? (designEmphasisSelect.value || 'neutral') : (publishedState.designEmphasis || 'neutral');
    publishedState.designMotion = designMotionSelect ? (designMotionSelect.value || 'subtle') : (publishedState.designMotion || 'subtle');
    publishedState.designTypography = {
      typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : ((publishedState.designTypography && publishedState.designTypography.typeScale) || 'default'),
      headingWeight: designHeadingWeightSelect ? (designHeadingWeightSelect.value || 'regular') : ((publishedState.designTypography && publishedState.designTypography.headingWeight) || 'regular')
    };
    publishedState.designVisual = {
      buttonStyle: designButtonStyleSelect ? (designButtonStyleSelect.value || 'solid') : ((publishedState.designVisual && publishedState.designVisual.buttonStyle) || 'solid'),
      buttonShape: designButtonShapeSelect ? (designButtonShapeSelect.value || 'rounded') : ((publishedState.designVisual && publishedState.designVisual.buttonShape) || 'rounded'),
      buttonWidth: designButtonWidthSelect ? (designButtonWidthSelect.value || 'default') : ((publishedState.designVisual && publishedState.designVisual.buttonWidth) || 'default'),
      inputStyle: designInputStyleSelect ? (designInputStyleSelect.value || 'outlined') : ((publishedState.designVisual && publishedState.designVisual.inputStyle) || 'outlined'),
      inputRadius: designInputRadiusSelect ? (designInputRadiusSelect.value || 'standard') : ((publishedState.designVisual && publishedState.designVisual.inputRadius) || 'standard'),
      typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : ((publishedState.designVisual && publishedState.designVisual.typeScale) || 'default')
    };
  }

  function syncAutomationStateFromInputs() {
    automationState.enabled = !!(automationEnabled && automationEnabled.checked);
    automationState.assetPath = automationAsset ? (automationAsset.value || '').trim() : '';
    automationState.subject = automationSubject ? (automationSubject.value || '').trim() : '';
    automationState.body = automationEmailBody ? (automationEmailBody.value || '').trim() : '';
  }

  function setAutomationStatus(message) {
    if (!automationStatus) return;
    if (!message) {
      automationStatus.style.display = 'none';
      automationStatus.textContent = '';
      return;
    }
    automationStatus.style.display = '';
    automationStatus.textContent = message;
  }

  function renderAssetList() {
    if (!assetList) return;
    assetList.innerHTML = '';
    var groups = {};
    AEM_ASSET_LIBRARY.forEach(function(entry){
      var key = entry.group || 'Assets';
      if (!groups[key]) groups[key] = [];
      groups[key].push(entry);
    });
    Object.keys(groups).forEach(function(groupName){
      var groupWrap = document.createElement('div');
      groupWrap.className = 'existing-field-group';
      var heading = document.createElement('h5');
      heading.textContent = groupName;
      groupWrap.appendChild(heading);
      var list = document.createElement('div');
      list.className = 'existing-field-list';
      groups[groupName].forEach(function(entry){
        var item = document.createElement('div');
        item.className = 'existing-field-item';
        var details = document.createElement('div');
        details.className = 'existing-field-item-details';
        var title = document.createElement('span');
        title.className = 'existing-field-item-title';
        title.textContent = entry.title;
        var meta = document.createElement('span');
        meta.className = 'existing-field-item-meta';
        meta.textContent = entry.path;
        details.appendChild(title);
        details.appendChild(meta);
        item.appendChild(details);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-secondary';
        btn.textContent = 'Select';
        btn.addEventListener('click', function(){
          if (automationAsset) automationAsset.value = entry.path;
          syncAutomationStateFromInputs();
          closeAssetModal();
          setAutomationStatus('Selected: ' + entry.path);
        });
        item.appendChild(btn);
        list.appendChild(item);
      });
      groupWrap.appendChild(list);
      assetList.appendChild(groupWrap);
    });
  }

  function openAssetModal() {
    if (!assetModal) return;
    renderAssetList();
    assetModal.style.display = 'flex';
    assetModal.setAttribute('aria-hidden', 'false');
    setTimeout(function(){ if (assetModalClose) assetModalClose.focus(); }, 40);
  }

  function closeAssetModal() {
    if (!assetModal) return;
    assetModal.style.display = 'none';
    assetModal.setAttribute('aria-hidden', 'true');
  }

  function getCapturedEmailFrom(rootEl) {
    if (!rootEl) return '';
    var emailInput = rootEl.querySelector('input[type="email"]') || rootEl.querySelector('input[name="email"], input[name="business_email"], input[name="email_address"]');
    if (!emailInput) return '';
    return (emailInput.value || '').trim();
  }

  function maybeRunAutomation(kind) {
    syncAutomationStateFromInputs();
    if (!automationState.enabled) return;
    if (!automationState.assetPath) {
      setAutomationStatus('Enablement on, but no asset selected.');
      return;
    }
    var email = '';
    if (kind === 'preview') email = getCapturedEmailFrom(previewContainer);
    if (kind === 'inline') email = getCapturedEmailFrom(inlinePreview);
    if (kind === 'modal') email = getCapturedEmailFrom(publishedPreview);
    setAutomationStatus('Automation: would email ' + (email || '[captured email]') + ' → ' + automationState.assetPath);
  }

  function setRendererOpen(open) {
    if (!rendererOverlay) return;
    rendererOverlay.setAttribute('aria-hidden', open ? 'false' : 'true');
    if (open) {
      resetDialogBodyScroll();
      setTimeout(scrollActiveTabToTop, 0);
      setTimeout(scrollActiveTabToTop, 80);
      if (rendererPublishBtn) rendererPublishBtn.focus();
    }
  }

  function setPublishedModalOpen(open) {
    if (!publishedModal) return;
    publishedModal.classList.toggle('open', !!open);
    publishedModal.setAttribute('aria-hidden', open ? 'false' : 'true');
    if (open && publishedCloseBtn) publishedCloseBtn.focus();
  }

  function setCtaEnabled(enabled) {
    if (!siteCta) return;
    siteCta.classList.toggle('cta-disabled', !enabled);
    siteCta.setAttribute('aria-disabled', enabled ? 'false' : 'true');
    siteCta.tabIndex = enabled ? 0 : -1;
    if ('disabled' in siteCta) {
      try { siteCta.disabled = !enabled; } catch (e) {}
    }
  }

  function renderStateInto(previewEl, wizardNavEl, getStep, setStep, refreshFn) {
    if (!publishedState || !previewEl) return;
    var cfg = publishedState.config || [];
    var density = publishedState.density || 'density-standard';
    var layout = publishedState.layout || 'single';
    var maxSteps = publishedState.maxSteps || 3;
    var displayState = publishedState.display || null;
    var designLayoutChoice = publishedState.designLayout || 'full-width';
    var wizardUi = publishedState.wizardUi || null;
    var designVisual = publishedState.designVisual || null;

    previewEl.className = 'form-preview ' + density + ' layout-' + layout + ' ' + getDesignPreviewClassString(designVisual);
    if (publishedState && publishedState.experimentation) {
      previewEl.dataset.variantId = publishedState.experimentation.variantId || '';
      previewEl.dataset.ctaId = publishedState.experimentation.ctaId || '';
      previewEl.dataset.formInstanceUuid = publishedState.experimentation.formInstanceUuid || '';
    } else {
      previewEl.dataset.variantId = '';
      previewEl.dataset.ctaId = '';
      previewEl.dataset.formInstanceUuid = '';
    }
    if (publishedState && publishedState.accessibility && publishedState.accessibility.ariaLabel) {
      previewEl.setAttribute('aria-label', publishedState.accessibility.ariaLabel);
    } else {
      previewEl.removeAttribute('aria-label');
    }
    previewEl.innerHTML = '';

    // Published render: conditions should function, but no visible "Conditional field" badges/placeholders.
    previewConditionUiShowIndicator = false;
    previewConditionUiShowPlaceholder = false;
    previewConditionHideMode = 'collapse';

    // Rebuild conditional engine state for this render target.
    previewFieldRegistry = {};
    previewDependencyMap = {};

    injectHiddenMetadataInputs(previewEl, publishedState ? publishedState.hiddenMetadata : null);

    var allowHorizontalDisplay = layout !== 'wizard';
    var targetInfo = injectDisplayBlock(previewEl, displayState, allowHorizontalDisplay, designLayoutChoice);
    var fieldTarget = targetInfo.fieldsContainer || previewEl;

    var currentStep = typeof getStep === 'function' ? getStep() : 1;
    var resolvedStep = currentStep;
    if (layout === 'wizard') {
      currentStep = Math.min(Math.max(currentStep, 1), maxSteps);
      if (typeof setStep === 'function') setStep(currentStep);
      if (wizardNavEl) {
        var ui = normalizeWizardUi(wizardUi, maxSteps);
        buildWizardStepper(wizardNavEl, maxSteps, currentStep, ui.stepTitles, function(stepNum){
          if (typeof setStep === 'function') setStep(stepNum);
          if (typeof refreshFn === 'function') {
            refreshFn();
          } else {
            renderStateInto(previewEl, wizardNavEl, getStep, setStep);
          }
        });
      }
      cfg.forEach(function(item){
        if (!item || !item.show) return;
        var normalized = normalizeStep(item.step, maxSteps);
        if (normalized !== currentStep) return;
        var element = appendPreviewItem(item, fieldTarget, density, layout);
        handleRenderedPreviewField(item, element);
      });
      resolvedStep = currentStep;
    } else {
      if (wizardNavEl) {
        wizardNavEl.style.display = 'none';
        wizardNavEl.innerHTML = '';
      }
      cfg.forEach(function(item){
        if (!item || !item.show) return;
        var element = appendPreviewItem(item, fieldTarget, density, layout);
        handleRenderedPreviewField(item, element);
      });
      resolvedStep = 1;
    }

    // Enable conditional behavior in published Inline/Modal experiences.
    initializePreviewConditionEngine(cfg, { updateRequiredHiddenWarnings: false });

    var buttonLabel = layout === 'wizard'
      ? getWizardPrimaryLabel(resolvedStep, maxSteps, displayState, wizardUi)
      : getStepAwareButtonLabel(layout, 1, maxSteps, displayState);
    return { currentStep: resolvedStep, buttonLabel: buttonLabel };
  }

  function renderModalForm() {
    applyPublishedDesignToContainers();
    var result = renderStateInto(
      publishedPreview,
      publishedWizardNav,
      function(){ return publishedWizardStep; },
      function(val){ publishedWizardStep = val; },
      renderModalForm
    );
    var layout = publishedState ? publishedState.layout : 'single';
    var maxSteps = publishedState ? publishedState.maxSteps : 1;
    var displayState = publishedState ? publishedState.display : null;
    var publishedDisplayTop = document.getElementById('published-display-top');
    if (publishedDisplayTop) {
      publishedDisplayTop.innerHTML = '';
      if (layout === 'wizard' && publishedPreview) {
        var displayBlock = publishedPreview.querySelector('.form-display-block');
        if (displayBlock) {
          publishedDisplayTop.appendChild(displayBlock);
        }
      }
    }
    if (layout === 'wizard') {
      syncWizardButtons('published', layout, publishedWizardStep, maxSteps, displayState, publishedState ? publishedState.wizardUi : null);
    } else {
      var label = result ? result.buttonLabel : getStepAwareButtonLabel(layout, 1, maxSteps, displayState);
      updateButtonLabel(publishedSubmitBtn, label);
    }
  }

  function renderInlineForm() {
    applyPublishedDesignToContainers();
    var result = renderStateInto(
      inlinePreview,
      inlineWizardNav,
      function(){ return inlineWizardStep; },
      function(val){ inlineWizardStep = val; },
      renderInlineForm
    );
    var layout = publishedState ? publishedState.layout : 'single';
    var maxSteps = publishedState ? publishedState.maxSteps : 1;
    var displayState = publishedState ? publishedState.display : null;
    if (layout === 'wizard') {
      syncWizardButtons('inline', layout, inlineWizardStep, maxSteps, displayState, publishedState ? publishedState.wizardUi : null);
    } else {
      var label = result ? result.buttonLabel : getStepAwareButtonLabel(layout, 1, maxSteps, displayState);
      updateButtonLabel(inlineSubmitBtn, label);
    }
  }

  function refreshPublishTargets() {
    var capture = publishedState ? publishedState.capture : null;
    applyPublishedDesignToContainers();
    if (siteCta && siteCtaHelp) {
      if (!capture) {
        setCtaEnabled(true);
        siteCtaHelp.textContent = 'Opens the renderer. Publish with Capture pattern set to Modal/Drawer or Inline to wire the page.';
      } else if (capture === 'modal') {
        setCtaEnabled(true);
        siteCtaHelp.textContent = 'CTA opens the published form modal.';
      } else if (capture === 'inline') {
        setCtaEnabled(true);
        siteCtaHelp.textContent = 'Jumps to the embedded form below.';
      } else {
        setCtaEnabled(true);
        siteCtaHelp.textContent = 'Opens the renderer (Capture pattern "' + capture + '" is not wired to this CTA yet).';
      }
    }

    function mountInlineIntoHero(designLayout) {
      if (!inlineWrap || !siteFormPanel || !siteFormFields) return false;
      // For Inline capture, the form lives in the top module for both full-width and horizontal layouts.
      if (inlineWrap.parentElement !== siteFormFields) {
        siteFormFields.appendChild(inlineWrap);
      }
      siteFormFields.classList.add('inline-mounted');
      inlineWrap.hidden = false;
      if (siteInlineSlot) siteInlineSlot.hidden = true;
      siteFormPanel.hidden = false;
      return true;
    }

    function restoreInlineMount() {
      if (!inlineWrap || !inlineDefaultParent) return;
      if (inlineWrap.parentElement !== inlineDefaultParent) {
        if (inlineDefaultNextSibling && inlineDefaultNextSibling.parentNode === inlineDefaultParent) {
          inlineDefaultParent.insertBefore(inlineWrap, inlineDefaultNextSibling);
        } else {
          inlineDefaultParent.appendChild(inlineWrap);
        }
      }
      if (siteFormFields) siteFormFields.classList.remove('inline-mounted');
      if (siteInlineSlot) siteInlineSlot.hidden = false;
    }

    if (inlineWrap && inlinePlaceholder) {
      if (capture === 'inline' && publishedState) {
        var mountedInHero = mountInlineIntoHero(publishedState.designLayout);
        if (!mountedInHero) restoreInlineMount();
        inlineWrap.hidden = false;
        inlinePlaceholder.style.display = 'none';
        renderInlineForm();
      } else {
        restoreInlineMount();
        inlineWrap.hidden = true;
        inlinePlaceholder.style.display = 'block';
        var inlineMessage = 'Publish the renderer with Capture pattern set to Inline to embed the form here.';
        if (capture && capture !== 'inline') {
          inlineMessage = 'Current publish uses "' + capture + '". Switch to Inline and publish again to embed the form here.';
        }
        inlinePlaceholder.textContent = inlineMessage;
        if (inlinePreview) inlinePreview.innerHTML = '';
        if (inlineWizardNav) {
          inlineWizardNav.innerHTML = '';
          inlineWizardNav.style.display = 'none';
        }
        inlineWizardStep = 1;
      }
    }
  }

  function publishRendererAndClose() {
    // Validate current configuration before publishing.
    try { renderPreview(); } catch (e) {}
    var currentCfg = getConfigFromUI();
    var report = getRendererValidationReport(currentCfg);
    if (report && report.errors && report.errors.length) {
      showRendererBanner('Cannot publish: ' + report.errors.join(' '), { sticky: true });
      return;
    }
    if (report && report.warnings && report.warnings.length) {
      showRendererBanner('Publish warning: ' + report.warnings.join(' '));
    }
    // capture the state at publish-time so the site CTA reflects what was chosen
    var captureSelect = document.getElementById('exp-capture');
    var capture = captureSelect ? captureSelect.value : 'inline';
    var displayState = getFormDisplayState();
    var formInstanceUuid = generateUuidV4();
    publishedState = {
      capture: capture,
      config: getConfigFromUI(),
      density: densitySelect ? densitySelect.value : 'density-standard',
      layout: layoutSelect ? layoutSelect.value : 'single',
      maxSteps: parseInt(numStepsSelect && numStepsSelect.value, 10) || 3,
      layoutSettings: {
        validate: wizardValidateSelect ? (wizardValidateSelect.value || 'per-field') : 'per-field',
        navigation: wizardNavigationSelect ? (wizardNavigationSelect.value || 'stepper') : 'stepper'
      },
      designLayout: designColumnSelect ? designColumnSelect.value : 'full-width',
      designBackground: designBackgroundSelect ? designBackgroundSelect.value : 'default',
      designTheme: designThemeSelect ? (designThemeSelect.value || 'light') : 'light',
      designContainerStyle: designContainerStyleSelect ? (designContainerStyleSelect.value || 'elevated') : 'elevated',
      designEmphasis: designEmphasisSelect ? (designEmphasisSelect.value || 'neutral') : 'neutral',
      designMotion: designMotionSelect ? (designMotionSelect.value || 'subtle') : 'subtle',
      designTypography: {
        typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : 'default',
        headingWeight: designHeadingWeightSelect ? (designHeadingWeightSelect.value || 'regular') : 'regular'
      },
      designVisual: {
        buttonStyle: designButtonStyleSelect ? (designButtonStyleSelect.value || 'solid') : 'solid',
        buttonShape: designButtonShapeSelect ? (designButtonShapeSelect.value || 'rounded') : 'rounded',
        buttonWidth: designButtonWidthSelect ? (designButtonWidthSelect.value || 'default') : 'default',
        inputStyle: designInputStyleSelect ? (designInputStyleSelect.value || 'outlined') : 'outlined',
        inputRadius: designInputRadiusSelect ? (designInputRadiusSelect.value || 'standard') : 'standard',
        typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : 'default'
      },
      display: displayState,
      routing: Object.assign({}, formMetaState),
      hiddenMetadata: (getAllHiddenMetadataItems() || []).map(function(it){
        return {
          context: it.context || 'marketing',
          key: it.key || '',
          value: it.value || '',
          source: it.source || 'manual',
          lookupKey: it.lookupKey || ''
        };
      }).filter(function(it){
        if (!it || !(it.key || '').trim()) return false;
        if ((it.source || 'manual') === 'manual') return !!(it.value || '').trim();
        return !!(it.lookupKey || '').trim();
      }),
      accessibility: getAccessibilityState(),
      experimentation: getExperimentationHooksState(formInstanceUuid)
    };
    if (hooksFormUuidInput) hooksFormUuidInput.value = formInstanceUuid;
    if (publishedState.layout === 'wizard') {
      ensureWizardUiState(publishedState.maxSteps);
      publishedState.wizardUi = normalizeWizardUi(null, publishedState.maxSteps);
    }
    publishedWizardStep = 1;
    inlineWizardStep = 1;
    refreshPublishTargets();
    syncPublishedButtonLabels();
    setRendererOpen(false);
  }

  if (rendererCloseBtn) {
    rendererCloseBtn.addEventListener('click', function(){
      setRendererOpen(false);
    });
  }
  if (rendererPublishBtn) {
    rendererPublishBtn.addEventListener('click', function(){
      publishRendererAndClose();
    });
  }

  if (siteCta) {
    siteCta.addEventListener('click', function(e){
      e.preventDefault();
      if (publishedState && publishedState.capture === 'modal') {
        renderModalForm();
        setPublishedModalOpen(true);
        return;
      }
      if (publishedState && publishedState.capture === 'inline') {
        if (inlineWrap && !inlineWrap.hidden && typeof inlineWrap.scrollIntoView === 'function') {
          scrollToElementTop(inlineWrap, 'smooth');
          return;
        }
      }
      setRendererOpen(true);
    });
  }

  if (publishedCloseBtn) {
    publishedCloseBtn.addEventListener('click', function(){
      setPublishedModalOpen(false);
    });
  }
  if (publishedModal) {
    publishedModal.addEventListener('click', function(e){
      if (e.target === publishedModal) setPublishedModalOpen(false);
    });
  }

  if (inlineOpenBtn) {
    inlineOpenBtn.addEventListener('click', function(){
      setRendererOpen(true);
    });
  }

  if (siteOpenRendererBtn) {
    siteOpenRendererBtn.addEventListener('click', function(){
      setRendererOpen(true);
    });
  }

  if (siteOpenCtaRendererBtn) {
    siteOpenCtaRendererBtn.addEventListener('click', function(){
      prefillCtaRendererUiFromMarquee();
      setCtaRendererOpen(true);
    });
  }
  if (ctaCloseBtn) {
    ctaCloseBtn.addEventListener('click', function(){
      setCtaRendererOpen(false);
    });
  }
  if (ctaOverlay) {
    ctaOverlay.addEventListener('click', function(e){
      if (e.target === ctaOverlay) setCtaRendererOpen(false);
    });
  }
  if (ctaActionSelect) {
    ctaActionSelect.addEventListener('change', syncCtaRendererUi);
  }
  if (ctaApplyBtn) {
    ctaApplyBtn.addEventListener('click', function(){
      applyCtaToMarquee();
    });
  }
  if (ctaDoneBtn) {
    ctaDoneBtn.addEventListener('click', function(){
      var ok = applyCtaToMarquee();
      if (ok) setCtaRendererOpen(false);
    });
  }
  if (ctaResetBtn) {
    ctaResetBtn.addEventListener('click', function(){
      resetCtaRendererUi();
    });
  }

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
      if (publishedModal && publishedModal.classList.contains('open')) {
        setPublishedModalOpen(false);
        return;
      }
    }
  });

  refreshPublishTargets();

  // Template definitions (same as original)
  var templates = {
    contact: [
      { type:'field', id:'firstName',  html:'first_name',  label:'First name',           width:'half', show:true, required:true,  placeholder:'Enter your first name', help:'', step:1, fieldType:'text' },
      { type:'field', id:'lastName',   html:'last_name',   label:'Last name',            width:'half', show:true, required:true,  placeholder:'Enter your last name', help:'', step:1, fieldType:'text' },
      { type:'field', id:'email',      html:'email',       label:'Business email',       width:'full', show:true, required:true,  placeholder:'name@company.com', help:'We’ll send follow-up details here.', step:1, fieldType:'email' },
      { type:'field', id:'phone',      html:'telephone',   label:'Telephone',            width:'half', show:true, required:false, placeholder:'+1 555 555 5555', help:'Include country code if outside US.', step:2, fieldType:'text' },
      { type:'field', id:'company',    html:'company',     label:'Company',              width:'half', show:true, required:false, placeholder:'Your organization', help:'', step:2, fieldType:'text' },
      { type:'field', id:'country',    html:'country',     label:'Country',              width:'half', show:true, required:false, placeholder:'Select your country', help:'', step:2, fieldType:'dropdown', options:['Select…','United States','Canada','Brazil','Other'], lockOptions:true },
      { type:'field', id:'state',      html:'state',       label:'State / Region',       width:'half', show:true, required:false, placeholder:'Select your state', help:'', step:2, fieldType:'dropdown', options:['Select…','California','New York','Texas','Other'], lockOptions:true },
      { type:'field', id:'message',    html:'message',     label:'How can we help you?', width:'full', show:true, required:false, placeholder:'Add details about your request', help:'Share any context for your request.', step:3, fieldType:'textarea' },
      { type:'field', id:'optIn',      html:'email_optin', label:'I’d like to receive email updates.', width:'full', show:true, required:false, placeholder:'', help:'', step:3, fieldType:'consent' }
      ,{ type:'field', id:'naConsent', html:'na_consent',  label:'I agree to the Experian Business Privacy Policy and Terms and consent to being contacted about my request.', width:'full', show:true, required:true, placeholder:'', help:'North America consent statement (required).', step:3, fieldType:'consent' }
    ],
    download: [
      { type:'field', id:'firstName',  html:'first_name',  label:'First name',           width:'half', show:true, required:true,  placeholder:'Enter your first name', help:'', step:1, fieldType:'text' },
      { type:'field', id:'lastName',   html:'last_name',   label:'Last name',            width:'half', show:true, required:true,  placeholder:'Enter your last name', help:'', step:1, fieldType:'text' },
      { type:'field', id:'email',      html:'email',       label:'Business email',       width:'full', show:true, required:true,  placeholder:'name@company.com', help:'We’ll send the download link here.', step:1, fieldType:'email' },
      { type:'field', id:'company',    html:'company',     label:'Company',              width:'full', show:true, required:false, placeholder:'Your organization', help:'', step:2, fieldType:'text' },
      { type:'field', id:'country',    html:'country',     label:'Country',              width:'half', show:true, required:false, placeholder:'Select your country', help:'', step:2, fieldType:'dropdown', options:['Select…','United States','Canada','Brazil','Other'], lockOptions:true },
      { type:'field', id:'optIn',      html:'email_optin', label:'I’d like to receive email updates.', width:'full', show:true, required:false, placeholder:'', help:'', step:2, fieldType:'consent' },
      { type:'field', id:'naConsent', html:'na_consent',  label:'I agree to the Experian Business Privacy Policy and Terms and consent to being contacted about my request.', width:'full', show:true, required:true, placeholder:'', help:'North America consent statement (required).', step:2, fieldType:'consent' }
    ]
  };

  var templateMetaDefaults = {
    contact: {
      eloquaName: 'Contact / Inquiry (Base Template)',
      salesforceCampaignId: '7013X000000Contact',
      salesforceNotes: 'Route to NA BIS contact queue',
      recipientEmail: 'leads@experian.com',
      notificationSubject: 'Experian Business inquiry received'
    },
    download: {
      eloquaName: 'Download (Gated Asset) (Base Template)',
      salesforceCampaignId: '7013X000000Download',
      salesforceNotes: 'Trigger nurture follow-up for download request',
      recipientEmail: 'leads@experian.com',
      notificationSubject: 'Experian download request ready'
    }
  };

  var EXISTING_FIELD_LIBRARY = [
    { group: 'Standard', id: 'firstName',  html: 'first_name',  label: 'First name',           width: 'half', fieldType: 'text',       placeholder: 'Enter first name',      required: true,  help: '', options: [] },
    { group: 'Standard', id: 'lastName',   html: 'last_name',   label: 'Last name',            width: 'half', fieldType: 'text',       placeholder: 'Enter last name',       required: true,  help: '', options: [] },
    { group: 'Standard', id: 'email',      html: 'email',       label: 'Business email',       width: 'full', fieldType: 'email',      placeholder: 'name@company.com',      required: true,  help: 'Used for follow-up communications.', options: [] },
    { group: 'Standard', id: 'phone',      html: 'telephone',   label: 'Telephone',            width: 'half', fieldType: 'text',       placeholder: '+1 555 555 5555',       required: false, help: 'Include country code if outside US.', options: [] },
    { group: 'Standard', id: 'company',    html: 'company',     label: 'Company',              width: 'half', fieldType: 'text',       placeholder: 'Your organization',     required: false, help: '', options: [] },
    { group: 'Standard', id: 'jobTitle',   html: 'job_title',   label: 'Job title',            width: 'half', fieldType: 'text',       placeholder: 'Your role',             required: false, help: '', options: [] },
    { group: 'Standard', id: 'country',    html: 'country',     label: 'Country',              width: 'half', fieldType: 'dropdown',   placeholder: '',                       required: false, help: '', options: ['Select…','United States','Canada','Brazil','Other'], lockOptions: true },
    { group: 'Standard', id: 'state',      html: 'state',       label: 'State / Region',       width: 'half', fieldType: 'dropdown',   placeholder: '',                       required: false, help: '', options: ['Select…','California','New York','Texas','Other'], lockOptions: true },
    { group: 'Standard', id: 'message',    html: 'message',     label: 'Message',              width: 'full', fieldType: 'textarea',   placeholder: 'Add details about your request', required: false, help: '', options: [] },
    { group: 'Standard', id: 'optIn',      html: 'email_optin', label: 'Email opt-in',         width: 'full', fieldType: 'consent',    placeholder: '',                       required: false, help: '', options: [] },
    { group: 'Standard', id: 'naConsent',  html: 'na_consent',  label: 'NA consent statement', width: 'full', fieldType: 'consent',    placeholder: '',                       required: true,  help: 'North America consent statement (required).', options: [] },
    { group: 'Custom Fields', id: 'productInterest', html: 'product_interest', label: 'Product of interest', width:'full', fieldType:'dropdown', placeholder:'Select a product', required:false, help:'Used by BU demand gen team.', options:['Credit Monitoring','Fraud Detection','Compliance Suite'] },
    { group: 'Custom Fields', id: 'priorityLevel', html: 'priority_level', label: 'Sales priority level', width:'half', fieldType:'dropdown', placeholder:'Select priority', required:false, help:'Internal scoring hint.', options:['Hot','Warm','Cold'] },
    { group: 'Custom Fields', id: 'regionOwner', html: 'region_owner', label: 'Target region owner', width:'half', fieldType:'dropdown', placeholder:'Region', required:false, help:'Routes to territory managers.', options:['North America','LATAM','EMEA','APAC'] },
    { group: 'Custom Fields', id: 'campaignSource', html: 'campaign_source_detail', label: 'Campaign source detail', width:'full', fieldType:'text', placeholder:'Describe source/campaign', required:false, help:'Free text notes passed to CRM.', options: [] }
  ];

  var OTHER_NAMES = Array.from({length:50}, function(_,i){ return 'other' + (i+1); });

  function getNextAvailableOtherHtmlName(excludeId) {
    var used = getUsedHtmlNames(excludeId);
    for (var i = 0; i < OTHER_NAMES.length; i++) {
      if (!used[OTHER_NAMES[i]]) return OTHER_NAMES[i];
    }
    return '';
  }

  var fieldConfigContainer = document.getElementById('field-config');
  var previewBox = document.querySelector('.preview-box');
  var previewContainer = document.getElementById('preview');
  var previewFieldRegistry = {};
  var previewDependencyMap = {};
  var previewConditionEngineUpdateWarnings = true;
  var previewConditionUiShowIndicator = true;
  var previewConditionUiShowPlaceholder = true;
  // 'placeholder' = hide inner + show placeholder; 'collapse' = hide entire field wrapper
  var previewConditionHideMode = 'placeholder';
  var layoutTag = document.getElementById('layout-tag');
  var templateSelect = document.getElementById('form-template');
  var densitySelect = document.getElementById('density');
  var layoutSelect = document.getElementById('layoutType');
  function getSelectedLayout() {
    return layoutSelect && layoutSelect.value ? layoutSelect.value : 'single';
  }
  var numStepsGroup = document.getElementById('numStepsGroup');
  var numStepsSelect = document.getElementById('numSteps');
  var wizardNav = document.getElementById('wizard-nav');
  var refreshBtn = document.getElementById('refresh');
  var addExistingFieldBtn = document.getElementById('add-existing-field');
  var addFieldBtn = document.getElementById('add-field');
  var addTextBtn = document.getElementById('add-text');
  var fieldPanelToggle = document.getElementById('field-panel-toggle');
  var fieldPanelBody = document.getElementById('field-panel-body');
  var livePreviewToggle = document.getElementById('live-preview-toggle');
  var livePreviewBody = document.getElementById('live-preview-body');
  var existingFieldModal = document.getElementById('existing-field-modal');
  var existingFieldList = document.getElementById('existing-field-list');
  var existingFieldModalClose = document.getElementById('existing-field-modal-close');
  var FORM_META_KEYS = ['eloquaName','salesforceCampaignId','salesforceNotes','recipientEmail','notificationSubject'];
  var metaInputs = {
    eloquaName: document.getElementById('meta-eloqua-input'),
    salesforceCampaignId: document.getElementById('meta-salesforce-campaign-input'),
    salesforceNotes: document.getElementById('meta-salesforce-notes-input'),
    recipientEmail: document.getElementById('meta-recipient-email-input'),
    notificationSubject: document.getElementById('meta-notification-input')
  };
  var metaChipLists = {
    eloquaName: document.getElementById('meta-eloqua-chips'),
    salesforceCampaignId: document.getElementById('meta-salesforce-campaign-chips'),
    salesforceNotes: document.getElementById('meta-salesforce-notes-chips'),
    recipientEmail: document.getElementById('meta-recipient-email-chips'),
    notificationSubject: document.getElementById('meta-notification-chips')
  };
  var formMetaState = {
    eloquaName: '',
    salesforceCampaignId: '',
    salesforceNotes: '',
    recipientEmail: '',
    notificationSubject: ''
  };

  // Hidden Metadata (key/value pairs grouped by context)
  var hiddenMetaContext = document.getElementById('hidden-meta-context');
  var hiddenMetaKey = document.getElementById('hidden-meta-key');
  var hiddenMetaValue = document.getElementById('hidden-meta-value');
  var hiddenMetaAddBtn = document.getElementById('hidden-meta-add-btn');
  var hiddenMetaGroups = document.getElementById('hidden-meta-groups');

  // New Hidden Metadata UI (request context + custom chips)
  var captureUtmsToggle = document.getElementById('capture-utms');
  var captureReferrerToggle = document.getElementById('capture-referrer');

  var reqUtmSource = document.getElementById('req-utm-source');
  var reqUtmMedium = document.getElementById('req-utm-medium');
  var reqUtmCampaign = document.getElementById('req-utm-campaign');
  var reqUtmTerm = document.getElementById('req-utm-term');
  var reqUtmContent = document.getElementById('req-utm-content');
  var reqGclid = document.getElementById('req-gclid');
  var reqMsclkid = document.getElementById('req-msclkid');
  var reqFbclid = document.getElementById('req-fbclid');
  var reqReferrer = document.getElementById('req-referrer');

  var customMetaContext = document.getElementById('custom-meta-context');
  var customMetaKey = document.getElementById('custom-meta-key');
  var customMetaSource = document.getElementById('custom-meta-source');
  var customMetaValue = document.getElementById('custom-meta-value');
  var customMetaLookupKey = document.getElementById('custom-meta-lookup-key');
  var customMetaValueWrap = document.getElementById('custom-meta-value-wrap');
  var customMetaLookupWrap = document.getElementById('custom-meta-lookup-wrap');
  var customMetaAddBtn = document.getElementById('custom-meta-add-btn');
  var customMetaGroups = document.getElementById('custom-meta-groups');

  // Page context override controls
  var ctxBuSource = document.getElementById('ctx-bu-source');
  var ctxBuLookupKey = document.getElementById('ctx-bu-lookup-key');
  var ctxAssetSource = document.getElementById('ctx-asset-source');
  var ctxAssetLookupKey = document.getElementById('ctx-asset-lookup-key');
  var ctxAssetManual = document.getElementById('ctx-asset-manual');

  // Custom hidden metadata entries (manual/lookup)
  var hiddenMetadataState = [];

  var hiddenCaptureState = {
    utms: true,
    referrer: true
  };

  var HIDDEN_META_CONTEXTS = [
    { id: 'marketing', label: 'Marketing (UTM)' },
    { id: 'campaign', label: 'Campaign' },
    { id: 'content', label: 'Content' },
    { id: 'product', label: 'Product' },
    { id: 'integration', label: 'Integration' },
    { id: 'other', label: 'Other' }
  ];

  function normalizeHiddenMetaContext(value) {
    var v = (value || '').trim();
    for (var i = 0; i < HIDDEN_META_CONTEXTS.length; i++) {
      if (HIDDEN_META_CONTEXTS[i].id === v) return v;
    }
    return 'marketing';
  }

  function normalizeHiddenMetaSource(value) {
    var v = (value || 'manual').trim();
    var allowed = {
      manual: true,
      lookup_page_property: true,
      lookup_page_tags: true,
      lookup_data_layer: true,
      lookup_url_param: true
    };
    return allowed[v] ? v : 'manual';
  }

  function getHiddenMetaSourceLabel(src) {
    var map = {
      manual: 'Manual',
      lookup_page_property: 'Lookup (page property)',
      lookup_page_tags: 'Lookup (page tags)',
      lookup_data_layer: 'Lookup (data layer)',
      lookup_url_param: 'Lookup (URL param)'
    };
    return map[src] || 'Manual';
  }

  function getHiddenMetaChipValueText(item) {
    if (!item) return '';
    var src = normalizeHiddenMetaSource(item.source);
    if (src === 'manual') return (item.value || '');
    var lk = (item.lookupKey || '').trim();
    return getHiddenMetaSourceLabel(src) + (lk ? (': ' + lk) : '');
  }

  function renderCustomHiddenMetadataGroups() {
    var target = customMetaGroups || hiddenMetaGroups;
    if (!target) return;
    target.innerHTML = '';

    if (!Array.isArray(hiddenMetadataState) || !hiddenMetadataState.length) {
      var empty = document.createElement('div');
      empty.className = 'hidden-meta-empty';
      empty.textContent = 'No custom metadata added.';
      target.appendChild(empty);
      return;
    }

    HIDDEN_META_CONTEXTS.forEach(function(ctx){
      var items = hiddenMetadataState.filter(function(it){ return it && it.context === ctx.id; });
      if (!items.length) return;

      var group = document.createElement('div');
      group.className = 'hidden-meta-group';

      var title = document.createElement('div');
      title.className = 'hidden-meta-group-title';
      title.textContent = ctx.label;
      group.appendChild(title);

      items.forEach(function(item){
        var chip = document.createElement('span');
        chip.className = 'meta-chip';

        var label = document.createElement('span');
        label.textContent = (item.key || '') + ': ' + getHiddenMetaChipValueText(item);

        var remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'meta-chip-remove';
        remove.setAttribute('aria-label', 'Remove ' + (item.key || 'metadata'));
        remove.textContent = '✕';
        remove.addEventListener('click', function(){
          hiddenMetadataState = (hiddenMetadataState || []).filter(function(it){
            return !(it && it.context === item.context && it.key === item.key);
          });
          renderCustomHiddenMetadataGroups();
          renderPreview();
          scheduleHistorySnapshot();
        });

        chip.appendChild(label);
        chip.appendChild(remove);
        group.appendChild(chip);
      });

      target.appendChild(group);
    });
  }

  function syncCustomMetaValueUi() {
    var src = normalizeHiddenMetaSource(customMetaSource ? customMetaSource.value : 'manual');
    var isManual = src === 'manual';
    if (customMetaValueWrap) customMetaValueWrap.style.display = isManual ? '' : 'none';
    if (customMetaLookupWrap) customMetaLookupWrap.style.display = isManual ? 'none' : '';
    if (customMetaValue) {
      customMetaValue.disabled = !isManual;
      if (!isManual) customMetaValue.value = '';
    }
    if (customMetaLookupKey) {
      customMetaLookupKey.disabled = isManual;
      if (isManual) customMetaLookupKey.value = '';
    }
  }

  function addCustomHiddenMetadataFromInputs() {
    var context = normalizeHiddenMetaContext(customMetaContext ? customMetaContext.value : 'marketing');
    var key = (customMetaKey ? (customMetaKey.value || '') : '').trim();
    var src = normalizeHiddenMetaSource(customMetaSource ? customMetaSource.value : 'manual');
    var value = (customMetaValue ? (customMetaValue.value || '') : '').trim();
    var lookupKey = (customMetaLookupKey ? (customMetaLookupKey.value || '') : '').trim();

    if (!key) return;
    if (src === 'manual') {
      if (!value) return;
    } else {
      if (!lookupKey) return;
    }

    var updated = false;
    hiddenMetadataState = (hiddenMetadataState || []).map(function(it){
      if (!it) return it;
      if (it.context === context && it.key === key) {
        updated = true;
        return { context: context, key: key, source: src, value: value, lookupKey: lookupKey };
      }
      return it;
    });
    if (!updated) hiddenMetadataState.push({ context: context, key: key, source: src, value: value, lookupKey: lookupKey });

    if (customMetaKey) customMetaKey.value = '';
    if (customMetaValue) customMetaValue.value = '';
    if (customMetaLookupKey) customMetaLookupKey.value = '';
    renderCustomHiddenMetadataGroups();
    renderPreview();
    scheduleHistorySnapshot();
  }

  function setRequestPreviewInputsEnabled(enabledUtms, enabledReferrer) {
    var utmVal = enabledUtms ? 'Auto (URL param)' : 'Not captured';
    var refVal = enabledReferrer ? 'Auto (document.referrer)' : 'Not captured';
    [reqUtmSource, reqUtmMedium, reqUtmCampaign, reqUtmTerm, reqUtmContent, reqGclid, reqMsclkid, reqFbclid].forEach(function(el){
      if (!el) return;
      el.value = utmVal;
    });
    if (reqReferrer) reqReferrer.value = refVal;
  }

  function getRequestContextHiddenMetadataItems() {
    var items = [];
    if (hiddenCaptureState.utms) {
      ['utm_source','utm_medium','utm_campaign','utm_term','utm_content','gclid','msclkid','fbclid'].forEach(function(k){
        items.push({ context: 'marketing', key: k, source: 'lookup_url_param', lookupKey: k, value: '' });
      });
    }
    if (hiddenCaptureState.referrer) {
      items.push({ context: 'marketing', key: 'referrer', source: 'lookup_data_layer', lookupKey: 'document.referrer', value: '' });
    }
    return items;
  }

  function getAllHiddenMetadataItems() {
    var custom = Array.isArray(hiddenMetadataState) ? hiddenMetadataState.slice() : [];
    return getRequestContextHiddenMetadataItems().concat(custom);
  }

  function injectHiddenMetadataInputs(container, metadata) {
    if (!container) return;
    if (!Array.isArray(metadata) || !metadata.length) return;
    var wrap = document.createElement('div');
    wrap.className = 'hidden-metadata-inputs';
    metadata.forEach(function(item){
      if (!item) return;
      var key = (item.key || '').trim();
      if (!key) return;
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = (item.value || '');
      input.setAttribute('data-hidden-metadata-context', item.context || '');
      if (item.source) input.setAttribute('data-hidden-metadata-source', item.source);
      if (item.lookupKey) input.setAttribute('data-hidden-metadata-lookup-key', item.lookupKey);
      wrap.appendChild(input);
    });
    container.appendChild(wrap);
  }

  // properties form elements (used inline under fields only)
  var propertiesForm = document.getElementById('properties-form');
  var propLabel = document.getElementById('prop-label');
  var propHtml = document.getElementById('prop-html');
  var propHtmlReadOnly = document.getElementById('prop-html-readonly');
  var propPlaceholder = document.getElementById('prop-placeholder');
  var propHelp = document.getElementById('prop-help');
  var propType = document.getElementById('prop-type');
  var propTypeReadOnly = document.getElementById('prop-type-readonly');
  var propWidth = document.getElementById('prop-width');
  var propConditionAction = document.getElementById('prop-condition-action');
  var propConditionActionRow = document.querySelector('.condition-action-row');
  var propConditionsSection = document.getElementById('prop-conditions-section');
  var propConditionToggle = document.getElementById('prop-condition-toggle');
  var propConditionHelper = document.getElementById('prop-condition-helper');
  var propConditionError = document.getElementById('prop-condition-error');
  var propHidden = document.getElementById('prop-hidden');
  var CONDITION_LIMIT = 5;
  var CONDITION_FIELD_TYPES = ['dropdown','multiselect','radio','checkbox','consent'];
  var CONDITION_OPERATORS = [
    { value: 'is', label: 'Is' },
    { value: 'is blank', label: 'Is blank' },
    { value: 'is not', label: 'Is not' }
  ];
  var CONDITION_CONNECTORS = [
    { value: 'and', label: 'And' },
    { value: 'or', label: 'Or' }
  ];
  // Replace old text-size with new font-size
  var propFontSize = document.getElementById('prop-font-size');
  var propAlign = document.getElementById('prop-align');
  var propUrl = document.getElementById('prop-url');
  var propHiddenLabel = document.querySelector('label > input#prop-hidden') ? document.querySelector('label > input#prop-hidden').parentElement : null;
  var propRequired = document.getElementById('prop-required');
  var propOptionsWrapper = document.getElementById('prop-options-wrapper');
  var propOptionsList = document.getElementById('prop-options-list');
  var propAddOption = document.getElementById('prop-add-option');
  var propApply = document.getElementById('prop-apply');
  var propConditionsList = document.getElementById('prop-conditions-list');
  var propAddCondition = document.getElementById('prop-add-condition');
  var propStep = document.getElementById('prop-step');
  // cache labels for toggling visibility
  var propStepLabel = document.querySelector('label[for="prop-step"]');
  var propHtmlLabel = document.querySelector('label[for="prop-html"]');
  var propPlaceholderLabel = document.querySelector('label[for="prop-placeholder"]');
  var propHelpLabel = document.querySelector('label[for="prop-help"]');
  var propTypeLabel = document.querySelector('label[for="prop-type"]');
  var propWidthLabel = document.querySelector('label[for="prop-width"]');
  var propRequiredLabel = document.querySelector('label > input#prop-required') ? document.querySelector('label > input#prop-required').parentElement : null;
  var propLabelWrapper = document.getElementById('prop-label-wrapper');
  var propRichEditorWrapper = document.getElementById('prop-rich-editor-wrapper');
  var propTextEditor = document.getElementById('prop-text-editor');
  var propLinkStatus = document.getElementById('prop-link-status');
  var propLinkTarget = document.getElementById('prop-link-target');
  var propInsertLinkBtn = document.getElementById('prop-insert-link');
  var alignButtons = document.querySelectorAll('.align-btn');
  var richEditorCommands = document.querySelectorAll('.text-editor-toolbar button[data-command]');
  var fieldControls = document.getElementById('field-controls');
  var linkModal = document.getElementById('link-modal');
  var linkModalUrl = document.getElementById('link-url');
  var linkModalText = document.getElementById('link-text');
  var linkModalAction = document.getElementById('link-action');
  var linkModalSave = document.getElementById('link-save');
  var linkModalCancel = document.getElementById('link-cancel');
  var linkModalClose = document.querySelector('.link-modal-close');

  var currentStep = 1;
  var draggedRow = null;
  var selectedFieldId = null; // id of selected field for properties panel
  var savedRange = null;

  // Simple history stacks for undo/redo of field list changes.
  var historyStack = [];
  var redoStack = [];
  var HISTORY_LIMIT = 50;
  var historyDebounceTimer = null;
  var isRestoringHistory = false;
  var lastHistorySignature = null;

  function attachDragHandlers(row) {
    row.setAttribute('draggable', 'true');
    var handle = row.querySelector('.field-row-handle');
    if (handle) {
      handle.addEventListener('mousedown', function(){ row.style.cursor = 'grabbing'; });
      handle.addEventListener('mouseup', function(){ row.style.cursor = 'grab'; });
    }
    row.addEventListener('dragstart', function(e){
      draggedRow = row;
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(function(){ row.classList.add('dragging'); }, 0);
    });
    row.addEventListener('dragend', function(){
      row.classList.remove('dragging');
      draggedRow = null;
      var all = fieldConfigContainer.querySelectorAll('.field-row');
      all.forEach(function(r){ r.classList.remove('drag-over'); });
    });
    row.addEventListener('dragover', function(e){
      e.preventDefault();
      if (!draggedRow || draggedRow === row) return;
      row.classList.add('drag-over');
    });
    row.addEventListener('dragleave', function(){
      row.classList.remove('drag-over');
    });
    row.addEventListener('drop', function(e){
      e.preventDefault();
      row.classList.remove('drag-over');
      if (!draggedRow || draggedRow === row) return;
      var bounds = row.getBoundingClientRect();
      var offset = e.clientY - bounds.top;
      if (offset > bounds.height / 2) {
        fieldConfigContainer.insertBefore(draggedRow, row.nextSibling);
      } else {
        fieldConfigContainer.insertBefore(draggedRow, row);
      }
      renderPreview();
      pushHistory('reorder');
    });
  }

  function deleteFieldRow(row) {
    if (!row) return;
    var removedId = row.getAttribute('data-id');
    row.remove();
    if (selectedFieldId === removedId) {
      selectedFieldId = null;
      if (propertiesForm) propertiesForm.style.display = 'none';
      restorePropertiesForm();
    }
    updateRequiredHiddenWarnings();
    renderPreview();
    pushHistory('delete');
  }

  function scheduleHistorySnapshot() {
    if (isRestoringHistory) return;
    if (historyDebounceTimer) clearTimeout(historyDebounceTimer);
    historyDebounceTimer = setTimeout(function(){ pushHistory('auto'); }, 220);
  }

  function getStateSnapshot() {
    return {
      config: getConfigFromUI(),
      selectedId: selectedFieldId,
      currentStep: currentStep,
      layout: getSelectedLayout(),
      density: densitySelect ? densitySelect.value : 'density-standard',
      numSteps: numStepsSelect ? numStepsSelect.value : (currentStep || 1),
      design: {
        column: designColumnSelect ? designColumnSelect.value : '',
        background: designBackgroundSelect ? designBackgroundSelect.value : '',
        theme: designThemeSelect ? designThemeSelect.value : '',
        container: designContainerStyleSelect ? designContainerStyleSelect.value : '',
        emphasis: designEmphasisSelect ? designEmphasisSelect.value : '',
        motion: designMotionSelect ? designMotionSelect.value : '',
        buttonStyle: designButtonStyleSelect ? designButtonStyleSelect.value : '',
        buttonShape: designButtonShapeSelect ? designButtonShapeSelect.value : '',
        buttonWidth: designButtonWidthSelect ? designButtonWidthSelect.value : '',
        inputStyle: designInputStyleSelect ? designInputStyleSelect.value : '',
        inputRadius: designInputRadiusSelect ? designInputRadiusSelect.value : '',
        typeScale: designTypeScaleSelect ? designTypeScaleSelect.value : '',
        headingWeight: designHeadingWeightSelect ? designHeadingWeightSelect.value : ''
      },
      display: typeof getFormDisplayState === 'function' ? getFormDisplayState() : {},
      meta: Object.assign({}, formMetaState),
      hiddenMeta: Array.isArray(hiddenMetadataState) ? JSON.parse(JSON.stringify(hiddenMetadataState)) : [],
      capture: {
        utms: hiddenCaptureState ? hiddenCaptureState.utms : true,
        referrer: hiddenCaptureState ? hiddenCaptureState.referrer : true
      }
    };
  }

  function applySnapshot(snapshot) {
    if (!snapshot || !Array.isArray(snapshot.config)) return;
    isRestoringHistory = true;
    fieldConfigContainer.innerHTML = '';
    snapshot.config.forEach(function(cfg){ buildFieldRow(cfg); });
    selectedFieldId = null;

    if (layoutSelect && snapshot.layout) {
      layoutSelect.value = snapshot.layout;
      updateStepVisibility();
    }
    if (densitySelect && snapshot.density) densitySelect.value = snapshot.density;
    if (numStepsSelect && snapshot.numSteps) numStepsSelect.value = snapshot.numSteps;
    currentStep = snapshot.currentStep || 1;

    if (snapshot.design) {
      if (designColumnSelect && snapshot.design.column) designColumnSelect.value = snapshot.design.column;
      if (designBackgroundSelect && snapshot.design.background) designBackgroundSelect.value = snapshot.design.background;
      if (designThemeSelect && snapshot.design.theme) designThemeSelect.value = snapshot.design.theme;
      if (designContainerStyleSelect && snapshot.design.container) designContainerStyleSelect.value = snapshot.design.container;
      if (designEmphasisSelect && snapshot.design.emphasis) designEmphasisSelect.value = snapshot.design.emphasis;
      if (designMotionSelect && snapshot.design.motion) designMotionSelect.value = snapshot.design.motion;
      if (designButtonStyleSelect && snapshot.design.buttonStyle) designButtonStyleSelect.value = snapshot.design.buttonStyle;
      if (designButtonShapeSelect && snapshot.design.buttonShape) designButtonShapeSelect.value = snapshot.design.buttonShape;
      if (designButtonWidthSelect && snapshot.design.buttonWidth) designButtonWidthSelect.value = snapshot.design.buttonWidth;
      if (designInputStyleSelect && snapshot.design.inputStyle) designInputStyleSelect.value = snapshot.design.inputStyle;
      if (designInputRadiusSelect && snapshot.design.inputRadius) designInputRadiusSelect.value = snapshot.design.inputRadius;
      if (designTypeScaleSelect && snapshot.design.typeScale) designTypeScaleSelect.value = snapshot.design.typeScale;
      if (designHeadingWeightSelect && snapshot.design.headingWeight) designHeadingWeightSelect.value = snapshot.design.headingWeight;
      applyDesignSelections();
    }

    if (snapshot.display && typeof setFormDisplayState === 'function') {
      setFormDisplayState(snapshot.display);
    }

    if (snapshot.meta) {
      formMetaState = Object.assign({}, snapshot.meta);
      FORM_META_KEYS.forEach(function(key){ renderMetaField(key); });
    }

    if (Array.isArray(snapshot.hiddenMeta)) {
      hiddenMetadataState = JSON.parse(JSON.stringify(snapshot.hiddenMeta));
      renderCustomHiddenMetadataGroups();
    }

    if (snapshot.capture && hiddenCaptureState) {
      hiddenCaptureState.utms = !!snapshot.capture.utms;
      hiddenCaptureState.referrer = !!snapshot.capture.referrer;
      syncHiddenMetadataUiFromState();
    }

    if (snapshot.selectedId) selectFieldForProperties(snapshot.selectedId);
    renderPreview();
    isRestoringHistory = false;
    lastHistorySignature = JSON.stringify(snapshot);
    updateUndoRedoButtons();
  }

  function updateUndoRedoButtons() {
    var undoBtn = document.getElementById('renderer-undo');
    var redoBtn = document.getElementById('renderer-redo');
    if (undoBtn) undoBtn.disabled = historyStack.length <= 1;
    if (redoBtn) redoBtn.disabled = redoStack.length === 0;
  }

  function pushHistory(label) {
    try {
      var snap = getStateSnapshot();
      var sig = JSON.stringify(snap);
      if (sig === lastHistorySignature) {
        updateUndoRedoButtons();
        return;
      }
      historyStack.push(snap);
      lastHistorySignature = sig;
      if (historyStack.length > HISTORY_LIMIT) historyStack.shift();
      redoStack = [];
      updateUndoRedoButtons();
    } catch (e) {
      // if history fails, do not block the UI
    }
  }

  function undo() {
    if (historyStack.length <= 1) return;
    var current = getStateSnapshot();
    redoStack.push(current);
    var previous = historyStack[historyStack.length - 2];
    historyStack.pop();
    applySnapshot(previous);
    lastHistorySignature = JSON.stringify(previous);
    updateUndoRedoButtons();
  }

  function redo() {
    if (!redoStack.length) return;
    var next = redoStack.pop();
    historyStack.push(next);
    applySnapshot(next);
    lastHistorySignature = JSON.stringify(next);
    updateUndoRedoButtons();
  }

  function buildOptionsUI(row, cfg, isStandard) {
    var container = row.querySelector('.options-wrapper');
    if (!container) return;
    var typeSelect = row.querySelector('.field-type-select');
    var fieldType = (cfg.fieldType || (typeSelect ? typeSelect.value : 'text'));

    var isChoice = fieldType === 'dropdown' || fieldType === 'multiselect' || fieldType === 'radio';
    if (!isChoice) {
      container.style.display = 'none';
      return;
    }
    container.style.display = 'block';
    var list = container.querySelector('.options-list');
    var addLink = container.querySelector('.options-add');
    var helper = container.querySelector('.options-helper');
    list.innerHTML = '';

    var opts = cfg.options && cfg.options.length ? cfg.options : ['Option 1','Option 2','Option 3'];
    opts.forEach(function(val){
      var li = document.createElement('li');
      li.className = 'option-row';
      li.innerHTML = '<span class="handle">⋮⋮</span>' +
                     '<input type="text" class="option-input" value="' + (val || '').replace(/"/g,'&quot;') + '"' + (isStandard ? ' disabled' : '') + ' />' +
                     (isStandard ? '' : '<button type="button" class="option-delete">✕</button>');
      list.appendChild(li);
    });

    if (isStandard) {
      if (addLink) addLink.style.display = 'none';
      if (helper) helper.textContent = 'Options are managed at the global form level.';
    } else {
      if (addLink) {
        addLink.style.display = 'inline';
        addLink.onclick = function(e){
          e.preventDefault();
          var li = document.createElement('li');
          li.className = 'option-row';
          li.innerHTML = '<span class="handle">⋮⋮</span>' +
                         '<input type="text" class="option-input" value="" />' +
                         '<button type="button" class="option-delete">✕</button>';
          list.appendChild(li);
        };
      }
      if (helper) helper.textContent = 'Drag to reorder options. These map to picklist values in Eloqua/EDMA.';
      list.addEventListener('click', function(e){
        if (e.target.classList.contains('option-delete')) {
          e.preventDefault();
          var li = e.target.closest('.option-row');
          if (li) li.remove();
        }
      });
    }
  }

  function buildFieldRow(cfg) {
    var isStandard = cfg.id.indexOf('custom_') !== 0 && cfg.type === 'field';
    var row = document.createElement('div');
    row.className = 'field-row';
    row.setAttribute('data-id', cfg.id);
    row.setAttribute('data-type', cfg.type || 'field');

    if (cfg.type === 'text') {
      // show a short preview of the text block
      var textPreview = stripHtml(cfg.text || '').replace(/\s+/g, ' ').slice(0, 120);
      row.innerHTML = '\n      <div class="field-row-main">\n        <div class="field-row-main-left">\n          <span class="field-row-handle">⋮⋮</span>\n          <span class="field-row-label">' + ((textPreview || 'Text block').replace(/"/g,'&quot;')) + '</span>\n        </div>\n        <div class="field-row-meta">\n          <span class="kind-label">Text block</span>\n          <button type="button" class="field-row-delete" aria-label="Delete block">✕</button>\n        </div>\n      </div>';
    } else {
      var labelText = ((cfg.label || '') ? cfg.label.replace(/"/g,'&quot;') : 'Untitled');
      row.innerHTML = '\n      <div class="field-row-main">\n        <div class="field-row-main-left">\n          <span class="field-row-handle">⋮⋮</span>\n          <span class="field-row-label">' + labelText + '</span>\n        </div>\n        <div class="field-row-meta">\n          <span class="field-condition-indicator" aria-label="Conditional field">Conditional field</span>\n          <span class="kind-label">' + (isStandard ? 'Standard field' : 'Custom field') + '</span>\n          <button type="button" class="field-row-delete" aria-label="Delete field">✕</button>\n        </div>\n      </div>\n      <div class="field-required-hidden-warning" role="note" aria-live="polite">\n        <span class="field-required-hidden-icon" aria-hidden="true">⚠</span>\n        <span class="field-required-hidden-text">This field is required but hidden under current conditions.</span>\n      </div>';
    }

    // attach the config object to the row so properties panel and preview can read it
    row._cfg = Object.assign({}, cfg);

    // selection handler: click to select and open properties
    row.addEventListener('click', function(e){
      if (e.target && e.target.classList && e.target.classList.contains('field-row-delete')) return;
      e.stopPropagation();
      // toggle: if this is already selected, collapse/clear selection
      if (selectedFieldId === row._cfg.id) {
        selectedFieldId = null;
        var allRows = fieldConfigContainer.querySelectorAll('.field-row');
        allRows.forEach(function(r){ r.classList.remove('selected'); });
        if (propertiesForm) propertiesForm.style.display = 'none';
        // restorePropertiesForm(); // no longer needed, handled in loadTemplate
        return;
      }
      selectFieldForProperties(row._cfg.id);
      var all = fieldConfigContainer.querySelectorAll('.field-row');
      all.forEach(function(r){ r.classList.remove('selected'); });
      row.classList.add('selected');
    });

    attachDragHandlers(row);
    fieldConfigContainer.appendChild(row);
    updateFieldConditionIndicator(row);
    updateRequiredHiddenWarningForRow(row);
    return row;
  }

  function updateFieldConditionIndicator(row) {
    if (!row || row.getAttribute('data-type') !== 'field') return;
    var indicator = row.querySelector('.field-condition-indicator');
    if (!indicator) return;
    var enabled = isConditionalEnabled(row._cfg);
    indicator.classList.toggle('active', !!enabled);
  }

  function isFieldRequiredButHiddenUnderCurrentConditions(fieldConfig) {
    if (!fieldConfig || fieldConfig.type !== 'field') return false;
    if (!fieldConfig.required) return false;
    if (fieldConfig.show === false) return true;
    if (!hasActiveConditions(fieldConfig)) return false;
    var key = fieldConfig.html || fieldConfig.id;
    if (!key) return false;
    // Only evaluate if the field exists in the current preview (e.g., current wizard step).
    var entry = getPreviewFieldEntry(key);
    if (!entry) return false;
    return !shouldFieldBeVisibleUnderConditions(fieldConfig);
  }

  function updateRequiredHiddenWarningForRow(row) {
    if (!row || row.getAttribute('data-type') !== 'field') return;
    var shouldWarn = isFieldRequiredButHiddenUnderCurrentConditions(row._cfg);
    row.classList.toggle('required-hidden', !!shouldWarn);
  }

  function updateRequiredHiddenWarnings() {
    if (!fieldConfigContainer) return;
    var rows = fieldConfigContainer.querySelectorAll('.field-row');
    rows.forEach(function(row){
      updateRequiredHiddenWarningForRow(row);
    });
  }

  function loadTemplate(name) {
    var templateFields = templates[name];
    fieldConfigContainer.innerHTML = '';
    selectedFieldId = null;
    if (propertiesForm) propertiesForm.style.display = 'none';
    // ensure the properties form is restored when loading a new template / clearing selection
    restorePropertiesForm();
    if (!templateFields || !templateFields.length) {
      fieldConfigContainer.innerHTML = '<div class="field-config-empty">No fields defined for this template.</div>';
      return;
    }
    templateFields.forEach(function(cfg){
      buildFieldRow(cfg);
    });
  }

  function addCustomField() {
    var id = 'custom_' + Date.now();
    var nextHtml = getNextAvailableOtherHtmlName();
    if (!nextHtml) {
      showRendererBanner('No available HTML names left (other1–other50). Remove a field to free a mapping.');
      return;
    }
    var field = {
      type:'field',
      id: id,
      html: nextHtml,
      label: 'Custom field',
      width: 'full',
      show: true,
      required: false,
      placeholder: '',
      help: '',
      step: 1,
      fieldType:'text'
    };
    buildFieldRow(field);
    selectFieldForProperties(id);
    renderPreview();
    pushHistory('add-field');
  }

  function addTextBlock() {
    var id = 'text_' + Date.now();
    var cfg = {
      type:'text',
      id:id,
      text:'Text block',
      fontSize:'body',
      align:'left',
      url:'',
      show:true,
      step:1
    };
    buildFieldRow(cfg);
    selectFieldForProperties(id);
    renderPreview();
    pushHistory('add-text');
  }

  function getConfigFromUI() {
    // read config from row._cfg for each row; this keeps the model separate from DOM inputs
    var rows = fieldConfigContainer.querySelectorAll('.field-row');
    var config = [];
    rows.forEach(function(row){
      var cfg = row._cfg || { type: 'field', id: row.getAttribute('data-id') };
      // If label input exists inline, sync it back to cfg
      var labelInput = row.querySelector('.label-input');
      if (labelInput) cfg.label = labelInput.value || cfg.label || 'Untitled';

      // sync HTML name if present
      var htmlInput = row.querySelector('.html-name-input');
      var htmlSelect = row.querySelector('.html-name-select');
      if (htmlInput) cfg.html = htmlInput.value;
      else if (htmlSelect) cfg.html = htmlSelect.value;

      config.push(Object.assign({}, cfg));
    });
    return config;
  }

  function normalizeStep(step, maxSteps) {
    if (!step || step < 1) return 1;
    if (step > maxSteps) return maxSteps;
    return step;
  }

  function renderPreview() {
    // Builder preview: show conditional indicators and placeholders.
    previewConditionUiShowIndicator = true;
    previewConditionUiShowPlaceholder = true;
    previewConditionHideMode = 'placeholder';

    var cfg = getConfigFromUI();
    var density = densitySelect ? densitySelect.value : 'density-standard';
    var layout = getSelectedLayout();
    var maxSteps = parseInt(numStepsSelect.value, 10) || 3;
    var displayState = getFormDisplayState();
    var designLayoutChoice = designColumnSelect ? designColumnSelect.value : 'full-width';
    syncHeroFormDisplay(displayState, designLayoutChoice);

    if (currentStep > maxSteps) currentStep = maxSteps;

    maxSteps = Math.max(1, Math.min(10, maxSteps || 3));
    currentStep = Math.min(Math.max(currentStep || 1, 1), maxSteps);

    var layoutLabelMap = {
      single: 'Inline form',
      wizard: 'Multi-step',
      card: 'Card-based'
    };
    layoutTag.textContent = layoutLabelMap[layout] || 'Custom layout';

    if (wizardSettingsWrap) {
      wizardSettingsWrap.style.display = layout === 'wizard' ? 'block' : 'none';
    }
    if (layout === 'wizard') {
      ensureWizardUiState(maxSteps);
      if (wizardEditorsRenderedSteps !== maxSteps) {
        renderWizardSettingsEditors(maxSteps);
        wizardEditorsRenderedSteps = maxSteps;
      }
    } else {
      wizardEditorsRenderedSteps = 0;
    }

    previewContainer.className = 'form-preview ' + density + ' layout-' + layout + ' ' + getDesignPreviewClassString(null);
    previewContainer.innerHTML = '';
    injectHiddenMetadataInputs(previewContainer, getAllHiddenMetadataItems());
    previewFieldRegistry = {};
    previewDependencyMap = {};

    var allowHorizontalDisplay = layout !== 'wizard';
    var displayTargets = injectDisplayBlock(previewContainer, displayState, allowHorizontalDisplay, designLayoutChoice);
    var previewTarget = displayTargets.fieldsContainer || previewContainer;

    if (layout === 'wizard') {
      var ui = normalizeWizardUi(null, maxSteps);
      buildWizardStepper(wizardNav, maxSteps, currentStep, ui.stepTitles, function(stepNum){
        currentStep = stepNum;
        renderPreview();
      });

      cfg.forEach(function(item){
        if (!item.show) return;
        var normalized = normalizeStep(item.step, maxSteps);
        if (normalized !== currentStep) return;
        var element = appendPreviewItem(item, previewTarget, density, layout);
        handleRenderedPreviewField(item, element);
      });
    } else {
      wizardNav.style.display = 'none';
      wizardNav.innerHTML = '';
      cfg.forEach(function(item){
        if (!item.show) return;
        var element = appendPreviewItem(item, previewTarget, density, layout);
        handleRenderedPreviewField(item, element);
      });
    }

    syncWizardButtons('preview', layout, currentStep, maxSteps, displayState, null);
    initializePreviewConditionEngine(cfg);
    updateRequiredHiddenWarnings();
    syncRendererValidationBanner(cfg);
  }

  function applyPreviewSpacing(element, density, layout) {
    if (!element) return;
    if (layout === 'card') {
      element.style.marginBottom = '12px';
      return;
    }
    if (density === 'compact') element.style.marginBottom = '4px';
    else if (density === 'standard') element.style.marginBottom = '8px';
    else element.style.marginBottom = '14px';
  }

  function hasConfiguredConditions(field) {
    return !!(field && field.type === 'field' && Array.isArray(field.conditions) && field.conditions.length);
  }

  function isConditionalEnabled(field) {
    if (!field || field.type !== 'field') return false;
    // If explicitly toggled, respect that.
    if (typeof field.conditionsEnabled === 'boolean') return field.conditionsEnabled;
    // Back-compat: if conditions exist but no explicit toggle, treat as enabled.
    return hasConfiguredConditions(field);
  }

  function hasActiveConditions(field) {
    return isConditionalEnabled(field) && hasConfiguredConditions(field);
  }

  function normalizeConditionAction(field) {
    var raw = (field && field.conditionAction ? String(field.conditionAction) : 'show').toLowerCase();
    return (raw === 'hide') ? 'hide' : 'show';
  }

  function shouldFieldBeVisibleUnderConditions(fieldConfig) {
    if (!hasActiveConditions(fieldConfig)) return true;
    var met = evaluateFieldConditions(fieldConfig);
    return normalizeConditionAction(fieldConfig) === 'hide' ? !met : !!met;
  }

  function handleRenderedPreviewField(item, element) {
    if (!element || item.type !== 'field') return;
    var placeholder = null;
    if (isConditionalEnabled(item)) {
      if (previewConditionUiShowIndicator) ensurePreviewConditionalIndicator(element);
      element.classList.add('conditional-field');
    }
    if (hasActiveConditions(item) && previewConditionUiShowPlaceholder) {
      placeholder = ensureConditionalPlaceholder(element, item);
    }
    var entry = registerPreviewField(item, element);
    if (entry && placeholder) entry.placeholder = placeholder;
  }

  function ensurePreviewConditionalIndicator(element) {
    if (!element) return null;
    var existing = element.querySelector('.preview-condition-indicator');
    if (existing) return existing;
    var target = element.querySelector('.preview-radio-legend') ||
                 element.querySelector('.preview-checkbox-text') ||
                 element.querySelector('.preview-field-inner > label');
    if (!target) return null;
    var badge = document.createElement('span');
    badge.className = 'preview-condition-indicator';
    badge.textContent = 'Conditional field';
    target.appendChild(document.createTextNode(' '));
    target.appendChild(badge);
    return badge;
  }

  function registerPreviewField(fieldConfig, element) {
    if (!fieldConfig || !element || fieldConfig.type !== 'field') return null;
    var htmlName = fieldConfig.html || fieldConfig.id;
    if (!htmlName) return null;
    var controls = Array.from(element.querySelectorAll('[data-field-control="true"]'));
    element.dataset.htmlName = htmlName;
    element.dataset.fieldId = fieldConfig.id || '';
    var entry = {
      config: fieldConfig,
      element: element,
      controls: controls,
      placeholder: element.querySelector('.conditional-placeholder') || null
    };
    previewFieldRegistry[htmlName] = entry;
    return entry;
  }

  function ensureConditionalPlaceholder(element, field) {
    if (!element) return null;
    var existing = element.querySelector('.conditional-placeholder');
    if (existing) return existing;
    var placeholder = document.createElement('div');
    placeholder.className = 'conditional-placeholder';
    var message = document.createElement('span');
    message.className = 'conditional-message';
    var label = field.label || 'Untitled field';
    message.textContent = label + ' is hidden based on its conditions';
    var pill = document.createElement('span');
    pill.className = 'conditional-pill';
    pill.textContent = 'Conditional field';
    placeholder.appendChild(message);
    placeholder.appendChild(pill);
    element.appendChild(placeholder);
    return placeholder;
  }

  function initializePreviewConditionEngine(config, options) {
    if (!previewFieldRegistry) previewFieldRegistry = {};
    previewDependencyMap = {};
    previewConditionEngineUpdateWarnings = !(options && options.updateRequiredHiddenWarnings === false);
    var conditionalFields = [];

    config.forEach(function(field){
      if (!hasActiveConditions(field)) return;
      var key = field.html || field.id;
      if (!key || !previewFieldRegistry[key]) return;
      conditionalFields.push(field);
      (field.conditions || []).forEach(function(cond){
        if (!cond || !cond.field) return;
        if (!previewDependencyMap[cond.field]) previewDependencyMap[cond.field] = [];
        if (previewDependencyMap[cond.field].indexOf(field) === -1) {
          previewDependencyMap[cond.field].push(field);
        }
      });
    });

    Object.keys(previewDependencyMap).forEach(function(htmlName){
      var entry = previewFieldRegistry[htmlName];
      if (!entry) return;
      attachPreviewControlListeners(entry, function(){
        var dependents = previewDependencyMap[htmlName] || [];
        dependents.forEach(function(targetField){
          updateConditionalFieldVisibility(targetField);
        });
        if (previewConditionEngineUpdateWarnings) updateRequiredHiddenWarnings();
      });
    });

    conditionalFields.forEach(function(field){
      updateConditionalFieldVisibility(field);
    });

    if (previewConditionEngineUpdateWarnings) updateRequiredHiddenWarnings();
  }

  function attachPreviewControlListeners(entry, handler) {
    if (!entry || !entry.controls || !entry.controls.length) return;
    entry.controls.forEach(function(control){
      control.addEventListener('change', handler);
      if (control.tagName === 'SELECT') control.addEventListener('input', handler);
      if (control.type === 'checkbox' || control.type === 'radio') control.addEventListener('input', handler);
    });
  }

  function getPreviewFieldEntry(htmlName) {
    return previewFieldRegistry ? previewFieldRegistry[htmlName] : null;
  }

  function getPreviewFieldValue(htmlName) {
    var entry = getPreviewFieldEntry(htmlName);
    if (!entry) return '';
    var type = entry.config.fieldType || 'text';
    if (!entry.controls || !entry.controls.length) return '';
    if (type === 'dropdown') {
      return entry.controls[0].value || '';
    }
    if (type === 'multiselect') {
      var select = entry.controls[0];
      var selected = select && select.selectedOptions ? Array.from(select.selectedOptions) : [];
      return selected.map(function(opt){ return opt.value; });
    }
    if (type === 'radio') {
      var checked = entry.controls.find(function(ctrl){ return ctrl.checked; });
      return checked ? (checked.value || '') : '';
    }
    if (type === 'checkbox' || type === 'consent') {
      return entry.controls[0].checked ? 'checked' : 'unchecked';
    }
    return '';
  }

  function evaluateSingleCondition(cond, value) {
    var operator = (cond && cond.operator ? cond.operator.toLowerCase() : 'is');
    var target = (cond && typeof cond.value !== 'undefined') ? cond.value : '';
    if (Array.isArray(value)) {
      var contains = value.indexOf(target) !== -1;
      if (operator === 'is blank') return value.length === 0;
      if (operator === 'is not') return !contains;
      return contains;
    }
    var normalized = (value == null) ? '' : String(value);
    if (operator === 'is blank') return normalized === '' || normalized === 'unchecked';
    if (operator === 'is not') return normalized !== target;
    return normalized === target;
  }

  function evaluateFieldConditions(fieldConfig) {
    if (!hasActiveConditions(fieldConfig)) return true;
    var conditions = fieldConfig.conditions || [];
    var result = null;
    conditions.forEach(function(cond, index){
      if (!cond || !cond.field) return;
      var condResult = evaluateSingleCondition(cond, getPreviewFieldValue(cond.field));
      if (result === null) {
        result = condResult;
        return;
      }
      var connector = (cond.connector || 'and').toLowerCase();
      if (connector === 'or') result = result || condResult;
      else result = result && condResult;
    });
    return result === null ? false : result;
  }

  function updateConditionalFieldVisibility(fieldConfig) {
    if (!fieldConfig) return;
    var key = fieldConfig.html || fieldConfig.id;
    if (!key) return;
    var entry = getPreviewFieldEntry(key);
    if (!entry || !entry.element) return;
    var shouldShow = shouldFieldBeVisibleUnderConditions(fieldConfig);
    entry.element.classList.toggle('conditional-hidden', !shouldShow);

    if (previewConditionHideMode === 'collapse') {
      entry.element.style.display = shouldShow ? '' : 'none';
    } else {
      // Ensure any prior collapse-mode render doesn't leak into builder preview.
      entry.element.style.display = '';
    }

    // Record a snapshot after the preview reflects the current state.
    scheduleHistorySnapshot();
  }

  function appendPreviewItem(f, container, density, layoutMode) {
    var layout = layoutMode || 'single';
    var isCardLayout = layout === 'card';

    if (f.type === 'text') {
      var textWrap = document.createElement('div');
      textWrap.className = 'preview-field full';
      if (isCardLayout) textWrap.classList.add('card-field');
      applyPreviewSpacing(textWrap, density, layout);
      textWrap.style.textAlign = f.align || 'left';

      var contentEl = document.createElement('div');
      contentEl.className = 'preview-text ' + (f.fontSize || 'body');
      contentEl.innerHTML = f.text || '';

      if (f.url && !(f.text || '').match(/<a\b/i)) {
        var a = document.createElement('a');
        a.href = f.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.style.color = 'inherit';
        a.style.display = 'block';
        a.appendChild(contentEl);
        textWrap.appendChild(a);
      } else {
        textWrap.appendChild(contentEl);
      }
      container.appendChild(textWrap);
      return textWrap;
    }

    var widthClass = f.width || 'full';
    var wrap = document.createElement('div');
    wrap.className = 'preview-field ' + widthClass;
    if (isCardLayout) wrap.classList.add('card-field');
    applyPreviewSpacing(wrap, density, layout);

    var inner = document.createElement('div');
    inner.className = 'preview-field-inner';
    var controlType = f.fieldType || 'text';
    var input;
    var fieldIdBase = 'fld-' + (f.id ? String(f.id).replace(/[^a-zA-Z0-9_\-]/g, '') : ('x' + Math.random().toString(36).slice(2, 9)));
    var helpId = fieldIdBase + '-help';

    if (controlType === 'textarea') {
      input = document.createElement('textarea');
      input.rows = 3;
      input.setAttribute('data-field-control', 'true');
    } else if (controlType === 'dropdown' || controlType === 'multiselect') {
      input = document.createElement('select');
      if (controlType === 'multiselect') input.multiple = true;
      input.setAttribute('data-field-control', 'true');
      var opts = (f.options && f.options.length) ? f.options : ['Option 1','Option 2','Option 3'];
      opts.forEach(function(opt){
        var o = document.createElement('option');
        o.textContent = opt;
        o.value = opt;
        input.appendChild(o);
      });
    } else if (controlType === 'radio') {
      input = document.createElement('fieldset');
      input.className = 'preview-radio-group';
      input.setAttribute('role', 'radiogroup');
      var legend = document.createElement('legend');
      legend.className = 'preview-radio-legend';
      legend.textContent = (f.label || 'Untitled') + (f.required ? ' *' : '');
      input.appendChild(legend);

      var radioName = (f.id ? String(f.id) : ('radio_' + Math.random().toString(36).slice(2, 9)));
      var optsR = (f.options && f.options.length) ? f.options : ['Option 1','Option 2'];
      optsR.forEach(function(opt, idx){
        var labelEl = document.createElement('label');
        labelEl.className = 'preview-radio-option';
        var r = document.createElement('input');
        r.type = 'radio';
        r.name = radioName;
        r.id = fieldIdBase + '-opt-' + (idx + 1);
        r.value = opt;
        r.setAttribute('data-field-control', 'true');
        if (f.required && idx === 0) {
          r.required = true;
          r.setAttribute('aria-required', 'true');
        }
        labelEl.setAttribute('for', r.id);
        labelEl.appendChild(r);
        labelEl.appendChild(document.createTextNode(' ' + opt));
        input.appendChild(labelEl);
      });
    } else if (controlType === 'checkbox' || controlType === 'consent') {
      input = document.createElement('input');
      input.type = 'checkbox';
      input.setAttribute('data-field-control', 'true');
    } else if (controlType === 'number') {
      input = document.createElement('input');
      input.type = 'number';
      input.setAttribute('data-field-control', 'true');
    } else if (controlType === 'date') {
      input = document.createElement('input');
      input.type = 'date';
      input.setAttribute('data-field-control', 'true');
    } else if (controlType === 'time') {
      input = document.createElement('input');
      input.type = 'time';
      input.setAttribute('data-field-control', 'true');
    } else if (controlType === 'datetime') {
      input = document.createElement('input');
      input.type = 'datetime-local';
      input.setAttribute('data-field-control', 'true');
    } else if (controlType === 'email') {
      input = document.createElement('input');
      input.type = 'email';
      input.setAttribute('data-field-control', 'true');
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.setAttribute('data-field-control', 'true');
    }

    // Wire accessible naming + required semantics for controls that support it.
    if (input && input.tagName !== 'DIV' && input.tagName !== 'FIELDSET') {
      input.id = input.id || fieldIdBase;
      if (f.required) {
        try { input.required = true; } catch (e) {}
        input.setAttribute('aria-required', 'true');
      }
    }

    if (controlType === 'radio') {
      inner.appendChild(input);
    } else if (controlType === 'checkbox' || controlType === 'consent') {
      var checkboxLabel = document.createElement('label');
      checkboxLabel.className = 'preview-checkbox-label';
      if (input && !input.id) input.id = fieldIdBase;
      if (f.required) {
        try { input.required = true; } catch (e) {}
        input.setAttribute('aria-required', 'true');
      }
      checkboxLabel.appendChild(input);
      var checkboxText = document.createElement('span');
      checkboxText.className = 'preview-checkbox-text';
      checkboxText.textContent = (f.label || 'Untitled') + (f.required ? ' *' : '');
      checkboxLabel.appendChild(checkboxText);
      inner.appendChild(checkboxLabel);
    } else {
      var lab = document.createElement('label');
      lab.textContent = (f.label || 'Untitled') + (f.required ? ' *' : '');
      if (input && input.id) lab.setAttribute('for', input.id);
      inner.appendChild(lab);
      inner.appendChild(input);
    }

    if (f.placeholder && input.tagName !== 'SELECT' && input.type !== 'checkbox' && input.type !== 'radio' && input.type !== 'datetime-local') {
      input.placeholder = f.placeholder;
    }
    if (f.help) {
      var sm = document.createElement('small');
      sm.id = helpId;
      sm.textContent = f.help;
      inner.appendChild(sm);

      if (controlType === 'radio') {
        input.setAttribute('aria-describedby', helpId);
      } else if (input && input.setAttribute) {
        var prior = (input.getAttribute('aria-describedby') || '').trim();
        input.setAttribute('aria-describedby', prior ? (prior + ' ' + helpId) : helpId);
      }
    }

    wrap.appendChild(inner);
    container.appendChild(wrap);
    return wrap;
  }

  function updateStepVisibility() {
    var isWizard = getSelectedLayout() === 'wizard';
    var stepSelects = fieldConfigContainer.querySelectorAll('.step-select');
    stepSelects.forEach(function(sel){
      sel.style.display = isWizard ? '' : 'none';
    });
    if (numStepsGroup) numStepsGroup.style.display = isWizard ? '' : 'none';
    if (formLayoutWizardSettingsWrap) formLayoutWizardSettingsWrap.style.display = isWizard ? 'block' : 'none';
  }

  function updateStepVisibilityForRow(row) {
    var isWizard = getSelectedLayout() === 'wizard';
    var sel = row.querySelector('.step-select');
    if (sel) sel.style.display = isWizard ? '' : 'none';
  }

  function getUsedHtmlNames(excludeId) {
    var used = {};
    var rows = fieldConfigContainer.querySelectorAll('.field-row');
    rows.forEach(function(row){
      var cfg = row._cfg || {};
      if (cfg.type !== 'field') return;
      if (excludeId && row.getAttribute('data-id') === excludeId) return;
      if (cfg.html) used[cfg.html] = true;
    });
    return used;
  }

  function updateHtmlSelectOptions(excludeId) {
    if (!propHtml) return;
    var used = getUsedHtmlNames(excludeId);
    Array.from(propHtml.options).forEach(function(opt){
      if (!opt.value) { opt.disabled = false; return; }
      opt.disabled = !!used[opt.value];
    });
  }

  function isChoiceFieldType(type) {
    var normalized = (type || '').toLowerCase();
    return normalized === 'dropdown' || normalized === 'multiselect' || normalized === 'radio';
  }

  function resetPropOptionsEditor() {
    if (propOptionsWrapper) propOptionsWrapper.style.display = 'none';
    if (propOptionsList) propOptionsList.innerHTML = '';
    if (propAddOption) {
      propAddOption.disabled = false;
      propAddOption.style.display = '';
    }
  }

  function createOptionInputRow(value) {
    var row = document.createElement('div');
    row.className = 'option-row';
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '8px';
    var input = document.createElement('input');
    input.type = 'text';
    input.className = 'option-input';
    input.value = value || '';
    input.placeholder = 'Choice label';
    input.style.flex = '1';
    row.appendChild(input);
    var remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'btn option-delete';
    remove.textContent = '✕';
    remove.style.padding = '4px 8px';
    row.appendChild(remove);
    return row;
  }

  function renderPropOptionsEditor(cfg) {
    if (!propOptionsWrapper || !propOptionsList) return;
    var options = (cfg && Array.isArray(cfg.options) && cfg.options.length) ? cfg.options.slice() : ['Option 1', 'Option 2'];
    propOptionsList.innerHTML = '';
    options.forEach(function(opt){
      propOptionsList.appendChild(createOptionInputRow(opt));
    });
    propOptionsWrapper.style.display = '';
    if (propAddOption) {
      propAddOption.style.display = '';
      propAddOption.disabled = false;
    }
  }

  function collectOptionValues() {
    if (!propOptionsList) return [];
    var values = [];
    var inputs = propOptionsList.querySelectorAll('input.option-input');
    inputs.forEach(function(input){
      var val = (input.value || '').trim();
      if (val) values.push(val);
    });
    return values;
  }

  function getConditionFieldOptions() {
    var cfgs = getConfigFromUI();
    var options = [];
    cfgs.forEach(function(cfg){
      var type = cfg.fieldType || 'text';
      if (CONDITION_FIELD_TYPES.indexOf(type) === -1) return;
      var value = cfg.html || cfg.id;
      if (!value) return;
      var label = (cfg.label || cfg.id || value);
      options.push({ value: value, label: label + ' (' + value + ')' });
    });
    return options;
  }

  function isConditionToggleOn() {
    return !!(propConditionToggle && propConditionToggle.classList.contains('on'));
  }

  function updateConditionControlsVisibility(enabled) {
    if (propConditionActionRow) propConditionActionRow.style.display = enabled ? 'flex' : 'none';
    if (propConditionsList) propConditionsList.style.display = enabled ? 'block' : 'none';
    if (propAddCondition) {
      propAddCondition.style.display = enabled ? '' : 'none';
      propAddCondition.disabled = !enabled;
    }
    if (propConditionHelper) propConditionHelper.style.display = enabled ? '' : 'none';
    if (!enabled) clearConditionValidationError();
  }

  function setConditionValidationError(message) {
    if (!propConditionError) return;
    propConditionError.textContent = message || '';
    propConditionError.style.display = message ? '' : 'none';
  }

  function clearConditionValidationError() {
    setConditionValidationError('');
  }

  function getFieldLabelByKey(key) {
    if (!key) return key;
    var cfgs = getConfigFromUI();
    for (var i = 0; i < cfgs.length; i++) {
      var cfg = cfgs[i];
      if (!cfg || cfg.type !== 'field') continue;
      var k = cfg.html || cfg.id;
      if (k === key) return (cfg.label || key);
    }
    return key;
  }

  function buildDependencyGraph(configs) {
    var graph = {};
    (configs || []).forEach(function(cfg){
      if (!cfg || cfg.type !== 'field') return;
      var key = cfg.html || cfg.id;
      if (!key) return;
      if (!graph[key]) graph[key] = [];
    });
    (configs || []).forEach(function(cfg){
      if (!hasActiveConditions(cfg)) return;
      var target = cfg.html || cfg.id;
      if (!target) return;
      (cfg.conditions || []).forEach(function(cond){
        if (!cond || !cond.field) return;
        var src = cond.field;
        if (!graph[src]) graph[src] = [];
        if (graph[src].indexOf(target) === -1) graph[src].push(target);
      });
    });
    return graph;
  }

  function findAnyCycle(graph) {
    var visited = {};
    var inStack = {};
    var parent = {};

    function dfs(node) {
      visited[node] = true;
      inStack[node] = true;
      var nexts = graph[node] || [];
      for (var i = 0; i < nexts.length; i++) {
        var next = nexts[i];
        if (!visited[next]) {
          parent[next] = node;
          var cycle = dfs(next);
          if (cycle) return cycle;
        } else if (inStack[next]) {
          // Build cycle path from node back to next
          var path = [next];
          var cur = node;
          while (cur && cur !== next) {
            path.push(cur);
            cur = parent[cur];
          }
          path.push(next);
          path.reverse();
          return path;
        }
      }
      inStack[node] = false;
      return null;
    }

    var nodes = Object.keys(graph || {});
    for (var n = 0; n < nodes.length; n++) {
      var node = nodes[n];
      if (!visited[node]) {
        var cycle = dfs(node);
        if (cycle) return cycle;
      }
    }
    return null;
  }

  function snapshotConfigsWithOverride(overrideId, overrideCfg) {
    var rows = fieldConfigContainer ? fieldConfigContainer.querySelectorAll('.field-row') : [];
    var list = [];
    rows.forEach(function(r){
      var cfg = r._cfg ? Object.assign({}, r._cfg) : null;
      if (!cfg) return;
      if (cfg.id === overrideId) cfg = Object.assign({}, overrideCfg);
      list.push(cfg);
    });
    return list;
  }

  function validateConditionsForField(targetCfg, proposedConditions, allConfigs) {
    if (!targetCfg || targetCfg.type !== 'field') return null;
    if (!proposedConditions || !proposedConditions.length) return null;
    var targetKey = targetCfg.html || targetCfg.id;
    if (!targetKey) return 'This field must have an HTML name before conditions can be applied.';

    // Basic validation
    if (proposedConditions.length > CONDITION_LIMIT) return 'Too many conditions. Maximum is ' + CONDITION_LIMIT + '.';

    var usedFields = {};
    for (var i = 0; i < proposedConditions.length; i++) {
      var c = proposedConditions[i];
      if (!c || !c.field) continue;
      if (c.field === targetKey) return 'A field cannot reference itself in conditions.';
      if (usedFields[c.field]) return 'Overlapping rules: each condition must reference a unique field ("' + getFieldLabelByKey(c.field) + '" is repeated).';
      usedFields[c.field] = true;

      var controllingCfg = getConditionFieldConfig(c.field);
      if (!controllingCfg) return 'Condition references an unknown field: ' + c.field + '.';
      var controllingType = controllingCfg.fieldType || 'text';
      if (CONDITION_FIELD_TYPES.indexOf(controllingType) === -1) {
        return 'Conditions can only reference choice fields (dropdown, multiselect, radio, checkbox).';
      }

      var op = (c.operator || 'is').toLowerCase();
      var v = (typeof c.value === 'string') ? c.value.trim() : '';
      if (op !== 'is blank' && !v) return 'Condition value is required unless operator is “Is blank”.';
      if (op !== 'is blank') {
        var allowed = getConditionValueOptions(controllingCfg);
        if (allowed && allowed.length) {
          var ok = allowed.some(function(o){ return o.value === v; });
          if (!ok) return 'Condition value "' + v + '" is not valid for ' + getFieldLabelByKey(c.field) + '.';
        }
      }
    }

    // Cycle detection
    var graph = buildDependencyGraph(allConfigs);
    var cycle = findAnyCycle(graph);
    if (cycle && cycle.length > 2) {
      var pretty = cycle.map(function(k){ return getFieldLabelByKey(k); }).join(' → ');
      return 'Circular logic detected: ' + pretty + '. Remove one of the dependencies.';
    }
    return null;
  }

  function setConditionToggleState(enabled) {
    if (!propConditionToggle) return;
    propConditionToggle.classList.toggle('on', !!enabled);
    propConditionToggle.classList.toggle('off', !enabled);
    propConditionToggle.textContent = enabled ? 'On' : 'Off';
    propConditionToggle.setAttribute('aria-pressed', enabled ? 'true' : 'false');
    updateConditionControlsVisibility(!!enabled);
    updateConditionButtonState();
  }

  function setConditionToggleAvailability(available) {
    if (!propConditionToggle) return;
    propConditionToggle.disabled = !available;
    if (!available) setConditionToggleState(false);
  }

  function getConditionFieldConfig(fieldValue) {
    if (!fieldValue) return null;
    var cfgs = getConfigFromUI();
    for (var i = 0; i < cfgs.length; i++) {
      var cfg = cfgs[i];
      if (cfg.type !== 'field') continue;
      var identifier = cfg.html || cfg.id;
      if (identifier === fieldValue) return cfg;
    }
    return null;
  }

  function getConditionValueOptions(fieldCfg) {
    if (!fieldCfg) return [];
    var type = fieldCfg.fieldType || 'text';
    if (type === 'dropdown' || type === 'multiselect' || type === 'radio') {
      var opts = Array.isArray(fieldCfg.options) ? fieldCfg.options : [];
      return opts.filter(function(opt){ return typeof opt === 'string' && opt.trim(); }).map(function(opt){
        return { value: opt, label: opt };
      });
    }
    if (type === 'checkbox' || type === 'consent') {
      return [
        { value: 'checked', label: 'Checked' },
        { value: 'unchecked', label: 'Unchecked' }
      ];
    }
    return [];
  }

  function createConditionValueControl(fieldValue, existingValue) {
    var fieldCfg = getConditionFieldConfig(fieldValue);
    var options = getConditionValueOptions(fieldCfg);
    var control;
    if (options.length) {
      control = document.createElement('select');
      options.forEach(function(opt){
        var optionEl = document.createElement('option');
        optionEl.value = opt.value;
        optionEl.textContent = opt.label;
        control.appendChild(optionEl);
      });
      if (existingValue) {
        var hasMatch = options.some(function(opt){ return opt.value === existingValue; });
        if (hasMatch) {
          control.value = existingValue;
        } else {
          var fallback = document.createElement('option');
          fallback.value = existingValue;
          fallback.textContent = existingValue + ' (no longer available)';
          fallback.selected = true;
          fallback.disabled = true;
          control.appendChild(fallback);
        }
      }
    } else {
      control = document.createElement('input');
      control.type = 'text';
      control.placeholder = 'value';
      if (existingValue) control.value = existingValue;
    }
    control.className = 'condition-value';
    control.style.flex = '1';
    return control;
  }

  function updateConditionButtonState(fields) {
    if (!propAddCondition || !propConditionsList) return;
    if (!isConditionToggleOn()) {
      propAddCondition.disabled = true;
      return;
    }
    var existing = propConditionsList.children.length;
    var hasCapacity = existing < CONDITION_LIMIT;
    var available = fields || getConditionFieldOptions();
    var hasFields = !!(available && available.length);
    var maxByFields = hasFields ? available.length : 0;
    var hasUnusedField = hasFields && existing < maxByFields;
    propAddCondition.disabled = !hasCapacity || !hasFields || !hasUnusedField;
  }

  function getConditionFieldSelections(excludeSelect) {
    if (!propConditionsList) return [];
    var rows = propConditionsList.querySelectorAll('.condition-row');
    var selections = [];
    rows.forEach(function(row){
      var sel = row.querySelector('.condition-field');
      if (!sel || sel === excludeSelect) return;
      if (sel.value) selections.push(sel.value);
    });
    return selections;
  }

  function setDefaultConditionField(select) {
    if (!select || select.value) return;
    var used = getConditionFieldSelections(select);
    for (var i = 0; i < select.options.length; i++) {
      var opt = select.options[i];
      if (!opt.value) continue;
      if (used.indexOf(opt.value) === -1) {
        select.value = opt.value;
        break;
      }
    }
  }

  function updateConditionFieldAvailability() {
    if (!propConditionsList) return;
    var rows = propConditionsList.querySelectorAll('.condition-row');
    var counts = {};
    rows.forEach(function(row){
      var sel = row.querySelector('.condition-field');
      if (!sel || !sel.value) return;
      counts[sel.value] = (counts[sel.value] || 0) + 1;
    });
    rows.forEach(function(row){
      var sel = row.querySelector('.condition-field');
      if (!sel) return;
      var current = sel.value;
      Array.from(sel.options).forEach(function(opt){
        if (!opt.value) return;
        if (opt.value === current) {
          opt.disabled = false;
        } else {
          opt.disabled = (counts[opt.value] || 0) > 0;
        }
      });
    });
  }

  function initializeConditionRow(row, fields) {
    if (!row) return;
    var select = row.querySelector('.condition-field');
    setDefaultConditionField(select);
    updateConditionFieldAvailability();
    updateConditionButtonState();
  }

  function refreshConditionConnectors() {
    if (!propConditionsList) return;
    var rows = propConditionsList.querySelectorAll('.condition-row');
    rows.forEach(function(row, index){
      var connector = row.querySelector('.condition-connector');
      if (!connector) return;
      connector.style.display = index === 0 ? 'none' : 'flex';
    });
  }

  function toggleConditionValueInput(operatorSelect, valueInput) {
    if (!operatorSelect || !valueInput) return;
    var disabled = operatorSelect.value === 'is blank';
    valueInput.disabled = disabled;
    if (disabled && valueInput.tagName === 'INPUT') valueInput.value = '';
  }

  function createConditionRow(cond, fields) {
    var wrap = document.createElement('div');
    wrap.className = 'condition-row';
    var connector = document.createElement('div');
    connector.className = 'condition-connector';
    var connectorSelect = document.createElement('select');
    connectorSelect.className = 'condition-connector-select';
    CONDITION_CONNECTORS.forEach(function(option){
      var opt = document.createElement('option');
      opt.value = option.value;
      opt.textContent = option.label;
      connectorSelect.appendChild(opt);
    });
    connectorSelect.value = (cond && cond.connector) ? cond.connector : 'and';
    connector.appendChild(connectorSelect);
    wrap.appendChild(connector);

    var content = document.createElement('div');
    content.className = 'condition-row-content';
    var fldSel = document.createElement('select');
    fldSel.className = 'condition-field';
    fldSel.style.flex = '1';
    var available = (fields || []).slice();
    if (cond && cond.field && !available.some(function(opt){ return opt.value === cond.field; })) {
      available.push({ value: cond.field, label: cond.field + ' (' + cond.field + ')', disabled: true });
    }
    if (!available.length) {
      var placeholder = document.createElement('option');
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.textContent = 'No eligible fields';
      fldSel.appendChild(placeholder);
    } else {
      available.forEach(function(opt){
        var o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if (opt.disabled) o.disabled = true;
        if (cond && cond.field === opt.value) o.selected = true;
        fldSel.appendChild(o);
      });
    }
    var opSel = document.createElement('select');
    opSel.className = 'condition-operator';
    CONDITION_OPERATORS.forEach(function(option){
      var o = document.createElement('option');
      o.value = option.value;
      o.textContent = option.label;
      opSel.appendChild(o);
    });
    if (cond && cond.operator) opSel.value = cond.operator;
    var valueControl = createConditionValueControl(cond ? cond.field : fldSel.value, cond ? cond.value : '');
    toggleConditionValueInput(opSel, valueControl);
    opSel.addEventListener('change', function(){ toggleConditionValueInput(opSel, valueControl); });
    opSel.addEventListener('change', clearConditionValidationError);
    fldSel.addEventListener('change', function(){
      var replacement = createConditionValueControl(fldSel.value, null);
      content.replaceChild(replacement, valueControl);
      valueControl = replacement;
      toggleConditionValueInput(opSel, valueControl);
      updateConditionFieldAvailability();
      updateConditionButtonState();
      clearConditionValidationError();
    });
    valueControl.addEventListener('input', clearConditionValidationError);
    valueControl.addEventListener('change', clearConditionValidationError);
    connectorSelect.addEventListener('change', clearConditionValidationError);
    var del = document.createElement('button');
    del.className = 'btn condition-delete';
    del.textContent = '✕';
    del.style.padding = '4px 8px';
    del.type = 'button';
    del.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      wrap.remove();
      refreshConditionConnectors();
      updateConditionFieldAvailability();
      updateConditionButtonState();
      clearConditionValidationError();
      try { syncSelectedFieldConditionsFromEditor(); } catch (err) {}
    });
    content.appendChild(fldSel);
    content.appendChild(opSel);
    content.appendChild(valueControl);
    content.appendChild(del);
    wrap.appendChild(content);
    return wrap;
  }

  function collectConditionsFromEditor() {
    if (!propConditionsList) return [];
    var proposed = [];
    var rows = propConditionsList.querySelectorAll('.condition-row');
    rows.forEach(function(row, index){
      var fieldSel = row.querySelector('.condition-field');
      var operatorSel = row.querySelector('.condition-operator');
      var valueInput = row.querySelector('.condition-value');
      var connectorSel = row.querySelector('.condition-connector-select');
      if (!fieldSel || !fieldSel.value) return;
      var operator = operatorSel ? operatorSel.value : 'is';
      var value = operator === 'is blank' ? '' : (valueInput ? (valueInput.value || '').trim() : '');
      var connector = connectorSel ? connectorSel.value : (index === 0 ? 'and' : 'and');
      proposed.push({ field: fieldSel.value, operator: operator, value: value, connector: connector });
    });
    return proposed;
  }

  var conditionLiveSyncTimer = null;
  function syncSelectedFieldConditionsFromEditor(options) {
    var shouldRender = !(options && options.render === false);
    if (!selectedFieldId || !fieldConfigContainer) return;
    var row = fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]');
    if (!row || !row._cfg || row._cfg.type !== 'field') return;

    var cfg = row._cfg;
    var toggleOn = isConditionToggleOn();
    cfg.conditionsEnabled = !!toggleOn;
    cfg.conditionAction = propConditionAction ? (propConditionAction.value || cfg.conditionAction || 'show') : (cfg.conditionAction || 'show');

    if (toggleOn) {
      var proposed = collectConditionsFromEditor();
      var shadowCfg = Object.assign({}, cfg);
      shadowCfg.conditions = proposed.slice();
      shadowCfg.conditionsEnabled = true;
      var allConfigs = snapshotConfigsWithOverride(cfg.id, shadowCfg);
      var err = validateConditionsForField(shadowCfg, proposed, allConfigs);
      if (err) {
        setConditionValidationError(err);
        return;
      }
      clearConditionValidationError();
      cfg.conditions = proposed;
    } else {
      clearConditionValidationError();
      cfg.conditions = [];
    }

    row._cfg = Object.assign({}, cfg);
    updateFieldConditionIndicator(row);
    updateRequiredHiddenWarningForRow(row);

    if (shouldRender) {
      if (conditionLiveSyncTimer) clearTimeout(conditionLiveSyncTimer);
      conditionLiveSyncTimer = setTimeout(function(){
        try { renderPreview(); } catch (e) {}
        scheduleHistorySnapshot();
      }, 80);
    }
  }

  function ensureHtmlOption(value) {
    if (!propHtml || !value) return;
    for (var i = 0; i < propHtml.options.length; i++) {
      if (propHtml.options[i].value === value) return;
    }
    var option = document.createElement('option');
    option.value = value;
    option.textContent = value;
    propHtml.appendChild(option);
    updateHtmlSelectOptions(selectedFieldId);
  }

  // selection / properties panel logic
  function selectFieldForProperties(id) {
    selectedFieldId = id;
    var row = fieldConfigContainer.querySelector('[data-id="' + id + '"]');
    // if not found, collapse/restore properties and exit
    if (!row) {
      if (propertiesForm) propertiesForm.style.display = 'none';
      restorePropertiesForm();
      return;
    }
    // move the existing properties form under the clicked row so it expands inline
    movePropertiesFormUnderRow(row);
    if (propertiesForm) propertiesForm.style.display = '';

    // read values from the stored cfg object on the row
    var cfg = row._cfg || {};
    var isStandardForHtml = (cfg.id && cfg.id.indexOf('custom_') !== 0 && cfg.type === 'field');
    var isTextBlock = cfg.type === 'text';
    setTimeout(function(){
      var target = (isTextBlock && propTextEditor) ? propTextEditor : propLabel;
      if (!target) return;
      try { target.focus({ preventScroll: true }); }
      catch (err) { var x=window.scrollX||window.pageXOffset, y=window.scrollY||window.pageYOffset; try{target.focus();}catch(e){} window.scrollTo(x,y); }
    }, 40);

    // toggle properties form sections based on field type (text block vs input field)
    if (propLabelWrapper) propLabelWrapper.style.display = isTextBlock ? 'none' : '';
    if (propRichEditorWrapper) propRichEditorWrapper.style.display = isTextBlock ? '' : 'none';
    if (fieldControls) fieldControls.style.display = isTextBlock ? 'none' : '';

    if (propHtmlLabel) propHtmlLabel.style.display = isTextBlock ? 'none' : '';
    var showReadonlyHtml = !isTextBlock && isStandardForHtml;
    if (propHtml) propHtml.style.display = (showReadonlyHtml || isTextBlock) ? 'none' : '';
    if (propHtmlReadOnly) propHtmlReadOnly.style.display = showReadonlyHtml ? '' : 'none';
    if (propPlaceholderLabel) propPlaceholderLabel.style.display = isTextBlock ? 'none' : '';
    if (propPlaceholder) propPlaceholder.style.display = isTextBlock ? 'none' : '';
    if (propHelpLabel) propHelpLabel.style.display = isTextBlock ? 'none' : '';
    if (propHelp) propHelp.style.display = isTextBlock ? 'none' : '';
    if (propTypeLabel) propTypeLabel.style.display = isTextBlock ? 'none' : '';
    if (propTypeReadOnly) propTypeReadOnly.style.display = 'none';
    if (propType) {
      if (isTextBlock) {
        propType.style.display = 'none';
        propType.disabled = false;
      }
    }
    if (propWidthLabel) propWidthLabel.style.display = isTextBlock ? 'none' : '';
    if (propWidth) propWidth.style.display = isTextBlock ? 'none' : '';
    if (propRequiredLabel) propRequiredLabel.style.display = isTextBlock ? 'none' : '';
    if (propRequired) propRequired.style.display = isTextBlock ? 'none' : '';
    if (propHiddenLabel) propHiddenLabel.style.display = isTextBlock ? 'none' : '';
    if (propHidden) propHidden.style.display = isTextBlock ? 'none' : '';
    if (propConditionsSection) propConditionsSection.style.display = isTextBlock ? 'none' : '';
    setConditionToggleAvailability(!isTextBlock);
    if (!isTextBlock) {
      var hasExplicitToggle = typeof cfg.conditionsEnabled === 'boolean';
      var desiredConditionState = hasExplicitToggle ? !!cfg.conditionsEnabled : ((cfg.conditions || []).length > 0);
      setConditionToggleState(desiredConditionState);
    }
    if (propOptionsWrapper) propOptionsWrapper.style.display = isTextBlock ? 'none' : propOptionsWrapper.style.display;

    // Values
    var textValue = cfg.text || '';
    propLabel.value = isTextBlock ? stripHtml(textValue) : (cfg.label || '');
    if (isTextBlock) {
      if (propFontSize) propFontSize.value = cfg.fontSize || 'body';
      var alignValue = cfg.align || 'left';
      setTextEditorAlignment(alignValue);
      if (propUrl) propUrl.value = cfg.url || '';
      if (propLinkTarget) propLinkTarget.value = cfg.target || '_blank';
      if (propTextEditor) propTextEditor.innerHTML = textValue || 'Text block';
      updateLinkStatus();
    } else {
      if (isStandardForHtml) {
        if (propHtmlReadOnly) propHtmlReadOnly.value = cfg.html || '';
        if (propHtml) {
          propHtml.value = cfg.html || '';
          propHtml.disabled = true;
        }
      } else {
        if (propHtmlReadOnly) propHtmlReadOnly.value = '';
        if (propHtml) {
          var htmlValue = cfg.html || '';
          if (htmlValue) ensureHtmlOption(htmlValue);
          propHtml.disabled = false;
          propHtml.value = htmlValue;
          updateHtmlSelectOptions(cfg.id);
        }
      }
      propPlaceholder.value = cfg.placeholder || '';
      propHelp.value = cfg.help || '';
      var currentFieldType = cfg.fieldType || (cfg.type === 'text' ? 'textarea' : 'text');
      if (isStandardForHtml) {
        if (propTypeReadOnly) {
          propTypeReadOnly.style.display = '';
          propTypeReadOnly.value = getFieldTypeLabel(currentFieldType);
        }
        if (propType) {
          propType.value = currentFieldType;
          propType.disabled = true;
          propType.style.display = 'none';
        }
      } else {
        if (propTypeReadOnly) {
          propTypeReadOnly.style.display = 'none';
        }
        if (propType) {
          propType.disabled = false;
          propType.style.display = '';
          propType.value = currentFieldType;
        }
      }
      propWidth.value = cfg.width || 'full';
      propRequired.checked = !!cfg.required;
    }
    var showValue = (typeof cfg.show === 'undefined') ? true : !!cfg.show;
    if (propHidden) propHidden.checked = !showValue;
    resetPropOptionsEditor();
    if (propConditionAction) propConditionAction.value = cfg.conditionAction || 'show';
    if (propConditionsList) {
      propConditionsList.innerHTML = '';
      clearConditionValidationError();
      if (!isTextBlock) {
        var conditionFieldOptions = getConditionFieldOptions();
        (cfg.conditions || []).forEach(function(c){
          var conditionRow = createConditionRow(c, conditionFieldOptions);
          propConditionsList.appendChild(conditionRow);
          initializeConditionRow(conditionRow, conditionFieldOptions);
        });
        refreshConditionConnectors();
        updateConditionFieldAvailability();
        updateConditionButtonState();
      } else {
        updateConditionButtonState([]);
      }
    }
    updateLinkStatus();

    // Step control visibility
    if (propStep) {
      var isWizardLayout = getSelectedLayout() === 'wizard';
      // Hide step for text blocks
      propStep.style.display = (isWizardLayout && !isTextBlock) ? '' : 'none';
      if (propStepLabel) propStepLabel.style.display = (isWizardLayout && !isTextBlock) ? '' : 'none';
      propStep.value = cfg.step || 1;
    }

    var optionsType = cfg.fieldType || (propType ? propType.value : 'text');
    var shouldShowOptions = !isTextBlock && isChoiceFieldType(optionsType);
    if (shouldShowOptions) {
      renderPropOptionsEditor(cfg);
    }

  }

  // apply properties back to row and refresh preview
  propApply.addEventListener('click', function(e){
    e.preventDefault();
    if (!selectedFieldId) return;
    var row = fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]');
    if (!row) return;

    var cfg = row._cfg || {};
    if (cfg.type === 'text') {
      cfg.text = propTextEditor ? propTextEditor.innerHTML : (propLabel.value || cfg.text || '');
      cfg.fontSize = propFontSize ? propFontSize.value : (cfg.fontSize || 'body');
      cfg.align = propAlign ? propAlign.value : (cfg.align || 'left');
      cfg.url = propUrl ? propUrl.value : (cfg.url || '');
      cfg.target = propLinkTarget ? propLinkTarget.value : (cfg.target || '_blank');
      cfg.show = (typeof cfg.show === 'undefined') ? true : !!cfg.show;
      if (propStep && getSelectedLayout() === 'wizard') cfg.step = parseInt(propStep.value, 10) || 1;
    } else {
      cfg.label = propLabel.value || cfg.label;
      // don't let standard fields change html
      var isStandard = (cfg.id && cfg.id.indexOf('custom_') !== 0 && cfg.type === 'field');
      if (!isStandard) {
        var proposedHtml = (propHtml ? (propHtml.value || '') : '').trim() || (cfg.html || '');
        if (proposedHtml) {
          var used = getUsedHtmlNames(selectedFieldId);
          if (used[proposedHtml]) {
            showRendererBanner('HTML name "' + proposedHtml + '" is already used by another field. Choose a different HTML name.');
            return;
          }
        }
        cfg.html = proposedHtml;
      }
      cfg.placeholder = propPlaceholder.value || '';
      cfg.help = propHelp.value || '';
      if (propType && !isStandard) {
        cfg.fieldType = propType.value || cfg.fieldType;
      }
      var effectiveFieldType = cfg.fieldType || (propType ? propType.value : 'text');
      if (isChoiceFieldType(effectiveFieldType)) {
        var optionValues = collectOptionValues();
        if (!optionValues.length) optionValues = ['Option 1', 'Option 2'];
        cfg.options = optionValues;
      } else {
        cfg.options = [];
      }
      cfg.width = propWidth.value || cfg.width || 'full';
      cfg.show = propHidden ? !propHidden.checked : true;
      cfg.required = propRequired.checked;
      var toggleOn = isConditionToggleOn();
      cfg.conditionAction = propConditionAction ? propConditionAction.value : (cfg.conditionAction || 'show');
      cfg.conditionsEnabled = toggleOn;
      var proposed = [];
      if (toggleOn && propConditionsList) {
        var condRows = propConditionsList.querySelectorAll('.condition-row');
        condRows.forEach(function(row, index){
          var fieldSel = row.querySelector('.condition-field');
          var operatorSel = row.querySelector('.condition-operator');
          var valueInput = row.querySelector('.condition-value');
          var connectorSel = row.querySelector('.condition-connector-select');
          if (!fieldSel || !fieldSel.value) return;
          var operator = operatorSel ? operatorSel.value : 'is';
          var value = operator === 'is blank' ? '' : (valueInput ? valueInput.value.trim() : '');
          var connector = connectorSel ? connectorSel.value : (index === 0 ? 'and' : 'and');
          proposed.push({ field: fieldSel.value, operator: operator, value: value, connector: connector });
        });
      }

      // Validate conditions (overlap rules + cycle prevention)
      if (toggleOn) {
        var shadowCfg = Object.assign({}, cfg);
        shadowCfg.conditions = proposed.slice();
        shadowCfg.conditionsEnabled = true;
        var allConfigs = snapshotConfigsWithOverride(cfg.id, shadowCfg);
        var err = validateConditionsForField(shadowCfg, proposed, allConfigs);
        if (err) {
          setConditionValidationError(err);
          return;
        }
      }
      clearConditionValidationError();
      cfg.conditions = toggleOn ? proposed : [];
      if (propStep && getSelectedLayout() === 'wizard') cfg.step = parseInt(propStep.value, 10) || 1;
    }
    row._cfg = Object.assign({}, cfg);
    updateFieldConditionIndicator(row);
    updateRequiredHiddenWarningForRow(row);

    // keep the field list label in sync with the edited text
    var rowLabel = row.querySelector('.field-row-label');
    if (rowLabel) {
      if (cfg.type === 'text') {
        var previewText = stripHtml(cfg.text || '').replace(/\s+/g, ' ').trim();
        rowLabel.textContent = (previewText || 'Text block').slice(0, 120);
      } else {
        rowLabel.textContent = (cfg.label || '').trim() || 'Untitled';
      }
    }

    // update inline label and html display in the row
    var labInput = row.querySelector('.label-input'); if (labInput) labInput.value = cfg.label;
    var htmlIn = row.querySelector('.html-name-input'); var htmlSel = row.querySelector('.html-name-select');
    if (htmlIn) htmlIn.value = cfg.html; else if (htmlSel) htmlSel.value = cfg.html;

    updateHtmlSelectOptions(selectedFieldId);
    renderPreview();
    pushHistory('edit');
    scheduleHistorySnapshot();
  });

  // Live-update the selected field row label as the author types.
  if (propLabel) {
    var propLabelPreviewTimer = null;
    propLabel.addEventListener('input', function(){
      if (!selectedFieldId || !fieldConfigContainer) return;
      var row = fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]');
      if (!row || !row._cfg || row._cfg.type !== 'field') return;
      var rowLabel = row.querySelector('.field-row-label');
      if (!rowLabel) return;
      var next = (propLabel.value || '').trim();
      rowLabel.textContent = next || 'Untitled';

      // Keep the underlying config in sync so the preview/form updates too.
      row._cfg.label = next;

      // Debounce preview rendering while typing.
      if (propLabelPreviewTimer) clearTimeout(propLabelPreviewTimer);
      propLabelPreviewTimer = setTimeout(function(){
        try { renderPreview(); } catch (e) {}
      }, 120);
    });
  }

  // Live-update the conditional action (Show/Hide) without requiring Apply.
  if (propConditionAction) {
    propConditionAction.addEventListener('change', function(){
      try { syncSelectedFieldConditionsFromEditor(); } catch (e) {}
    });
  }

  // Live-update required/hidden without requiring Apply.
  if (propHidden) {
    propHidden.addEventListener('change', function(){
      if (!selectedFieldId || !fieldConfigContainer) return;
      var row = fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]');
      if (!row || !row._cfg || row._cfg.type !== 'field') return;
      // propHidden checked means field is hidden.
      row._cfg.show = !propHidden.checked;
      row._cfg = Object.assign({}, row._cfg);
      updateRequiredHiddenWarningForRow(row);
      try { renderPreview(); } catch (e) {}
    });
  }
  if (propRequired) {
    propRequired.addEventListener('change', function(){
      if (!selectedFieldId || !fieldConfigContainer) return;
      var row = fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]');
      if (!row || !row._cfg || row._cfg.type !== 'field') return;
      row._cfg.required = !!propRequired.checked;
      row._cfg = Object.assign({}, row._cfg);
      updateRequiredHiddenWarningForRow(row);
      try { renderPreview(); } catch (e) {}
    });
  }

  // Live-update conditions as the author edits them.
  if (propConditionsList) {
    propConditionsList.addEventListener('change', function(){
      try { syncSelectedFieldConditionsFromEditor(); } catch (e) {}
    });
    propConditionsList.addEventListener('input', function(e){
      if (!e || !e.target || !e.target.classList) return;
      if (!(e.target.classList.contains('condition-value') || e.target.classList.contains('condition-operator'))) return;
      try { syncSelectedFieldConditionsFromEditor(); } catch (err) {}
    });
  }

  // Add condition action: create an empty row populated with current available fields
  propAddCondition.addEventListener('click', function(e){
    e.preventDefault();
    if (!propConditionsList || !isConditionToggleOn()) return;
    if (propConditionsList.children.length >= CONDITION_LIMIT) return;
    var availableFields = getConditionFieldOptions();
    if (!availableFields.length) return;
    var newRow = createConditionRow(null, availableFields);
    propConditionsList.appendChild(newRow);
    initializeConditionRow(newRow, availableFields);
    refreshConditionConnectors();
    updateConditionFieldAvailability();
    clearConditionValidationError();
    try { syncSelectedFieldConditionsFromEditor(); } catch (err) {}
  });

  if (propAddOption) {
    propAddOption.type = 'button';
    propAddOption.addEventListener('click', function(e){
      e.preventDefault();
      if (!propOptionsList) return;
      propOptionsList.appendChild(createOptionInputRow(''));
      if (propOptionsWrapper) propOptionsWrapper.style.display = '';
    });
  }

  if (propOptionsList) {
    propOptionsList.addEventListener('click', function(e){
      if (e.target.classList.contains('option-delete')) {
        e.preventDefault();
        var row = e.target.closest('.option-row');
        if (row) row.remove();
      }
    });
  }

  if (propType) {
    propType.addEventListener('change', function(){
      if (isChoiceFieldType(propType.value)) {
        var row = selectedFieldId ? fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]') : null;
        var cfg = row ? row._cfg : null;
        renderPropOptionsEditor(cfg || { options: collectOptionValues() });
      } else {
        resetPropOptionsEditor();
      }
    });
  }

  if (propConditionToggle) {
    propConditionToggle.addEventListener('click', function(){
      if (propConditionToggle.disabled) return;
      setConditionToggleState(!isConditionToggleOn());

      // Immediately reflect conditional status in the field list + preview.
      if (!selectedFieldId || !fieldConfigContainer) return;
      var row = fieldConfigContainer.querySelector('[data-id="' + selectedFieldId + '"]');
      if (!row || !row._cfg || row._cfg.type !== 'field') return;
      row._cfg.conditionsEnabled = isConditionToggleOn();
      updateFieldConditionIndicator(row);
      try { syncSelectedFieldConditionsFromEditor(); } catch (err) { renderPreview(); }
    });
  }

  var metaAddButtons = document.querySelectorAll('.meta-add-btn');
  metaAddButtons.forEach(function(btn){
    var key = btn.getAttribute('data-meta-key');
    btn.addEventListener('click', function(){ handleMetaAdd(key); });
  });
  FORM_META_KEYS.forEach(function(key){
    var input = metaInputs[key];
    if (!input) return;
    input.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        handleMetaAdd(key);
      }
    });
  });

  if (metaInputs && metaInputs.salesforceCampaignId) {
    metaInputs.salesforceCampaignId.addEventListener('input', function(){
      if (metaInputs.salesforceCampaignId.setCustomValidity) metaInputs.salesforceCampaignId.setCustomValidity('');
    });
  }

  // Hidden Metadata (request context + custom chips)
  function syncHiddenMetadataUiFromState() {
    if (captureUtmsToggle) captureUtmsToggle.checked = !!hiddenCaptureState.utms;
    if (captureReferrerToggle) captureReferrerToggle.checked = !!hiddenCaptureState.referrer;
    setRequestPreviewInputsEnabled(!!hiddenCaptureState.utms, !!hiddenCaptureState.referrer);
    syncCustomMetaValueUi();
    renderCustomHiddenMetadataGroups();
  }

  if (captureUtmsToggle) {
    captureUtmsToggle.addEventListener('change', function(){
      hiddenCaptureState.utms = !!captureUtmsToggle.checked;
      syncHiddenMetadataUiFromState();
      renderPreview();
      if (publishedState) refreshPublishTargets();
      scheduleHistorySnapshot();
    });
  }
  if (captureReferrerToggle) {
    captureReferrerToggle.addEventListener('change', function(){
      hiddenCaptureState.referrer = !!captureReferrerToggle.checked;
      syncHiddenMetadataUiFromState();
      renderPreview();
      if (publishedState) refreshPublishTargets();
      scheduleHistorySnapshot();
    });
  }

  if (customMetaSource) {
    customMetaSource.addEventListener('change', function(){
      syncCustomMetaValueUi();
    });
  }
  if (customMetaAddBtn) {
    customMetaAddBtn.addEventListener('click', function(){
      addCustomHiddenMetadataFromInputs();
      scheduleHistorySnapshot();
    });
  }
  if (customMetaKey) {
    customMetaKey.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        addCustomHiddenMetadataFromInputs();
        scheduleHistorySnapshot();
      }
    });
  }
  if (customMetaValue) {
    customMetaValue.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        addCustomHiddenMetadataFromInputs();
        scheduleHistorySnapshot();
      }
    });
  }
  if (customMetaLookupKey) {
    customMetaLookupKey.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        addCustomHiddenMetadataFromInputs();
        scheduleHistorySnapshot();
      }
    });
  }

  // Initialize hidden metadata UI
  syncHiddenMetadataUiFromState();

  // Page context override controls (UI only)
  function syncPageContextOverrideControls() {
    var buSrc = (ctxBuSource ? ctxBuSource.value : 'auto');
    if (ctxBuLookupKey) ctxBuLookupKey.style.display = buSrc === 'lookup' ? '' : 'none';

    var assetSrc = (ctxAssetSource ? ctxAssetSource.value : 'auto');
    if (ctxAssetLookupKey) ctxAssetLookupKey.style.display = assetSrc === 'lookup' ? '' : 'none';
    if (ctxAssetManual) ctxAssetManual.style.display = assetSrc === 'manual' ? '' : 'none';
  }
  if (ctxBuSource) ctxBuSource.addEventListener('change', syncPageContextOverrideControls);
  if (ctxAssetSource) ctxAssetSource.addEventListener('change', syncPageContextOverrideControls);
  if (ctxBuSource) ctxBuSource.addEventListener('change', scheduleHistorySnapshot);
  if (ctxAssetSource) ctxAssetSource.addEventListener('change', scheduleHistorySnapshot);
  syncPageContextOverrideControls();

  richEditorCommands.forEach(function(cmd){
    cmd.addEventListener('click', function(){
      var command = cmd.getAttribute('data-command');
      document.execCommand(command, false, null);
      if (propTextEditor) propTextEditor.focus();
    });
  });

  alignButtons.forEach(function(btn){
    btn.addEventListener('click', function(){
      var align = btn.getAttribute('data-align');
      setTextEditorAlignment(align);
      if (propTextEditor) propTextEditor.focus();
    });
  });

  setTextEditorAlignment((propAlign && propAlign.value) ? propAlign.value : 'left');

  if (propInsertLinkBtn) {
    propInsertLinkBtn.addEventListener('click', function(e){
      e.preventDefault();
      openLinkModal();
    });
  }
  if (linkModalClose) {
    linkModalClose.addEventListener('click', function(){ closeLinkModal(); });
  }
  if (linkModalCancel) {
    linkModalCancel.addEventListener('click', function(){ closeLinkModal(); });
  }
  if (linkModalSave) {
    linkModalSave.addEventListener('click', function(e){
      e.preventDefault();
      applyLinkFromModal();
    });
  }

  // click outside to clear selection
  document.addEventListener('click', function(e){
    // treat clicks inside the moved properties form as clicks inside the form
    if (!e.target.closest('.field-row') && !e.target.closest('#properties-form')) {
      selectedFieldId = null;
      var all = fieldConfigContainer.querySelectorAll('.field-row');
      all.forEach(function(r){ r.classList.remove('selected'); });
      if (propertiesForm) propertiesForm.style.display = 'none';
      // restore the properties-form back to its hidden container state
      restorePropertiesForm();
    }
  });

  // helper: move the shared properties form under the selected row (inline)
  function movePropertiesFormUnderRow(row) {
    if (!propertiesForm || !row) return;
    propertiesForm.classList.add('inline-properties');
    // ensure title is present when inline
    var title = propertiesForm.querySelector('.form-properties-title');
    if (!title) {
      var t = document.createElement('div');
      t.className = 'form-properties-title';
      t.textContent = 'Field properties';
      propertiesForm.insertBefore(t, propertiesForm.firstChild);
    }
    var next = row.nextSibling;
    // if already placed correctly, don't move
    if (propertiesForm.parentNode === fieldConfigContainer && propertiesForm.previousSibling === row) return;
    fieldConfigContainer.insertBefore(propertiesForm, next);
  }

  // helper: restore the properties form back into a neutral hidden state
  function restorePropertiesForm() {
    if (!propertiesForm) return;
    propertiesForm.classList.remove('inline-properties');
    propertiesForm.style.display = 'none';
  }

  function generateUniqueFieldId(baseId) {
    var base = baseId || ('field_' + Date.now());
    var candidate = base;
    var counter = 1;
    while (fieldConfigContainer.querySelector('[data-id="' + candidate + '"]')) {
      candidate = base + '_' + counter;
      counter++;
    }
    return candidate;
  }

  function openExistingFieldModal() {
    if (!existingFieldModal) return;
    renderExistingFieldList();
    existingFieldModal.style.display = 'flex';
    existingFieldModal.setAttribute('aria-hidden', 'false');
    setTimeout(function(){
      if (existingFieldModalClose) existingFieldModalClose.focus();
    }, 40);
  }

  function closeExistingFieldModal() {
    if (!existingFieldModal) return;
    existingFieldModal.style.display = 'none';
    existingFieldModal.setAttribute('aria-hidden', 'true');
  }

  function renderExistingFieldList() {
    if (!existingFieldList) return;
    existingFieldList.innerHTML = '';
    if (!Array.isArray(EXISTING_FIELD_LIBRARY) || !EXISTING_FIELD_LIBRARY.length) {
      var empty = document.createElement('p');
      empty.textContent = 'No saved fields available yet.';
      existingFieldList.appendChild(empty);
      return;
    }
    var groups = {};
    EXISTING_FIELD_LIBRARY.forEach(function(entry){
      var key = entry.group || 'Other';
      if (!groups[key]) groups[key] = [];
      groups[key].push(entry);
    });
    var usedNames = getUsedHtmlNames();
    Object.keys(groups).forEach(function(groupName){
      var groupWrap = document.createElement('div');
      groupWrap.className = 'existing-field-group';
      var heading = document.createElement('h5');
      var headingLabel = groupName && groupName.toLowerCase().indexOf('field') !== -1 ? groupName : groupName + ' fields';
      heading.textContent = headingLabel;
      groupWrap.appendChild(heading);
      var list = document.createElement('div');
      list.className = 'existing-field-list';
      groups[groupName].forEach(function(entry){
        var disabled = !!(entry.html && usedNames[entry.html]);
        var item = document.createElement('div');
        item.className = 'existing-field-item' + (disabled ? ' disabled' : '');
        var details = document.createElement('div');
        details.className = 'existing-field-item-details';
        var title = document.createElement('span');
        title.className = 'existing-field-item-title';
        title.textContent = entry.label || entry.id;
        var meta = document.createElement('span');
        meta.className = 'existing-field-item-meta';
        var htmlName = entry.html || 'unmapped';
        meta.textContent = getFieldTypeLabel(entry.fieldType) + ' • HTML: ' + htmlName;
        details.appendChild(title);
        details.appendChild(meta);
        item.appendChild(details);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-secondary';
        btn.textContent = disabled ? 'Added' : 'Add field';
        btn.disabled = disabled;
        if (!disabled) {
          btn.addEventListener('click', function(){ handleAddExistingField(entry); });
        }
        item.appendChild(btn);
        list.appendChild(item);
      });
      groupWrap.appendChild(list);
      existingFieldList.appendChild(groupWrap);
    });
  }

  function handleAddExistingField(entry) {
    if (!entry) return;
    if (entry.html) {
      var used = getUsedHtmlNames();
      if (used[entry.html]) {
        showRendererBanner('HTML name "' + entry.html + '" is already used in this form.');
        renderExistingFieldList();
        return;
      }
    }
    var clone = JSON.parse(JSON.stringify(entry));
    clone.type = 'field';
    clone.id = generateUniqueFieldId(clone.id || ('field_' + Date.now()));
    clone.show = true;
    clone.conditions = [];
    clone.conditionsEnabled = false;
    clone.step = clone.step || 1;
    clone.options = Array.isArray(clone.options) ? clone.options.slice() : [];
    buildFieldRow(clone);
    selectFieldForProperties(clone.id);
    renderPreview();
    renderExistingFieldList();
    closeExistingFieldModal();
    pushHistory('add-existing');
  }

  function setFieldPanelCollapsed(collapsed) {
    if (!fieldPanelBody || !fieldPanelToggle) return;
    var shouldCollapse = !!collapsed;
    fieldPanelBody.classList.toggle('collapsed', shouldCollapse);
    fieldPanelToggle.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
    fieldPanelToggle.textContent = shouldCollapse ? 'Expand' : 'Collapse';
  }

  function setFormLayoutPanelCollapsed(collapsed) {
    if (!formLayoutPanelBody || !formLayoutPanelToggle) return;
    var shouldCollapse = !!collapsed;
    formLayoutPanelBody.classList.toggle('collapsed', shouldCollapse);
    formLayoutPanelToggle.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
    formLayoutPanelToggle.textContent = shouldCollapse ? 'Expand' : 'Collapse';
  }

  function setFormDisplayPanelCollapsed(collapsed) {
    if (!formDisplayPanelBody || !formDisplayPanelToggle) return;
    var shouldCollapse = !!collapsed;
    formDisplayPanelBody.classList.toggle('collapsed', shouldCollapse);
    formDisplayPanelToggle.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
    formDisplayPanelToggle.textContent = shouldCollapse ? 'Expand' : 'Collapse';
  }

  function setLivePreviewCollapsed(collapsed) {
    if (!livePreviewBody || !livePreviewToggle) return;
    var shouldCollapse = !!collapsed;
    livePreviewBody.classList.toggle('collapsed', shouldCollapse);
    livePreviewToggle.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
    livePreviewToggle.textContent = shouldCollapse ? 'Expand' : 'Collapse';
  }

  function wireMetaPanelToggle(toggleId, bodyId) {
    var btn = document.getElementById(toggleId);
    var body = document.getElementById(bodyId);
    if (!btn || !body) return;
    function setCollapsed(collapsed) {
      var shouldCollapse = !!collapsed;
      body.classList.toggle('collapsed', shouldCollapse);
      btn.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
      btn.textContent = shouldCollapse ? 'Expand' : 'Collapse';
    }
    btn.addEventListener('click', function(){
      setCollapsed(!body.classList.contains('collapsed'));
    });
    setCollapsed(false);
  }

  function applyTemplateMetaDefaults(templateName) {
    var defaults = templateMetaDefaults[templateName] || {};
    FORM_META_KEYS.forEach(function(key){
      formMetaState[key] = defaults[key] || '';
      if (metaInputs[key]) metaInputs[key].value = '';
      renderMetaField(key);
    });
  }

  function renderMetaField(key) {
    var list = metaChipLists[key];
    if (!list) return;
    var fieldWrapper = document.querySelector('.form-meta-field[data-meta-field="' + key + '"]');
    var inputRow = fieldWrapper ? fieldWrapper.querySelector('.meta-input-row') : null;
    list.innerHTML = '';
    var value = formMetaState[key];
    if (!value) {
      if (inputRow) inputRow.classList.remove('meta-input-row-error');
      return;
    }
    if (inputRow) inputRow.classList.remove('meta-input-row-error');
    var chip = document.createElement('span');
    chip.className = 'meta-chip';
    var label = document.createElement('span');
    label.textContent = value;
    var remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'meta-chip-remove';
    remove.setAttribute('aria-label', 'Remove ' + key + ' value');
    remove.textContent = '✕';
    remove.addEventListener('click', function(){
      formMetaState[key] = '';
      renderMetaField(key);
      if (metaInputs[key]) metaInputs[key].focus();
      scheduleHistorySnapshot();
    });
    chip.appendChild(label);
    chip.appendChild(remove);
    list.appendChild(chip);
  }

  function handleMetaAdd(key) {
    var input = metaInputs[key];
    if (!input) return;
    var value = (input.value || '').trim();
    if (!value) return;

    if (key === 'salesforceCampaignId') {
      var isValid = /^[A-Za-z0-9]{18}$/.test(value);
      if (!isValid) {
        if (input.setCustomValidity) input.setCustomValidity('Salesforce Campaign ID must be exactly 18 letters/numbers.');
        if (input.reportValidity) input.reportValidity();
        return;
      }
      if (input.setCustomValidity) input.setCustomValidity('');
    }

    formMetaState[key] = value;
    input.value = '';
    renderMetaField(key);
    scheduleHistorySnapshot();
  }

  function getFieldTypeLabel(type) {
    var map = {
      text: 'Text',
      textarea: 'Textarea',
      dropdown: 'Dropdown',
      checkbox: 'Checkbox',
      number: 'Number',
      multiselect: 'Multi-select',
      radio: 'Radio',
      date: 'Date',
      time: 'Time',
      datetime: 'Date & time',
      email: 'Email',
      consent: 'Consent'
    };
    var lower = (type || '').toLowerCase();
    return map[lower] || (type ? type.charAt(0).toUpperCase() + type.slice(1) : 'Text');
  }

  function setTextEditorAlignment(value) {
    var align = value || 'left';
    if (propAlign) propAlign.value = align;
    alignButtons.forEach(function(btn){
      btn.classList.toggle('active', btn.dataset.align === align);
    });
    if (propTextEditor) propTextEditor.style.textAlign = align;
  }

  function stripHtml(value) {
    var tmp = document.createElement('div');
    tmp.innerHTML = value || '';
    return tmp.textContent || tmp.innerText || '';
  }

  function escapeHtml(value) {
    return (value || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function saveSelectionRange() {
    var sel = window.getSelection && window.getSelection();
    if (sel && sel.rangeCount) savedRange = sel.getRangeAt(0).cloneRange();
    else savedRange = null;
  }

  function restoreSelectionRange() {
    if (!savedRange) return;
    var sel = window.getSelection && window.getSelection();
    if (sel) {
      sel.removeAllRanges();
      sel.addRange(savedRange);
    }
  }

  function getAnchorForSelection() {
    if (!propTextEditor) return null;
    var sel = window.getSelection && window.getSelection();
    if (!sel || !sel.anchorNode) return null;
    var node = sel.anchorNode;
    while (node && node !== propTextEditor) {
      if (node.nodeType === 1 && node.tagName === 'A') return node;
      node = node.parentNode;
    }
    return null;
  }

  function updateLinkStatus() {
    if (!propLinkStatus) return;
    if (!propUrl || !propUrl.value) {
      propLinkStatus.textContent = 'No link inserted';
      return;
    }
    var anchor = propTextEditor ? propTextEditor.querySelector('a') : null;
    var label = anchor && anchor.textContent ? anchor.textContent.trim() : 'Link set';
    propLinkStatus.textContent = label + ' • ' + propUrl.value;
  }

  function openLinkModal() {
    if (!linkModal || !propTextEditor) return;
    var anchor = getAnchorForSelection();
    var url = anchor ? anchor.getAttribute('href') : (propUrl ? propUrl.value : '');
    var text = anchor ? anchor.textContent.trim() : (window.getSelection ? window.getSelection().toString().trim() : '');
    var action = anchor ? (anchor.target === '_blank' ? 'new' : 'current') : ((propLinkTarget && propLinkTarget.value === '_blank') ? 'new' : 'current');
    if (linkModalUrl) linkModalUrl.value = url;
    if (linkModalText) linkModalText.value = text;
    if (linkModalAction) linkModalAction.value = action;
    saveSelectionRange();
    linkModal.style.display = 'flex';
    if (linkModalUrl) linkModalUrl.focus();
  }

  function closeLinkModal() {
    if (!linkModal) return;
    linkModal.style.display = 'none';
    savedRange = null;
  }

  function applyLinkFromModal() {
    if (!linkModal || !linkModalUrl || !propTextEditor) return;
    var url = linkModalUrl.value.trim();
    if (!url) return;
    var text = (linkModalText && linkModalText.value.trim()) || url;
    var action = linkModalAction ? linkModalAction.value : 'new';
    var target = action === 'current' ? '_self' : '_blank';
    restoreSelectionRange();
    var html = '<a href="' + escapeHtml(url) + '" target="' + target + '"' + (target === '_blank' ? ' rel="noopener noreferrer"' : '') + '>' + escapeHtml(text) + '</a>';
    document.execCommand('insertHTML', false, html);
    if (propUrl) propUrl.value = url;
    if (propLinkTarget) propLinkTarget.value = target;
    updateLinkStatus();
    closeLinkModal();
    if (propTextEditor) propTextEditor.focus();
  }

  function setAllTabSectionsCollapsed(tabId, collapsed) {
    var tab = document.getElementById(tabId);
    if (!tab) return;
    var toggles = Array.from(tab.querySelectorAll('.panel-toggle[aria-controls]'));
    toggles.forEach(function(btn){
      var bodyId = btn.getAttribute('aria-controls');
      if (!bodyId) return;
      var body = document.getElementById(bodyId);
      if (!body) return;
      var isCollapsed = body.classList.contains('collapsed');
      if (collapsed && !isCollapsed) btn.click();
      if (!collapsed && isCollapsed) btn.click();
    });
  }

  function getTabSectionState(tabId) {
    var tab = document.getElementById(tabId);
    if (!tab) return { any: false, anyExpanded: false };
    var toggles = Array.from(tab.querySelectorAll('.panel-toggle[aria-controls]'));
    if (!toggles.length) return { any: false, anyExpanded: false };
    var anyExpanded = false;
    toggles.forEach(function(btn){
      var bodyId = btn.getAttribute('aria-controls');
      var body = bodyId ? document.getElementById(bodyId) : null;
      if (body && !body.classList.contains('collapsed')) anyExpanded = true;
    });
    return { any: true, anyExpanded: anyExpanded };
  }

  function syncToggleAllButton(tabId, buttonEl) {
    if (!buttonEl) return;
    var state = getTabSectionState(tabId);
    if (!state.any) {
      buttonEl.style.display = 'none';
      return;
    }
    buttonEl.style.display = '';
    buttonEl.textContent = state.anyExpanded ? 'Collapse all' : 'Expand all';
  }

  function wireToggleAll(tabId, buttonEl) {
    if (!buttonEl) return;
    buttonEl.addEventListener('click', function(e){
      e.preventDefault();
      var state = getTabSectionState(tabId);
      // If anything is expanded, collapse everything; otherwise expand everything.
      setAllTabSectionsCollapsed(tabId, state.anyExpanded);
      syncToggleAllButton(tabId, buttonEl);
    });

    // Keep label in sync when individual sections are toggled.
    var tab = document.getElementById(tabId);
    if (tab) {
      Array.from(tab.querySelectorAll('.panel-toggle[aria-controls]')).forEach(function(btn){
        btn.addEventListener('click', function(){
          setTimeout(function(){ syncToggleAllButton(tabId, buttonEl); }, 0);
        });
      });
    }

    syncToggleAllButton(tabId, buttonEl);
  }


  // Event wiring
  if (addExistingFieldBtn) {
    addExistingFieldBtn.addEventListener('click', function(e){
      e.preventDefault();
      openExistingFieldModal();
    });
  }

  var undoBtn = document.getElementById('renderer-undo');
  var redoBtn = document.getElementById('renderer-redo');
  if (undoBtn) {
    undoBtn.addEventListener('click', function(e){ e.preventDefault(); undo(); });
  }
  if (redoBtn) {
    redoBtn.addEventListener('click', function(e){ e.preventDefault(); redo(); });
  }

  if (fieldConfigContainer) {
    fieldConfigContainer.addEventListener('click', function(e){
      var deleteBtn = e.target.closest('.field-row-delete');
      if (deleteBtn) {
        e.preventDefault();
        var row = deleteBtn.closest('.field-row');
        deleteFieldRow(row);
      }
    });
  }

  if (existingFieldModalClose) {
    existingFieldModalClose.addEventListener('click', function(e){
      e.preventDefault();
      closeExistingFieldModal();
    });
  }

  if (existingFieldModal) {
    existingFieldModal.addEventListener('click', function(e){
      if (e.target === existingFieldModal) {
        closeExistingFieldModal();
      }
    });
  }

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && existingFieldModal && existingFieldModal.getAttribute('aria-hidden') === 'false') {
      closeExistingFieldModal();
    }
  });

  if (automationChooseAssetBtn) {
    automationChooseAssetBtn.addEventListener('click', function(e){
      e.preventDefault();
      openAssetModal();
    });
  }

  if (assetModalClose) {
    assetModalClose.addEventListener('click', function(e){
      e.preventDefault();
      closeAssetModal();
    });
  }

  if (assetModal) {
    assetModal.addEventListener('click', function(e){
      if (e.target === assetModal) closeAssetModal();
    });
  }

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && assetModal && assetModal.getAttribute('aria-hidden') === 'false') {
      closeAssetModal();
    }
  });

  [automationEnabled, automationAsset, automationSubject, automationEmailBody].forEach(function(el){
    if (!el) return;
    var ev = el.tagName === 'INPUT' && el.type === 'checkbox' ? 'change' : 'input';
    el.addEventListener(ev, function(){
      syncAutomationStateFromInputs();
      setAutomationStatus('');
    });
  });

  if (previewSubmitBtn) {
    previewSubmitBtn.addEventListener('click', function(e){
      e.preventDefault();
      maybeRunAutomation('preview');
    });
  }
  if (previewBackBtn) {
    previewBackBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (getSelectedLayout() !== 'wizard') return;
      currentStep = Math.max(1, (currentStep || 1) - 1);
      renderPreview();
    });
  }
  if (previewNextBtn) {
    previewNextBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (getSelectedLayout() !== 'wizard') return;
      var maxSteps = parseInt(numStepsSelect && numStepsSelect.value, 10) || 3;
      maxSteps = Math.max(1, Math.min(10, maxSteps || 3));
      if ((currentStep || 1) >= maxSteps) {
        if (previewSubmitBtn) previewSubmitBtn.click();
        return;
      }
      currentStep = Math.min(maxSteps, (currentStep || 1) + 1);
      renderPreview();
    });
  }
  if (inlineSubmitBtn) {
    inlineSubmitBtn.addEventListener('click', function(e){
      e.preventDefault();
      maybeRunAutomation('inline');
    });
  }
  if (inlineBackBtn) {
    inlineBackBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (!publishedState || publishedState.layout !== 'wizard') return;
      inlineWizardStep = Math.max(1, (inlineWizardStep || 1) - 1);
      renderInlineForm();
    });
  }
  if (inlineNextBtn) {
    inlineNextBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (!publishedState || publishedState.layout !== 'wizard') return;
      var maxSteps = publishedState.maxSteps || 3;
      maxSteps = Math.max(1, Math.min(10, maxSteps || 3));
      if ((inlineWizardStep || 1) >= maxSteps) {
        if (inlineSubmitBtn) inlineSubmitBtn.click();
        return;
      }
      inlineWizardStep = Math.min(maxSteps, (inlineWizardStep || 1) + 1);
      renderInlineForm();
    });
  }
  if (publishedSubmitBtn) {
    publishedSubmitBtn.addEventListener('click', function(e){
      e.preventDefault();
      maybeRunAutomation('modal');
    });
  }
  if (publishedBackBtn) {
    publishedBackBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (!publishedState || publishedState.layout !== 'wizard') return;
      publishedWizardStep = Math.max(1, (publishedWizardStep || 1) - 1);
      renderModalForm();
    });
  }
  if (publishedNextBtn) {
    publishedNextBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (!publishedState || publishedState.layout !== 'wizard') return;
      var maxSteps = publishedState.maxSteps || 3;
      maxSteps = Math.max(1, Math.min(10, maxSteps || 3));
      if ((publishedWizardStep || 1) >= maxSteps) {
        if (publishedSubmitBtn) publishedSubmitBtn.click();
        return;
      }
      publishedWizardStep = Math.min(maxSteps, (publishedWizardStep || 1) + 1);
      renderModalForm();
    });
  }

  Object.keys(formDisplayInputs).forEach(function(key){
    var input = formDisplayInputs[key];
    if (!input) return;
    var eventType = input.tagName === 'SELECT' ? 'change' : 'input';
    input.addEventListener(eventType, function(){
      renderPreview();
      scheduleHistorySnapshot();
    });
  });

  if (designColumnSelect) {
    designColumnSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designBackgroundSelect) {
    designBackgroundSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }

  if (designThemeSelect) {
    designThemeSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designContainerStyleSelect) {
    designContainerStyleSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designEmphasisSelect) {
    designEmphasisSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designButtonStyleSelect) {
    designButtonStyleSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designButtonShapeSelect) {
    designButtonShapeSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designButtonWidthSelect) {
    designButtonWidthSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designInputStyleSelect) {
    designInputStyleSelect.addEventListener('change', function(){
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designInputRadiusSelect) {
    designInputRadiusSelect.addEventListener('change', function(){
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designTypeScaleSelect) {
    designTypeScaleSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designHeadingWeightSelect) {
    designHeadingWeightSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }
  if (designMotionSelect) {
    designMotionSelect.addEventListener('change', function(){
      applyDesignSelections();
      renderPreview();
      if (publishedState) { syncPublishedDesignStateFromControls(); refreshPublishTargets(); }
      scheduleHistorySnapshot();
    });
  }

  wireDesignPanelToggle(designThemeToggle, designThemeBody);
  wireDesignPanelToggle(designBackgroundToggle, designBackgroundBody);
  wireDesignPanelToggle(designEmphasisToggle, designEmphasisBody);
  wireDesignPanelToggle(designButtonsToggle, designButtonsBody);
  wireDesignPanelToggle(designInputsToggle, designInputsBody);
  wireDesignPanelToggle(designTypographyToggle, designTypographyBody);
  wireDesignPanelToggle(designMotionToggle, designMotionBody);

  refreshBtn.addEventListener('click', function(){ renderPreview(); scheduleHistorySnapshot(); });
  addFieldBtn.addEventListener('click', function(e){ e.preventDefault(); addCustomField(); scheduleHistorySnapshot(); });
  addTextBtn.addEventListener('click', function(e){ e.preventDefault(); addTextBlock(); scheduleHistorySnapshot(); });
  templateSelect.addEventListener('change', function () {
    loadTemplate(templateSelect.value);
    applyTemplateMetaDefaults(templateSelect.value);
    updateStepVisibility();
    currentStep = 1;
    renderPreview();
    pushHistory('template-change');
  });
  if (densitySelect) {
    densitySelect.addEventListener('change', function(){ renderPreview(); scheduleHistorySnapshot(); });
  }
  if (layoutSelect) {
    layoutSelect.addEventListener('change', function(){
      if (getSelectedLayout() !== 'wizard') currentStep = 1;
      updateStepVisibility();
      renderPreview();
      scheduleHistorySnapshot();
    });
  }
  numStepsSelect.addEventListener('change', function(){
    var maxSteps = parseInt(numStepsSelect.value, 10) || 3;
    if (currentStep > maxSteps) currentStep = maxSteps;
    renderPreview();
    scheduleHistorySnapshot();
  });

  if (formDisplayPanelToggle) {
    formDisplayPanelToggle.addEventListener('click', function(){
      var collapsed = formDisplayPanelBody && formDisplayPanelBody.classList.contains('collapsed');
      setFormDisplayPanelCollapsed(!collapsed);
    });
    setFormDisplayPanelCollapsed(false);
  }

  if (formLayoutPanelToggle) {
    formLayoutPanelToggle.addEventListener('click', function(){
      var collapsed = formLayoutPanelBody && formLayoutPanelBody.classList.contains('collapsed');
      setFormLayoutPanelCollapsed(!collapsed);
    });
    setFormLayoutPanelCollapsed(false);
  }

  if (wizardValidateSelect) {
    wizardValidateSelect.addEventListener('change', function(){ renderPreview(); scheduleHistorySnapshot(); });
  }
  if (wizardNavigationSelect) {
    wizardNavigationSelect.addEventListener('change', function(){ renderPreview(); scheduleHistorySnapshot(); });
  }

  if (livePreviewToggle) {
    livePreviewToggle.addEventListener('click', function(){
      var collapsed = livePreviewBody && livePreviewBody.classList.contains('collapsed');
      setLivePreviewCollapsed(!collapsed);
    });
    setLivePreviewCollapsed(false);
  }

  if (fieldPanelToggle) {
    fieldPanelToggle.addEventListener('click', function(){
      var currentlyCollapsed = fieldPanelBody && fieldPanelBody.classList.contains('collapsed');
      setFieldPanelCollapsed(!currentlyCollapsed);
    });
    setFieldPanelCollapsed(false);
  }

  wireToggleAll('tab-form', formToggleAllBtn);
  wireToggleAll('tab-properties', propertiesToggleAllBtn);
  wireToggleAll('tab-design', designToggleAllBtn);

  wireMetaPanelToggle('exp-measure-toggle', 'exp-measure-body');
  wireMetaPanelToggle('page-context-toggle', 'page-context-body');
  wireMetaPanelToggle('routing-toggle', 'routing-body');
  wireMetaPanelToggle('automation-toggle', 'automation-panel-body');
  wireMetaPanelToggle('hidden-metadata-toggle', 'hidden-metadata-body');
  wireMetaPanelToggle('a11y-toggle', 'a11y-body');
  wireMetaPanelToggle('hooks-toggle', 'hooks-body');

  // update prop-step visibility whenever layout changes
  function updatePropertyStepVisibility() {
    if (propStep) {
      var isWizardLayout = getSelectedLayout() === 'wizard';
      propStep.style.display = isWizardLayout ? '' : 'none';
      if (propStepLabel) propStepLabel.style.display = isWizardLayout ? '' : 'none';
    }
  }
  if (layoutSelect) {
    layoutSelect.addEventListener('change', updatePropertyStepVisibility);
  }
  // initial call
  updatePropertyStepVisibility();

  // adapt layout based on dialog container width (works regardless of viewport)
  function adaptLayoutToDialogWidth() {
    var dialogEl = document.querySelector('.dialog');
    var grid = document.querySelector('.layout-grid');
    if (!dialogEl || !grid) return;
    var w = dialogEl.clientWidth || dialogEl.offsetWidth || 0;
    if (w <= 590) grid.classList.add('narrow'); else grid.classList.remove('narrow');
  }
  window.addEventListener('resize', adaptLayoutToDialogWidth);
  // ensure layout adapts when template changes (content width can change)
  templateSelect.addEventListener('change', adaptLayoutToDialogWidth);
  // initial call before first render
  adaptLayoutToDialogWidth();

  // Initial load
  // CTA → Form Renderer bridge registration (prototype of AEM clientlib behavior).
  (function(){
    var bridge = window.ExpFormBridge;
    if (!bridge || typeof bridge.register !== 'function') return;

    var root = document.querySelector('[data-form-renderer-id="lead-form"]');
    if (!root) return;

    bridge.register('lead-form', {
      open: function(mode, options){
        var opts = options || {};
        var resolved = (mode || '').trim() || (root.dataset ? root.dataset.formDefaultOpenMode : '') || 'scroll';

        function ensurePublishedStateForCtaModal() {
          if (publishedState) return;
          var displayState = (typeof getFormDisplayState === 'function') ? getFormDisplayState() : null;
          var formInstanceUuid = (typeof generateUuidV4 === 'function') ? generateUuidV4() : '';
          publishedState = {
            // For CTA-triggered modal, capture mode is effectively modal.
            capture: 'modal',
            config: (typeof getConfigFromUI === 'function') ? getConfigFromUI() : [],
            density: densitySelect ? densitySelect.value : 'density-standard',
            layout: layoutSelect ? layoutSelect.value : 'single',
            maxSteps: parseInt(numStepsSelect && numStepsSelect.value, 10) || 3,
            layoutSettings: {
              validate: wizardValidateSelect ? (wizardValidateSelect.value || 'per-field') : 'per-field',
              navigation: wizardNavigationSelect ? (wizardNavigationSelect.value || 'stepper') : 'stepper'
            },
            designLayout: designColumnSelect ? designColumnSelect.value : 'full-width',
            designBackground: designBackgroundSelect ? designBackgroundSelect.value : 'default',
            designTheme: designThemeSelect ? (designThemeSelect.value || 'light') : 'light',
            designContainerStyle: designContainerStyleSelect ? (designContainerStyleSelect.value || 'elevated') : 'elevated',
            designEmphasis: designEmphasisSelect ? (designEmphasisSelect.value || 'neutral') : 'neutral',
            designMotion: designMotionSelect ? (designMotionSelect.value || 'subtle') : 'subtle',
            designTypography: {
              typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : 'default',
              headingWeight: designHeadingWeightSelect ? (designHeadingWeightSelect.value || 'regular') : 'regular'
            },
            designVisual: {
              buttonStyle: designButtonStyleSelect ? (designButtonStyleSelect.value || 'solid') : 'solid',
              buttonShape: designButtonShapeSelect ? (designButtonShapeSelect.value || 'rounded') : 'rounded',
              buttonWidth: designButtonWidthSelect ? (designButtonWidthSelect.value || 'default') : 'default',
              inputStyle: designInputStyleSelect ? (designInputStyleSelect.value || 'outlined') : 'outlined',
              inputRadius: designInputRadiusSelect ? (designInputRadiusSelect.value || 'standard') : 'standard',
              typeScale: designTypeScaleSelect ? (designTypeScaleSelect.value || 'default') : 'default'
            },
            display: displayState,
            routing: (typeof formMetaState !== 'undefined') ? Object.assign({}, formMetaState) : {},
            hiddenMetadata: (typeof getAllHiddenMetadataItems === 'function' ? (getAllHiddenMetadataItems() || []) : []).map(function(it){
              return {
                context: it.context || 'marketing',
                key: it.key || '',
                value: it.value || '',
                source: it.source || 'manual',
                lookupKey: it.lookupKey || ''
              };
            }).filter(function(it){
              if (!it || !(it.key || '').trim()) return false;
              if ((it.source || 'manual') === 'manual') return !!(it.value || '').trim();
              return !!(it.lookupKey || '').trim();
            }),
            accessibility: (typeof getAccessibilityState === 'function') ? getAccessibilityState() : {},
            experimentation: (typeof getExperimentationHooksState === 'function') ? getExperimentationHooksState(formInstanceUuid) : {}
          };

          if (publishedState.layout === 'wizard' && typeof ensureWizardUiState === 'function') {
            ensureWizardUiState(publishedState.maxSteps);
            if (typeof normalizeWizardUi === 'function') {
              publishedState.wizardUi = normalizeWizardUi(null, publishedState.maxSteps);
            }
          }
          publishedWizardStep = 1;
        }

        // Expose for the shared bridge default API to use.
        try {
          if (!window.ExpEnsurePublishedStateForCtaModal) {
            window.ExpEnsurePublishedStateForCtaModal = ensurePublishedStateForCtaModal;
          }
        } catch (e) {}

        // Modal open: render modal view of the published form when available; fallback to scroll.
        if (resolved === 'modal') {
          ensurePublishedStateForCtaModal();
          if (typeof renderModalForm === 'function' && typeof setPublishedModalOpen === 'function' && publishedState) {
            renderModalForm();
            setPublishedModalOpen(true);
            return;
          }
          resolved = 'scroll';
        }

        if (resolved === 'scroll') {
          // Prefer the live embedded form target when available.
          var scrollTarget = root;
          if (publishedState && publishedState.capture === 'inline' && inlineWrap && !inlineWrap.hidden) {
            scrollTarget = inlineWrap;
          } else if (siteFormPanel && !siteFormPanel.hidden) {
            scrollTarget = siteFormPanel;
          }

          scrollToElementTop(scrollTarget, 'smooth');

          if (opts && opts.expand && typeof this.expand === 'function') this.expand();
          if (opts && opts.focus && typeof this.focusFirstField === 'function') {
            var self = this;
            setTimeout(function(){
              try { self.focusFirstField(); } catch (e) {}
              // Some browsers scroll on focus; re-anchor the viewport to the component top.
              scrollToElementTop(scrollTarget, 'auto');
            }, 240);
          }
        }
      },
      expand: function(){
        if (siteFormPanel && siteFormPanel.hidden) siteFormPanel.hidden = false;
      },
      focusFirstField: function(){
        // Try embedded preview first (most likely to contain fields).
        var searchRoot = (publishedState && publishedState.capture === 'inline' && inlinePreview) ? inlinePreview : root;
        var first = searchRoot.querySelector('input:not([type=hidden]):not([disabled]), select:not([disabled]), textarea:not([disabled])');
        if (first && typeof first.focus === 'function') {
          try { first.focus({ preventScroll: true }); } catch (e) { first.focus(); }
        }
        // Fire a lightweight "start" hook when we programmatically focus the first field.
        try {
          var last = (typeof bridge.getLastOpen === 'function') ? bridge.getLastOpen('lead-form') : null;
          document.dispatchEvent(new CustomEvent('exp:formStart', { detail: {
            formRendererId: 'lead-form',
            mode: last ? last.mode : 'scroll',
            ctaId: last ? last.ctaId : ''
          }}));
        } catch (err) {}
      }
    });

    function wireSubmit(btn, kind){
      if (!btn || !btn.addEventListener) return;
      btn.addEventListener('click', function(){
        try {
          var last = (typeof bridge.getLastOpen === 'function') ? bridge.getLastOpen('lead-form') : null;
          document.dispatchEvent(new CustomEvent('exp:formSubmit', { detail: {
            formRendererId: 'lead-form',
            mode: last ? last.mode : (kind || ''),
            ctaId: last ? last.ctaId : ''
          }}));
        } catch (e) {}
      });
    }

    wireSubmit(inlineSubmitBtn, 'scroll');
    wireSubmit(publishedSubmitBtn, 'modal');
    wireSubmit(previewSubmitBtn, 'preview');
  })();

  initializeFormDisplayDefaults();
  applyDesignSelections();
  loadTemplate(templateSelect.value);
  applyTemplateMetaDefaults(templateSelect.value);
  updateStepVisibility();
  applyTemplateMetaDefaults(templateSelect.value);
  renderPreview();
  pushHistory('init');
  updateUndoRedoButtons();
</script>
</body>
</html>
